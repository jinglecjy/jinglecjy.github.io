<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="前端"><title>赶鸭子上架的全栈开发踩坑思考 | Winnie Cai's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">赶鸭子上架的全栈开发踩坑思考</h1><a id="logo" href="/.">Winnie Cai's Blog</a><p class="description">生气了，一顿饭哄不好的那种。恩，要两顿。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">赶鸭子上架的全栈开发踩坑思考</h1><div class="post-meta">Jun 27, 2019<span> | </span><span class="category"><a href="/categories/复盘/">复盘</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目概述"><span class="toc-number">1.</span> <span class="toc-text">项目概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前端"><span class="toc-number">2.</span> <span class="toc-text">前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-关于在前台页面处理数据"><span class="toc-number">2.1.</span> <span class="toc-text">1. 关于在前台页面处理数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-关于vue-router的使用"><span class="toc-number">2.2.</span> <span class="toc-text">2. 关于vue-router的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-关于vuex的使用"><span class="toc-number">2.3.</span> <span class="toc-text">3. 关于vuex的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-多复用操作的实现：Vue-directive指令"><span class="toc-number">2.4.</span> <span class="toc-text">4. 多复用操作的实现：Vue.directive指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodejs后端"><span class="toc-number">3.</span> <span class="toc-text">nodejs后端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-关于框架选择的思考"><span class="toc-number">3.1.</span> <span class="toc-text">0. 关于框架选择的思考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-post大数据超时"><span class="toc-number">3.2.</span> <span class="toc-text">1. post大数据超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-涉及文件云存储"><span class="toc-number">3.3.</span> <span class="toc-text">2. 涉及文件云存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-CORS问题"><span class="toc-number">3.4.</span> <span class="toc-text">3. CORS问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-关于Docker"><span class="toc-number">3.5.</span> <span class="toc-text">4. 关于Docker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库"><span class="toc-number">4.</span> <span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-纯SQL语句与ORM库"><span class="toc-number">4.1.</span> <span class="toc-text">1. 纯SQL语句与ORM库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-数据库结构设计领悟"><span class="toc-number">4.2.</span> <span class="toc-text">2. 数据库结构设计领悟</span></a></li></ol></li></ol></div></div><div class="post-content"><p>完全赶鸭子上架的全栈开发之旅，过程可以说是很崩溃，做完回顾发现留坑过多，痛定思痛还是要重新整理一下代码结构，复盘整个项目搞清楚到底菜在哪里，下面是此次开发过程中的一些具体问题的总结。   </p>
<h2 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h2><p>项目名称：数据分析平台<br>项目描述：对活动会场数据进行分析，提供模块化的结论   </p>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><blockquote>
<p>框架选用：vue+vuex+vue-router<br>UI框架：element-ui</p>
</blockquote>
<h3 id="1-关于在前台页面处理数据"><a href="#1-关于在前台页面处理数据" class="headerlink" title="1. 关于在前台页面处理数据"></a>1. 关于在前台页面处理数据</h3><p><strong>初步考虑</strong>：一开始采用的方案是前台处理excel数据然后post数据到后台存储，主要考量有二，一是去除上传文件这一步骤，简化实现；二是前台对数据表格式进行校验，如果有错误可直接返回，减少不必要的带宽消耗。通过webworker也可以避免浏览器假死。<br><strong>实际问题</strong>：低估了数据量级，实际拿到的excel表甚至超过了10MB，部分sheet甚至达到了百万条数据，浏览器的处理能力和内存有限，出现了<code>out of memory</code>错误。<br><strong>解决方案</strong>：将这一步骤移交给后台处理     </p>
<h3 id="2-关于vue-router的使用"><a href="#2-关于vue-router的使用" class="headerlink" title="2. 关于vue-router的使用"></a>2. 关于vue-router的使用</h3><p><strong>初步考虑</strong>：PC站点不可避免的有站内导航和跳转，另一方面为了提升体验，页面缓存也是需要的，综上考虑引入了vue-router。    </p>
<ul>
<li><p><strong>实际问题01</strong>：贪图方便全员<code>keepAlive</code>了，导致页面缓存多了卡顿，懒惰是原罪<br><strong>解决方案</strong>：去除不必要的keepAlive      </p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router配置</span></span><br><span class="line">&#123; </span><br><span class="line">    path: <span class="string">'/upload'</span>,</span><br><span class="line">    name: <span class="string">'upload'</span>,</span><br><span class="line">    component: DataUpload,</span><br><span class="line">    meta: &#123;</span><br><span class="line">        keepAlive: <span class="literal">true</span> <span class="comment">// 需要被缓存</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    path: <span class="string">'/export'</span>,</span><br><span class="line">    name: <span class="string">'export'</span>,</span><br><span class="line">    component: ReportExport,</span><br><span class="line">    meta: &#123;</span><br><span class="line">        keepAlive: <span class="literal">false</span> <span class="comment">// 不需要被缓存</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入页面</span></span><br><span class="line">&lt;keep-alive&gt;</span><br><span class="line">    &lt;router-view v-<span class="keyword">if</span>=<span class="string">"$route.meta.keepAlive"</span> /&gt;</span><br><span class="line">&lt;<span class="regexp">/keep-alive&gt;</span></span><br><span class="line"><span class="regexp">&lt;router-view v-if="!$route.meta.keepAlive"/</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>实际问题02</strong>：需要新开页面展示某些信息<br><strong>解决方案</strong>：由于信息量级小，所以最终通过url带参的方式实现，router页面跳转   </p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新开页面</span></span><br><span class="line">router.resolve(&#123;</span><br><span class="line">    name: <span class="string">"show-report-only"</span>,</span><br><span class="line">    query: &#123;</span><br><span class="line">        url: url,</span><br><span class="line">        name: name </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">window</span>.open(href, <span class="string">'_blank'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一种带参跳转（不能新开页面）</span></span><br><span class="line">router.push(&#123; <span class="attr">name</span>: <span class="string">'user'</span>, <span class="attr">params</span>: &#123; <span class="attr">userId</span>: <span class="string">'123'</span> &#125;&#125;) <span class="comment">// 参数存储在内存中，不在url显示</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-关于vuex的使用"><a href="#3-关于vuex的使用" class="headerlink" title="3. 关于vuex的使用"></a>3. 关于vuex的使用</h3><p><strong>初步考虑</strong>：前期考虑不足，典型的我坑我自己。现在就是后悔，非常后悔。<br><strong>实际问题</strong>：vuex是在项目进行到一定程度之后才加进去的，整个项目组件之间存在很多的共享信息，包括基础分析数据/页面状态等，当代码量级上去之后，简单的组件之间传值已经无法维持数据共享，而且组件之间的依赖过强，代码可读性严重下降。<br><strong>解决方案</strong>：加入vuex来留存全局的状态信息。   </p>
<h3 id="4-多复用操作的实现：Vue-directive指令"><a href="#4-多复用操作的实现：Vue-directive指令" class="headerlink" title="4. 多复用操作的实现：Vue.directive指令"></a>4. 多复用操作的实现：Vue.directive指令</h3><p><strong>实际问题</strong>：在实际的实现场景下，有一些功能是基本所有组件都会使用到的，比如说都存在一个按钮，点击之后需要进行一系列类似的操作，这个时候就需要自定义指令上场，避免成为ctrlC/ctrlV工程师。<br><strong>解决方案</strong>：加入自定义指令，统一管理类似的功能，提升可复用性，降低后期修改成本。   </p>
<h2 id="nodejs后端"><a href="#nodejs后端" class="headerlink" title="nodejs后端"></a>nodejs后端</h2><blockquote>
<p>框架选用：express<br>代理服务器：nginx   </p>
<h3 id="0-关于框架选择的思考"><a href="#0-关于框架选择的思考" class="headerlink" title="0. 关于框架选择的思考"></a>0. 关于框架选择的思考</h3><p>在做这个项目之前没有正儿八经的用nodejs做后台开发，倒是之前在校期间，用过java和PHP，大概的思路是有的。基于这个前提下，还是保守的选用全家桶型框架express，使用之后感觉确实挺全的，但是有许多功能在实际使用中并不需要，后续考虑迁移到koa瘦个身。   </p>
</blockquote>
<h3 id="1-post大数据超时"><a href="#1-post大数据超时" class="headerlink" title="1. post大数据超时"></a>1. post大数据超时</h3><p><strong>实际问题</strong>：后端最“重”的一个功能就是存数据，正如前端存excel表数据遇到的问题，将excel表上传到后端处理也有类似的问题，数据量过大，处理完成之后还要将几百万条数据存进数据库，容易造成超时，502/504错误。<br><strong>解决方案</strong>：首选优化sql语句，加速处理；目前的快速解决方法是将express的socket连接超时时间。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">socket</span>) </span>&#123;</span><br><span class="line">    socket.setTimeout(<span class="number">30</span> * <span class="number">1000</span>);  <span class="comment">// 超时时间，此处为30s</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p><strong>后续优化</strong>：将接口拆分为2个接口异步操作，一个用于执行处理数据，另一个接口用于获取处理进度。   </p>
<h3 id="2-涉及文件云存储"><a href="#2-涉及文件云存储" class="headerlink" title="2. 涉及文件云存储"></a>2. 涉及文件云存储</h3><p><strong>前期疏漏</strong>：前期很理所当然的将文件存储在了服务器本地，实际上对于需要长期存储的数据应当有专门的文件服务器来存储，后端逻辑与存储空间应当隔离。<br><strong>解决方案</strong>：使用公司内部的oss存储，该接口必须线上调用，本地调用可能失败或响应时间过长。   </p>
<h3 id="3-CORS问题"><a href="#3-CORS问题" class="headerlink" title="3. CORS问题"></a>3. CORS问题</h3><p><strong>实际问题</strong>：对于附带身份凭证的请求，服务器端设置<code>Access-Control-Allow-Origin</code>为<code>*</code>无效<br><strong>解决方案</strong>：<code>res.header(&#39;Access-Control-Allow-Origin&#39;, req.header(&#39;origin&#39;));</code>   </p>
<h3 id="4-关于Docker"><a href="#4-关于Docker" class="headerlink" title="4. 关于Docker"></a>4. 关于Docker</h3><p>作为一个菜鸟完全不知道docker是什么东西怎么用，此次部署是傻瓜式操作，完全是大佬写好的配置文件，直接走平台部署。不懂就要学，先简单的入个门，后续输出一些学习内容出来。<br>目前只是了解了一下<code>Docker</code>是什么，拿来做什么。<code>Docker</code>类似于虚拟机的概念，只是<code>Docker</code>虚拟的是操作系统，它将同一个操作系统上管理的应用隔离开来，可以快速的创建和停止应用，不同应用之间互不影响。   </p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><blockquote>
<p>mysql</p>
<h3 id="1-纯SQL语句与ORM库"><a href="#1-纯SQL语句与ORM库" class="headerlink" title="1. 纯SQL语句与ORM库"></a>1. 纯SQL语句与ORM库</h3><p><strong>实际问题</strong>：我肯定是脑子瓦特了，才会手写SQL，是框架不够好用还是加班不够久。<br><strong>后续改进</strong>：为了后续项目能够更好兼容推进，改用ORM库来重构代码。   </p>
</blockquote>
<h3 id="2-数据库结构设计领悟"><a href="#2-数据库结构设计领悟" class="headerlink" title="2. 数据库结构设计领悟"></a>2. 数据库结构设计领悟</h3><p>数据库真的是一门走一步要看三步的活计，前期设计作死在后面都是要还的。这一次设计过程中，又由于需求频繁变动，导致数据库修改避无可避，产生了一些非专业的感悟：   </p>
<ul>
<li>慎用自增ID，尤其是对于需要更新的数据，对于一些无法用单一字段作为<code>primary key</code>的表，可以考虑多个字段通过md5之类的加密算法，生成唯一的ID作为<code>primary key</code>。   </li>
<li>在前期需求不明朗，或者说项目最开始设计的时候，字段最好不要做过多的限制，比如说枚举类型，可以用tinyint来替代，后续如果有增减也不需要修改。   </li>
<li>前期慎重使用<code>unique</code>或<code>foreign key</code>之类的限制性功能，后期需求谁也说不准，很容易翻车。另外如外键之类的功能也降低了数据添加的可控性。      </li>
<li>避免或尽量减少对一些较为特殊的内置字段类型/内置方法的使用，比如mysql的enum类型可以用varchar类型代替，timestamp类型可以用bigint存储时间戳代替，主要是考虑后续可能需要对多种数据库进行兼容。   </li>
</ul>
</div><div class="tags"><a href="/tags/数据分析工具项目/">数据分析工具项目</a><a href="/tags/项目复盘/">项目复盘</a></div><div class="post-nav"><a class="pre" href="/2019/08/05/记录第一次typescript重构后端/">记录第一次typescript重构后端</a><a class="next" href="/2019/06/25/phaser2-&gt;3：来个打地鼠试水/">phaser2-&gt;3：来个打地鼠试水</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/notes/">notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue组件/">vue组件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/周报/">周报</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/复盘/">复盘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/深入学习/">深入学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/threejs/" style="font-size: 15px;">threejs</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/sass/" style="font-size: 15px;">sass</a> <a href="/tags/compass/" style="font-size: 15px;">compass</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/phaser/" style="font-size: 15px;">phaser</a> <a href="/tags/小项目/" style="font-size: 15px;">小项目</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/组件沉淀/" style="font-size: 15px;">组件沉淀</a> <a href="/tags/竞品分析/" style="font-size: 15px;">竞品分析</a> <a href="/tags/周报/" style="font-size: 15px;">周报</a> <a href="/tags/概念/" style="font-size: 15px;">概念</a> <a href="/tags/性能优化/" style="font-size: 15px;">性能优化</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a> <a href="/tags/数据分析工具项目/" style="font-size: 15px;">数据分析工具项目</a> <a href="/tags/项目复盘/" style="font-size: 15px;">项目复盘</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/记录/" style="font-size: 15px;">记录</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/14/618前端竞品分析研究（互动篇）/">618前端竞品分析研究（互动篇）</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/06/事件循环：宏任务和微任务/">事件循环：宏任务和微任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/26/函数劫持/">函数劫持</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/06/初识AI之设计稿楼层识别/">初识AI之设计稿楼层识别</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/23/Vue组件库之Popup弹窗组件/">vue组件库之popup弹窗组件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/19/算法应用之自定义公式计算/">算法应用之自定义公式计算</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/05/记录之MAC环境下一次重新安装nvm和nrm/">记录之MAC环境下一次重新安装nvm和nrm</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/05/记录第一次typescript重构后端/">记录第一次typescript重构后端</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/27/赶鸭子上架的全栈开发踩坑思考/">赶鸭子上架的全栈开发踩坑思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/25/phaser2->3：来个打地鼠试水/">phaser2->3：来个打地鼠试水</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Winnie Cai's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>