<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>函数劫持</title>
      <link href="/2020/02/26/%E5%87%BD%E6%95%B0%E5%8A%AB%E6%8C%81/"/>
      <url>/2020/02/26/%E5%87%BD%E6%95%B0%E5%8A%AB%E6%8C%81/</url>
      
        <content type="html"><![CDATA[<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>今天接触到了一个陌生的名词：函数劫持，查了一些资料记录一下。<br>函数劫持的意思是在一个函数运行之前把它劫持下来，添加我们想要的功能，然后再调用原来的函数执行。这也是常见的钩子函数的原理之一。<br>举一个简单的例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _alert = alert;</span><br><span class="line"><span class="built_in">window</span>.alert = <span class="function"><span class="keyword">function</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'alert:'</span>, s);</span><br><span class="line">    _alert(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="二、应用"><a href="#二、应用" class="headerlink" title="二、应用"></a>二、应用</h2><ol><li><p>XSS攻击经常使用<code>alert</code>测试是否存在跨站，所以可以通过劫持<code>alert</code>函数来监测是否有人在攻击你的网站。在监测的页面劫持<code>alert</code>函数，记录调用情况。   </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">report</span>(<span class="params">caller</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> img=<span class="keyword">new</span> Image();</span><br><span class="line">    img.src=<span class="string">`http://www.site.com/getReport.php?caller=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(caller)&#125;</span>`</span>;   </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> _alert = <span class="built_in">window</span>.alert</span><br><span class="line"><span class="built_in">window</span>.alert = <span class="function"><span class="keyword">function</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    report(alert.caller)</span><br><span class="line">    _alert(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>自定义业务功能。业务代码经常会有新需求的加入，对原代码进行修改匹配，常常比较耗费时间，这个时候就可以使用函数劫持，在不修改原业务逻辑的前提下，增加新功能。     </p></li></ol><h2 id="三、反劫持"><a href="#三、反劫持" class="headerlink" title="三、反劫持"></a>三、反劫持</h2><ol><li><p><strong>判断某个函数是否被劫持？</strong>    </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;<span class="built_in">console</span>.log(foo);&#125;</span><br><span class="line">alert.toString()  <span class="comment">// "function alert() &#123; [native code] &#125;"</span></span><br><span class="line">foo.toString()    <span class="comment">// "function foo() &#123;console.log(foo);&#125;"</span></span><br></pre></td></tr></table></figure><p>对于native代码内置函数如<code>alert</code>，输出打印时会显示为<code>[native code]</code>，而自定义的函数会显示函数定义的内容，通过这个方法可以检查函数是否被劫持。<br>注意到有一种伪装成native function的方式如下：        </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fakeAlert = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;).bind(<span class="literal">null</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">window</span>.alert.toString()); <span class="comment">// function alert() &#123; [native code] &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(fakeAlert.toString()); <span class="comment">// function () &#123; [native code] &#125;</span></span><br></pre></td></tr></table></figure><p><code>bind(null)</code>伪装后的函数不带函数名，所以更严格的检查需要检查函数名是否为空。   </p></li><li><p><strong>如何反劫持？</strong><br>通常劫持的都是一些可以向用户反馈信息的API，如<code>alert</code>、<code>eval</code>、<code>console.log</code>等。这些native代码通常难以还原，所以可以通过还原出一个纯净的环境<code>iframe</code>，在<code>iframe</code>中调用相关函数。    </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createIframe</span>(<span class="params">w</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> d = w.document;</span><br><span class="line">    <span class="keyword">var</span> newIframe = d.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">    newIframe.style.width = <span class="number">0</span>;</span><br><span class="line">    newIframe.style.height = <span class="number">0</span>;</span><br><span class="line">    d.body.appendChild(newIframe);</span><br><span class="line">    newIframe.contentWindow.document.write(<span class="string">"&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;"</span>);</span><br><span class="line">    <span class="keyword">return</span> newIframe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">injectScriptIntoIframe</span>(<span class="params">f, proc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> d = f.contentWindow.document;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="string">"&lt;script&gt;\n("</span> + proc.toString() + <span class="string">")();\n&lt;/script&gt;"</span>;</span><br><span class="line">    d.write(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于涉及到反馈信息的API可以封装到函数中，调用方法在iframe中执行：    </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将信息相关封装到函数中，在iframe中调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">payload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// your code goes here</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> f = createIframe(top);</span><br><span class="line">injectScriptIntoIframe(f, payload);</span><br></pre></td></tr></table></figure></li></ol><h2 id="四、参考"><a href="#四、参考" class="headerlink" title="四、参考"></a>四、参考</h2><p><a href="https://www.cnblogs.com/darr/p/4760798.html" target="_blank" rel="noopener">[1] 函数劫持</a><br><a href="https://juejin.im/post/5c24cfd8f265da6144201c0a" target="_blank" rel="noopener">[2] 谈谈JS中的函数劫持</a>   </p>]]></content>
      
      
      <categories>
          
          <category> 深入学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 概念 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初识AI之设计稿楼层识别</title>
      <link href="/2020/02/06/%E5%88%9D%E8%AF%86AI%E4%B9%8B%E8%AE%BE%E8%AE%A1%E7%A8%BF%E6%A5%BC%E5%B1%82%E8%AF%86%E5%88%AB/"/>
      <url>/2020/02/06/%E5%88%9D%E8%AF%86AI%E4%B9%8B%E8%AE%BE%E8%AE%A1%E7%A8%BF%E6%A5%BC%E5%B1%82%E8%AF%86%E5%88%AB/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文不包含底层数学基础，目标是利用已有算法和模型实现需求。</p></blockquote><h2 id="业务背景"><a href="#业务背景" class="headerlink" title="业务背景"></a>业务背景</h2><p>从长设计稿上识别多个楼层进行分割，得出分割区域坐标。<br>本文使用的深度学习工具为<code>TensorFlow</code>。主要通过改造官方例子，来训练自己的模型并测试效果，其中模型训练部分通过<strong>python</strong>实现，效果测试由前端页面展示。<br>项目地址：<a href="https://github.com/winniecjy/floorDetection" target="_blank" rel="noopener">https://github.com/winniecjy/floorDetection</a><br>demo地址：<a href="https://winniecjy.github.io/floorDetection/" target="_blank" rel="noopener">https://winniecjy.github.io/floorDetection/</a><br>最终效果如下：<br><img src="https://img11.360buyimg.com/imagetools/jfs/t1/109913/23/5556/116384/5e3b9264E1d3573b2/daa93409cdfe3a38.jpg" alt="效果图">   </p><h2 id="制作数据集"><a href="#制作数据集" class="headerlink" title="制作数据集"></a>制作数据集</h2><p>这里使用labelImg来标注检测目标，MacOS下的安装步骤如下，其他系统可参考<a href="https://github.com/tzutalin/labelImg：" target="_blank" rel="noopener">https://github.com/tzutalin/labelImg：</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pyqt5 lxml # Install qt and lxml by pip</span><br><span class="line"></span><br><span class="line">git clone https://github.com/tzutalin/labelImg.git</span><br><span class="line">cd labelImg</span><br><span class="line">make qt5py3</span><br><span class="line">python labelImg.py</span><br><span class="line">python labelImg.py [IMAGE_PATH] [PRE-DEFINED CLASS FILE]</span><br></pre></td></tr></table></figure></p><p><img src="https://img10.360buyimg.com/imagetools/jfs/t1/91139/3/11302/676536/5e31741eE18cc7f5f/9f034107bfe78735.jpg" alt="labelimg"><br>这里在花瓣网上找了100多张会场设计图来进行处理。将图片一分为二，一部分作为训练集，一部分作为测试集，训练集和测试集比例为2:1，分别放在两个文件夹train和test中。标记完成后，每个图片都得到一个对应的xml文件描述了对应的区域标注。            </p><h2 id="数据集处理"><a href="#数据集处理" class="headerlink" title="数据集处理"></a>数据集处理</h2><h3 id="xml合并为csv"><a href="#xml合并为csv" class="headerlink" title="xml合并为csv"></a>xml合并为csv</h3><p>把所有的xml合并到csv文件，把以下代码复制到一个python文件中，需要修改两处位置：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">需要修改两个位置</span></span><br><span class="line"><span class="string">fileDir: 为xml文件所在的目录</span></span><br><span class="line"><span class="string">outputName：为csv文件的输出名称</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line">fileDir = <span class="string">'output/train'</span> <span class="comment"># xml文件夹地址</span></span><br><span class="line">outputName = <span class="string">'train.csv'</span> <span class="comment"># 生成csv文件地址</span></span><br><span class="line">os.chdir(fileDir)</span><br><span class="line">path = fileDir</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xml_to_csv</span><span class="params">(path)</span>:</span></span><br><span class="line">    xml_list = []</span><br><span class="line">    <span class="keyword">for</span> xml_file <span class="keyword">in</span> glob.glob(<span class="string">'*.xml'</span>):</span><br><span class="line">        tree = ET.parse(xml_file)</span><br><span class="line">        root = tree.getroot()</span><br><span class="line">        <span class="keyword">for</span> member <span class="keyword">in</span> root.findall(<span class="string">'object'</span>):</span><br><span class="line">            value = (root.find(<span class="string">'filename'</span>).text,</span><br><span class="line">                     int(root.find(<span class="string">'size'</span>)[<span class="number">0</span>].text),</span><br><span class="line">                     int(root.find(<span class="string">'size'</span>)[<span class="number">1</span>].text),</span><br><span class="line">                     member[<span class="number">0</span>].text,</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">0</span>].text),</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">1</span>].text),</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">2</span>].text),</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">3</span>].text)</span><br><span class="line">                     )</span><br><span class="line">            print(<span class="string">'value: '</span>, value)</span><br><span class="line">            xml_list.append(value)</span><br><span class="line">    column_name = [<span class="string">'filename'</span>, <span class="string">'width'</span>, <span class="string">'height'</span>, <span class="string">'class'</span>, <span class="string">'xmin'</span>, <span class="string">'ymin'</span>, <span class="string">'xmax'</span>, <span class="string">'ymax'</span>]</span><br><span class="line">    xml_df = pd.DataFrame(xml_list, columns=column_name)</span><br><span class="line">    <span class="keyword">return</span> xml_df</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    image_path = path</span><br><span class="line">    xml_df = xml_to_csv(image_path)</span><br><span class="line">    xml_df.to_csv(outputName, index=<span class="keyword">None</span>)</span><br><span class="line">    print(<span class="string">'Successfully converted xml to csv.'</span>)</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p><p><img src="https://img12.360buyimg.com/imagetools/jfs/t1/85204/40/11269/350026/5e31741aE11cb3d2a/c20da86272de1a2c.jpg" alt="csv">    </p><h3 id="csv转换为TFRcords-Format"><a href="#csv转换为TFRcords-Format" class="headerlink" title="csv转换为TFRcords Format"></a>csv转换为TFRcords Format</h3><p>由于使用到的<code>TensorFlow Object Detection API</code>数据输入格式为<code>TFRcords Format</code>，所以还需要进行一次csv格式转换。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">  使用:</span></span><br><span class="line"><span class="string">  # csv_input为输入的csv文件目录，output_path为输出的文件目录</span></span><br><span class="line"><span class="string">  python csv2record.py --csv_input=data/train.csv --output_path=data/train.record</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  需要修改两个位置（标记为修改处）：</span></span><br><span class="line"><span class="string">  #1. 'images/train'为图片所在目录</span></span><br><span class="line"><span class="string">  path = os.path.join(os.getcwd(), 'images/train')</span></span><br><span class="line"><span class="string">  #2. 对应的标签返回一个整数，后面需要使用</span></span><br><span class="line"><span class="string">  def class_text_to_int(row_label):</span></span><br><span class="line"><span class="string">    if row_label == 'floors':</span></span><br><span class="line"><span class="string">        return 1</span></span><br><span class="line"><span class="string">    elif row_label == 'toutu':</span></span><br><span class="line"><span class="string">        return 2</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        None</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> dataset_util</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple, OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到脚本所在目录</span></span><br><span class="line"><span class="comment"># py_dir = '/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(os.getcwd())</span></span><br><span class="line"><span class="comment"># os.chdir(py_dir)</span></span><br><span class="line"><span class="comment"># print(os.getcwd())</span></span><br><span class="line"></span><br><span class="line">flags = tf.app.flags</span><br><span class="line">flags.DEFINE_string(<span class="string">'csv_input'</span>, <span class="string">''</span>, <span class="string">'Path to the CSV input'</span>)</span><br><span class="line">flags.DEFINE_string(<span class="string">'output_path'</span>, <span class="string">''</span>, <span class="string">'Path to output TFRecord'</span>)</span><br><span class="line">FLAGS = flags.FLAGS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改处：标签数字对应</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">class_text_to_int</span><span class="params">(row_label)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> row_label == <span class="string">'floors'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> row_label == <span class="string">'toutu'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">csv按照图片名分组；</span></span><br><span class="line"><span class="string">将同一图片名中多个标记区域分为一组；</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split</span><span class="params">(df, group)</span>:</span></span><br><span class="line">    data = namedtuple(<span class="string">'data'</span>, [<span class="string">'filename'</span>, <span class="string">'object'</span>]) <span class="comment"># data有两个属性，filename和object</span></span><br><span class="line">    gb = df.groupby(group) <span class="comment"># 按照'filename'对data中的数据进行分组</span></span><br><span class="line">    <span class="comment"># data(filename, gb.get_group(x))存放每个图片名、该图片的相关信息</span></span><br><span class="line">    <span class="keyword">return</span> [data(filename, gb.get_group(x)) <span class="keyword">for</span> filename, x <span class="keyword">in</span> zip(gb.groups.keys(), gb.groups)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_tf_example</span><span class="params">(group, path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> tf.gfile.GFile(os.path.join(path, <span class="string">'&#123;&#125;'</span>.format(group.filename)), <span class="string">'rb'</span>) <span class="keyword">as</span> fid: <span class="comment"># rb指定二进制形式读取图片</span></span><br><span class="line">        encoded_jpg = fid.read()</span><br><span class="line">    encoded_jpg_io = io.BytesIO(encoded_jpg)</span><br><span class="line">    image = Image.open(encoded_jpg_io)</span><br><span class="line">    width, height = image.size</span><br><span class="line"></span><br><span class="line">    filename = group.filename.encode(<span class="string">'utf8'</span>)</span><br><span class="line">    image_format = <span class="string">b'jpg'</span></span><br><span class="line">    xmins = []</span><br><span class="line">    xmaxs = []</span><br><span class="line">    ymins = []</span><br><span class="line">    ymaxs = []</span><br><span class="line">    classes_text = []</span><br><span class="line">    classes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index, row <span class="keyword">in</span> group.object.iterrows():</span><br><span class="line">        xmins.append(row[<span class="string">'xmin'</span>] / width)</span><br><span class="line">        xmaxs.append(row[<span class="string">'xmax'</span>] / width)</span><br><span class="line">        ymins.append(row[<span class="string">'ymin'</span>] / height)</span><br><span class="line">        ymaxs.append(row[<span class="string">'ymax'</span>] / height)</span><br><span class="line">        classes_text.append(row[<span class="string">'class'</span>].encode(<span class="string">'utf8'</span>))</span><br><span class="line">        classes.append(class_text_to_int(row[<span class="string">'class'</span>]))</span><br><span class="line"></span><br><span class="line">    tf_example = tf.train.Example(features=tf.train.Features(feature=&#123;</span><br><span class="line">        <span class="string">'image/height'</span>: dataset_util.int64_feature(height),</span><br><span class="line">        <span class="string">'image/width'</span>: dataset_util.int64_feature(width),</span><br><span class="line">        <span class="string">'image/filename'</span>: dataset_util.bytes_feature(filename),</span><br><span class="line">        <span class="string">'image/source_id'</span>: dataset_util.bytes_feature(filename),</span><br><span class="line">        <span class="string">'image/encoded'</span>: dataset_util.bytes_feature(encoded_jpg),</span><br><span class="line">        <span class="string">'image/format'</span>: dataset_util.bytes_feature(image_format),</span><br><span class="line">        <span class="string">'image/object/bbox/xmin'</span>: dataset_util.float_list_feature(xmins),</span><br><span class="line">        <span class="string">'image/object/bbox/xmax'</span>: dataset_util.float_list_feature(xmaxs),</span><br><span class="line">        <span class="string">'image/object/bbox/ymin'</span>: dataset_util.float_list_feature(ymins),</span><br><span class="line">        <span class="string">'image/object/bbox/ymax'</span>: dataset_util.float_list_feature(ymaxs),</span><br><span class="line">        <span class="string">'image/object/class/text'</span>: dataset_util.bytes_list_feature(classes_text),</span><br><span class="line">        <span class="string">'image/object/class/label'</span>: dataset_util.int64_list_feature(classes),</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">return</span> tf_example</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></span><br><span class="line">    writer = tf.io.TFRecordWriter(FLAGS.output_path)</span><br><span class="line">    path = os.path.join(os.getcwd(), <span class="string">'images-test'</span>) <span class="comment"># 修改处</span></span><br><span class="line">    examples = pd.read_csv(FLAGS.csv_input)</span><br><span class="line">    grouped = split(examples, <span class="string">'filename'</span>)</span><br><span class="line">    <span class="keyword">for</span> group <span class="keyword">in</span> grouped:</span><br><span class="line">        tf_example = create_tf_example(group, path)</span><br><span class="line">        writer.write(tf_example.SerializeToString())</span><br><span class="line"></span><br><span class="line">    writer.close()</span><br><span class="line">    output_path = os.path.join(os.getcwd(), FLAGS.output_path)</span><br><span class="line">    print(<span class="string">'Successfully created the TFRecords: &#123;&#125;'</span>.format(output_path))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tf.compat.v1.app.run()</span><br></pre></td></tr></table></figure></p><h2 id="模型选取"><a href="#模型选取" class="headerlink" title="模型选取"></a>模型选取</h2><p>tensorflow/models仓库提供了丰富的TensorFlow模型，目标检测API位于目录tensorflow/models/research/object_detection/models，本文选取的是<code>ssd_mobilenet_v1_coco</code>模型，更多的模型描述可以参照<a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/detection_model_zoo.md" target="_blank" rel="noopener">model zoo</a>，需要对其中的<code>*.config</code>文件进行修改：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSD with Mobilenet v1 configuration for MSCOCO Dataset.</span></span><br><span class="line"><span class="comment"># Users should configure the fine_tune_checkpoint field in the train config as</span></span><br><span class="line"><span class="comment"># well as the label_map_path and input_path fields in the train_input_reader and</span></span><br><span class="line"><span class="comment"># eval_input_reader. Search for "PATH_TO_BE_CONFIGURED" to find the fields that</span></span><br><span class="line"><span class="comment"># should be configured.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">修改位置已标记为：修改处</span></span><br><span class="line"><span class="string">1. ssd &#123;</span></span><br><span class="line"><span class="string">  num_classes: 2</span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">num_classes为标签类别数，此次训练有头图和楼层两个类型，所以为2</span></span><br><span class="line"><span class="string">2. train_config: &#123;</span></span><br><span class="line"><span class="string">  batch_size: 1</span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">batch_size是每次迭代的数据数，这里设为1</span></span><br><span class="line"><span class="string">3. train_input_reader: &#123;</span></span><br><span class="line"><span class="string">  tf_record_input_reader &#123;</span></span><br><span class="line"><span class="string">    input_path: "output/train.record"</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  label_map_path: "output/floors.pbtxt"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">input_path是训练数据的路径，label_map_path是label路径都需要改为对应的路径</span></span><br><span class="line"><span class="string">4. eval_input_reader: &#123;</span></span><br><span class="line"><span class="string">  tf_record_input_reader &#123;</span></span><br><span class="line"><span class="string">    input_path: "output/test.record"</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  label_map_path: "output/floors.pbtxt"</span></span><br><span class="line"><span class="string">  shuffle: false</span></span><br><span class="line"><span class="string">  num_readers: 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">input_path是测试数据的路径，label_map_path是label路径都需要改为对应的路径</span></span><br><span class="line"><span class="string">5.fine_tune_checkpoint: "training/model.ckpt"</span></span><br><span class="line"><span class="string">  from_detection_checkpoint: true</span></span><br><span class="line"><span class="string">由于是从头开始训练，不使用预训练的模型数据，所以这两行注释，如果是对预训练模型参数来进行微调，则该参数为模型位置</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">model &#123;</span><br><span class="line">  ssd &#123;</span><br><span class="line">    num_classes: <span class="number">2</span> <span class="comment"># 修改处：标签类别数</span></span><br><span class="line">    box_coder &#123;</span><br><span class="line">      faster_rcnn_box_coder &#123;</span><br><span class="line">        y_scale: <span class="number">10.0</span></span><br><span class="line">        x_scale: <span class="number">10.0</span></span><br><span class="line">        height_scale: <span class="number">5.0</span></span><br><span class="line">        width_scale: <span class="number">5.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    matcher &#123;</span><br><span class="line">      argmax_matcher &#123;</span><br><span class="line">        matched_threshold: <span class="number">0.5</span></span><br><span class="line">        unmatched_threshold: <span class="number">0.5</span></span><br><span class="line">        ignore_thresholds: false</span><br><span class="line">        negatives_lower_than_unmatched: true</span><br><span class="line">        force_match_for_each_row: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    similarity_calculator &#123;</span><br><span class="line">      iou_similarity &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    anchor_generator &#123;</span><br><span class="line">      ssd_anchor_generator &#123;</span><br><span class="line">        num_layers: <span class="number">6</span></span><br><span class="line">        min_scale: <span class="number">0.2</span></span><br><span class="line">        max_scale: <span class="number">0.95</span></span><br><span class="line">        aspect_ratios: <span class="number">1.0</span></span><br><span class="line">        aspect_ratios: <span class="number">2.0</span></span><br><span class="line">        aspect_ratios: <span class="number">0.5</span></span><br><span class="line">        aspect_ratios: <span class="number">3.0</span></span><br><span class="line">        aspect_ratios: <span class="number">0.3333</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    image_resizer &#123;</span><br><span class="line">      fixed_shape_resizer &#123;</span><br><span class="line">        height: <span class="number">300</span></span><br><span class="line">        width: <span class="number">300</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    box_predictor &#123;</span><br><span class="line">      convolutional_box_predictor &#123;</span><br><span class="line">        min_depth: <span class="number">0</span></span><br><span class="line">        max_depth: <span class="number">0</span></span><br><span class="line">        num_layers_before_predictor: <span class="number">0</span></span><br><span class="line">        use_dropout: false</span><br><span class="line">        dropout_keep_probability: <span class="number">0.8</span></span><br><span class="line">        kernel_size: <span class="number">1</span></span><br><span class="line">        box_code_size: <span class="number">4</span></span><br><span class="line">        apply_sigmoid_to_scores: false</span><br><span class="line">        conv_hyperparams &#123;</span><br><span class="line">          activation: RELU_6,</span><br><span class="line">          regularizer &#123;</span><br><span class="line">            l2_regularizer &#123;</span><br><span class="line">              weight: <span class="number">0.00004</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          initializer &#123;</span><br><span class="line">            truncated_normal_initializer &#123;</span><br><span class="line">              stddev: <span class="number">0.03</span></span><br><span class="line">              mean: <span class="number">0.0</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          batch_norm &#123;</span><br><span class="line">            train: true,</span><br><span class="line">            scale: true,</span><br><span class="line">            center: true,</span><br><span class="line">            decay: <span class="number">0.9997</span>,</span><br><span class="line">            epsilon: <span class="number">0.001</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    feature_extractor &#123;</span><br><span class="line">      type: <span class="string">'ssd_mobilenet_v1'</span></span><br><span class="line">      min_depth: <span class="number">16</span></span><br><span class="line">      depth_multiplier: <span class="number">1.0</span></span><br><span class="line">      conv_hyperparams &#123;</span><br><span class="line">        activation: RELU_6,</span><br><span class="line">        regularizer &#123;</span><br><span class="line">          l2_regularizer &#123;</span><br><span class="line">            weight: <span class="number">0.00004</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        initializer &#123;</span><br><span class="line">          truncated_normal_initializer &#123;</span><br><span class="line">            stddev: <span class="number">0.03</span></span><br><span class="line">            mean: <span class="number">0.0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        batch_norm &#123;</span><br><span class="line">          train: true,</span><br><span class="line">          scale: true,</span><br><span class="line">          center: true,</span><br><span class="line">          decay: <span class="number">0.9997</span>,</span><br><span class="line">          epsilon: <span class="number">0.001</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    loss &#123;</span><br><span class="line">      classification_loss &#123;</span><br><span class="line">        weighted_sigmoid &#123;</span><br><span class="line">          anchorwise_output: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      localization_loss &#123;</span><br><span class="line">        weighted_smooth_l1 &#123;</span><br><span class="line">          anchorwise_output: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      hard_example_miner &#123;</span><br><span class="line">        num_hard_examples: <span class="number">3000</span></span><br><span class="line">        iou_threshold: <span class="number">0.99</span></span><br><span class="line">        loss_type: CLASSIFICATION</span><br><span class="line">        max_negatives_per_positive: <span class="number">3</span></span><br><span class="line">        min_negatives_per_image: <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">      classification_weight: <span class="number">1.0</span></span><br><span class="line">      localization_weight: <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line">    normalize_loss_by_num_matches: true</span><br><span class="line">    post_processing &#123;</span><br><span class="line">      batch_non_max_suppression &#123;</span><br><span class="line">        score_threshold: <span class="number">1e-8</span></span><br><span class="line">        iou_threshold: <span class="number">0.6</span></span><br><span class="line">        max_detections_per_class: <span class="number">100</span></span><br><span class="line">        max_total_detections: <span class="number">100</span></span><br><span class="line">      &#125;</span><br><span class="line">      score_converter: SIGMOID</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">train_config: &#123;</span><br><span class="line">  batch_size: <span class="number">1</span> <span class="comment"># 修改处：每次迭代数据量</span></span><br><span class="line">  optimizer &#123;</span><br><span class="line">    rms_prop_optimizer: &#123;</span><br><span class="line">      learning_rate: &#123;</span><br><span class="line">        exponential_decay_learning_rate &#123;</span><br><span class="line">          initial_learning_rate: <span class="number">0.004</span></span><br><span class="line">          decay_steps: <span class="number">800720</span></span><br><span class="line">          decay_factor: <span class="number">0.95</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      momentum_optimizer_value: <span class="number">0.9</span></span><br><span class="line">      decay: <span class="number">0.9</span></span><br><span class="line">      epsilon: <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># fine_tune_checkpoint: "training/model.ckpt" # 修改处</span></span><br><span class="line">  <span class="comment"># from_detection_checkpoint: true # 修改处</span></span><br><span class="line">  <span class="comment"># <span class="doctag">Note:</span> The below line limits the training process to 200K steps, which we</span></span><br><span class="line">  <span class="comment"># empirically found to be sufficient enough to train the pets dataset. This</span></span><br><span class="line">  <span class="comment"># effectively bypasses the learning rate schedule (the learning rate will</span></span><br><span class="line">  <span class="comment"># never decay). Remove the below line to train indefinitely.</span></span><br><span class="line">  num_steps: <span class="number">200000</span></span><br><span class="line">  data_augmentation_options &#123;</span><br><span class="line">    random_horizontal_flip &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  data_augmentation_options &#123;</span><br><span class="line">    ssd_random_crop &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">train_input_reader: &#123;</span><br><span class="line">  tf_record_input_reader &#123;</span><br><span class="line">    input_path: <span class="string">"output/train.record"</span> <span class="comment"># 修改处：训练数据路径</span></span><br><span class="line">  &#125;</span><br><span class="line">  label_map_path: <span class="string">"output/floors.pbtxt"</span> <span class="comment"># 修改处：label路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">eval_config: &#123;</span><br><span class="line">  num_examples: <span class="number">8000</span></span><br><span class="line">  <span class="comment"># <span class="doctag">Note:</span> The below line limits the evaluation process to 10 evaluations.</span></span><br><span class="line">  <span class="comment"># Remove the below line to evaluate indefinitely.</span></span><br><span class="line">  max_evals: <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">eval_input_reader: &#123;</span><br><span class="line">  tf_record_input_reader &#123;</span><br><span class="line">    input_path: <span class="string">"output/test.record"</span> <span class="comment"># 修改处：测试数据路径</span></span><br><span class="line">  &#125;</span><br><span class="line">  label_map_path: <span class="string">"output/floors.pbtxt"</span> <span class="comment"># 修改处：label路径</span></span><br><span class="line">  shuffle: false</span><br><span class="line">  num_readers: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>上述<code>*.config</code>文件中涉及到的label映射文件<code>floors.pbtxt</code>，可以在<code>TensorFlow/models/research/object_detection</code>中找一个文件复制出来修改即可：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">item</span> &#123;</span><br><span class="line">  <span class="attribute">name</span>: <span class="string">"floors"</span></span><br><span class="line">  id: <span class="number">1</span></span><br><span class="line">  display_name: <span class="string">"floor"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">item</span> &#123;</span><br><span class="line">  <span class="attribute">name</span>: <span class="string">"toutu"</span></span><br><span class="line">  id: <span class="number">2</span></span><br><span class="line">  display_name: <span class="string">"toutu"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h2><p>将<a href="https://github.com/tensorflow/models仓库克隆到本地，以其为模型训练的环境。以下步骤为一些环境配置，如清楚可直接跳过，参照https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/installation.md。" target="_blank" rel="noopener">https://github.com/tensorflow/models仓库克隆到本地，以其为模型训练的环境。以下步骤为一些环境配置，如清楚可直接跳过，参照https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/installation.md。</a>              </p><ol><li>将<code>models/research/object_detection/legacy/train.py</code>复制到工作目录下。     </li><li>安装<code>slim</code>模块，借用models的环境，在<code>models/research/slim</code>目录下运行<code>python setup.py install</code>。      </li><li>将slim库暴露到运行环境中<code>export PYTHONPATH=$PYTHONPATH:pwd:pwd/slim</code>。     </li><li>Protobuf编译，在<code>models/research</code>目录下执行<code>protoc object_detection/protos/*.proto --python_out=.</code>。    </li></ol><p>执行命令行如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python train.py --logtostderr <span class="attribute">--train_dir</span>=training/ <span class="attribute">--pipeline_config_path</span>=training/ssd_mobilenet_v1_coco.config</span><br></pre></td></tr></table></figure></p><p><img src="https://img11.360buyimg.com/imagetools/jfs/t1/89793/3/11342/343407/5e33bcc7Ecbebbd38/a67ee67634ca3ed2.jpg" alt="训练ing"><br>如果没有报错，可以看到以上输出，慢慢等待模型训练结果即可。<br>可以通过以下命令看到优化的情况：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tensorboard --logdir=training</span><br></pre></td></tr></table></figure></p><h2 id="模型效果展示"><a href="#模型效果展示" class="headerlink" title="模型效果展示"></a>模型效果展示</h2><h3 id="python模型导出"><a href="#python模型导出" class="headerlink" title="python模型导出"></a>python模型导出</h3><p>通过python测试模型效果不错，将模型导出为tensorflowjs可运行模式，将训练完成的模型导出，TensorFlow Object Detection API提供了一个export_inference_ graph.py脚本用于导出训练好的模型（位于models/research/object_detection目录下）。执行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python export_inference_graph.py --input_type image_tensor --pipeline_config_path training/ssd_mobilenet_v1_coco.config --trained_checkpoint_prefix training/model.ckpt-200000 --output_directory floors_inference_graph</span><br></pre></td></tr></table></figure></p><p><img src="https://img13.360buyimg.com/imagetools/s241x170_jfs/t1/89499/2/11712/41421/5e3ab6e8E9c448f04/f7cf26d08ea4e292.png" alt></p><h3 id="将导出模型转换为TensorFlow-js可运行模型"><a href="#将导出模型转换为TensorFlow-js可运行模型" class="headerlink" title="将导出模型转换为TensorFlow.js可运行模型"></a>将导出模型转换为TensorFlow.js可运行模型</h3><p>将模型转换为TensorFlow.js可用的web格式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型转换器安装</span></span><br><span class="line">pip install tensorflowjs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行转换器提供的转换脚本，以下命令任选一</span></span><br><span class="line"><span class="comment"># 参考：https://github.com/tensorflow/tfjs-converter/tree/master/tfjs-converter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># covert from saved_model</span></span><br><span class="line">tensorflowjs_converter --input_format=tf_saved_model --output_format=tfjs_graph_model --signature_name=serving_default --saved_model_tags=serve ./saved_model ./web_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># convert from frozen_model</span></span><br><span class="line">tensorflowjs_converter --input_format=tf_frozen_model --output_node_names=<span class="string">'num_detections,detection_boxes,detection_scores,detection_classes'</span> ./frozen_inference_graph.pb  ./web_model</span><br></pre></td></tr></table></figure></p><p>得到如下的TensorFlow.js可运行模型数据。<br><img src="https://img13.360buyimg.com/imagetools/s210x170_jfs/t1/95639/32/11688/89905/5e3ab5e5E31a1f5ec/b8a8a16eeaf76b8e.jpg" alt="web model">   </p><h3 id="前端运行模型"><a href="#前端运行模型" class="headerlink" title="前端运行模型"></a>前端运行模型</h3><p>此处只给出关键代码，需要注意的点是，输出数据维度名称与<code>export_inference_graph.py</code>中相对应。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入本地模型</span></span><br><span class="line">model = <span class="keyword">await</span> tf.loadGraphModel(<span class="string">'./web_model/model.json'</span>);</span><br><span class="line"><span class="comment">// 模型输入处理</span></span><br><span class="line"><span class="keyword">let</span> image = tf.browser.fromPixels(canvas);</span><br><span class="line"><span class="keyword">const</span> t4d = image.expandDims(<span class="number">0</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  获取所需的输出维度</span></span><br><span class="line"><span class="comment">   * num_detections: 检测总数</span></span><br><span class="line"><span class="comment">   * detection_boxes: 检测框张量，[ymin , xmin , ymax , xmax]为归一化数据，对应图片检测框位置只需乘以对应宽高</span></span><br><span class="line"><span class="comment">   * detection_scores: 检测框分数，即概率</span></span><br><span class="line"><span class="comment">   * detection_classes: 类别ID，与label_map中相对应</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="keyword">let</span> tensor = <span class="keyword">await</span> model.executeAsync(&#123;<span class="string">'image_tensor'</span>: t4d&#125;, <span class="string">`<span class="subst">$&#123;dim&#125;</span>:0`</span>);</span><br><span class="line">modelOut[dim] = <span class="keyword">await</span> tensor.data();</span><br></pre></td></tr></table></figure></p><h2 id="发散思考与深入"><a href="#发散思考与深入" class="headerlink" title="发散思考与深入"></a>发散思考与深入</h2><ul><li>训练结果有一定<strong>随机性</strong>，增加少量数据不一定会越来越精准，所以模型的训练需要一定时间的数据集积累，才能得到较好结果；由于数据集限制，对于规整的设计稿识别效果显然更好。    </li><li>需要测试图片颜色对识别效果的影响，后续可能需要加入<strong>交互稿的识别</strong>；对于<strong>多种类型的设计稿</strong>进行匹配，目前仅仅测试了会场类型；对于某些特殊、有显著特征的楼层类型可以进行<strong>更细致分类的识别</strong>，比如头图、优惠券等。   </li><li>使用python训练的模型不一定能转换为tensorflowjs可运行模型，建议<strong>在哪个环境使用，就在哪个环境训练模型</strong>。不同的TensorFlow版本训练出的模型效果可能有很大差别，不能盲目使用新版本，容易出现未知bug无法解决。            </li><li>楼层分割这个需求应用比较局限且比较困难。<br>楼层是一个复合结构，一个楼层可能有多个组件结合嵌套组成，情况较为复杂。组件维度的分割是更加有价值且合理的分割行为，且组件分割的应用也会更加广泛，例如在设计稿中识别某个组件及其类型，并与沉淀代码库进行匹配。近几年的一些设计图直接生成代码也采用类似的思路，比如微软的sketch2code，淘宝的imgcook。      </li></ul><h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><ol><li><code>ModuleNotFoundError: No module named &#39;nets&#39;</code><br>需要安装slim模块，如果借用<code>tensorflow/models</code>环境，则在<code>models/research/slim</code>目录下运行<code>python setup.py install</code>。另外需要将该模块暴露到环境中<code>export PYTHONPATH=$PYTHONPATH:pwd:pwd/slim</code>。其中pwd表示的是当前克隆目录，即research文件所在。            </li><li><code>ImportError: cannot import name &#39;preprocessor_pb2&#39; from &#39;object_detection.protos&#39;</code><br>需要<code>protoc object_detection/protos/*.proto --python_out=.</code>，参考<a href="https://github.com/tensorflow/models/issues/2930" target="_blank" rel="noopener">issue2930</a></li><li><code>ValueError: Unsupported Ops in the model before optimization LogSoftmax NonMaxSuppressionV5</code><br>python训练得到的模型不能百分百转换到tensorflowjs下运行，参考<a href="https://github.com/tensorflow/tfjs/issues/684" target="_blank" rel="noopener">issue684</a>建议加入参数<code>--skip_op_check</code>，可以转化成功但是生成的模型有问题。<br>tensorflowjs有许多操作不支持，幸好刚刚更新的版本加入了NonMaxSuppressionV5支持，升级到1.5.2版本搞定。    </li><li>python安装tensorflowjs最新版本失败<br>python版本过高的问题，官方建议版本为3.6.8。    </li><li>导出saved model的variables为空<br>参考<a href="https://github.com/tensorflow/models/issues/1988" target="_blank" rel="noopener">issue1988</a>，修改<code>export.py</code>中<code>write_saved_model</code>函数。   </li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/training.html" target="_blank" rel="noopener">[1] Training Custom Object Detector</a><br><a href="https://zhuanlan.zhihu.com/p/35854575" target="_blank" rel="noopener">[2] 目标检测Tensorflow object detection API之构建自己的模型</a><br><a href="https://tensorflow.google.cn/guide" target="_blank" rel="noopener">[3] Tensorflow Guide</a>   </p>]]></content>
      
      
      <categories>
          
          <category> 深入学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> tensorflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue组件库之popup弹窗组件</title>
      <link href="/2019/12/23/Vue%E7%BB%84%E4%BB%B6%E5%BA%93%E4%B9%8BPopup%E5%BC%B9%E7%AA%97%E7%BB%84%E4%BB%B6/"/>
      <url>/2019/12/23/Vue%E7%BB%84%E4%BB%B6%E5%BA%93%E4%B9%8BPopup%E5%BC%B9%E7%AA%97%E7%BB%84%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>在做活动页面时经常需要实现各种各样的弹窗，有一些常见的问题需要处理，包含：   </p><ul><li>滑动穿透问题：滑动上层元素导致底层元素滚动</li><li>多弹窗层级问题：当有多弹窗时，最新的弹窗永远在最上层    </li><li>出现/消失过渡动画</li></ul><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>已发布npm包欢迎使用反馈和star~<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install </span><span class="keyword">jdc-popup </span>-S</span><br></pre></td></tr></table></figure></p><p>github: <a href="https://github.com/winniecjy/jdc-popup" target="_blank" rel="noopener">https://github.com/winniecjy/jdc-popup</a><br>demo: <a href="https://winniecjy.github.io/jdc-popup/demo/" target="_blank" rel="noopener">https://winniecjy.github.io/jdc-popup/demo/</a><br><img src="https://img11.360buyimg.com/imagetools/s200x200_jfs/t1/91021/5/7943/23039/5e00255bE34ea4ce4/da97ea669a8ccd64.png" alt></p><h2 id="滑动穿透问题"><a href="#滑动穿透问题" class="headerlink" title="滑动穿透问题"></a>滑动穿透问题</h2><h3 id="初始的解决方案"><a href="#初始的解决方案" class="headerlink" title="初始的解决方案"></a>初始的解决方案</h3><p>打开浮层时fixed底部元素，同时为了保持body的位置与打开浮层前一致，设置top偏移为当前scrollTop；<br>关闭浮层时恢复底部元素状态和滚动高度；<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">controlledBgScrolled() &#123;</span><br><span class="line">    <span class="keyword">let</span> bgEle = <span class="built_in">document</span>.getElementById(<span class="string">'app'</span>);</span><br><span class="line">    <span class="comment">// 打开浮层</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.showPopup) &#123;</span><br><span class="line">        <span class="keyword">let</span> top = <span class="built_in">document</span>.documentElement.scrollTop</span><br><span class="line">          || <span class="built_in">window</span>.pageYOffset</span><br><span class="line">          || <span class="built_in">document</span>.body.scrollTop;</span><br><span class="line">        <span class="keyword">this</span>.scrollTop = top;</span><br><span class="line">        bgEle.style.position = <span class="string">'fixed'</span>;</span><br><span class="line">        bgEle.style.top = <span class="string">`-<span class="subst">$&#123;top&#125;</span>px`</span>;</span><br><span class="line">        bgEle.style.height = <span class="string">'100%'</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        bgEle.style.position = <span class="string">'relative'</span>;</span><br><span class="line">        bgEle.style.top = <span class="string">''</span>;</span><br><span class="line">        bgEle.style.height = <span class="string">'100%'</span>;</span><br><span class="line">        <span class="built_in">document</span>.documentElement.scrollTop = <span class="keyword">this</span>.scrollTop; </span><br><span class="line">        <span class="built_in">window</span>.pageYOffset = <span class="keyword">this</span>.scrollTop;</span><br><span class="line">        <span class="built_in">document</span>.body.scrollTop = <span class="keyword">this</span>.scrollTop;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这个方案的缺点是：   </p><ol><li>打开/关闭弹层瞬间，可以看到有闪动</li><li>由于是APP内嵌页面，当设置APP沉浸式状态栏有几率发生冲突</li></ol><h3 id="使用库实现"><a href="#使用库实现" class="headerlink" title="使用库实现"></a>使用库实现</h3><p>测试提出bug的时间比较紧急，所以直接引入了npm包<a href="#ref1">tua-scroll-body-lock</a>解决了该问题，经过测试，ios8+，android4.4+下没有发现问题。<br>库的源码比较清晰，有兴趣的同学可以看一下：<a href="https://github.com/tuateam/tua-body-scroll-lock/tree/master/src" target="_blank" rel="noopener">https://github.com/tuateam/tua-body-scroll-lock/tree/master/src</a><br>之前的个人的思路都是想要一套代码兼容各端，这个库是将问题细分，对不同端进行了不同的处理，更容易去兼容。据官方描述，这三种方案都无法完美兼容所有端，详细可以查看<a href="#ref2">[2]</a>。             </p><h4 id="PC端"><a href="#PC端" class="headerlink" title="PC端"></a>PC端</h4><p>PC端实现比较简单，通过在body设置<code>overflow: hidden</code>就OK了。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $body = <span class="built_in">document</span>.querySelector(<span class="string">'body'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyStyle = &#123; ...$body.style &#125;</span><br><span class="line"><span class="keyword">const</span> scrollBarWidth = <span class="built_in">window</span>.innerWidth - <span class="built_in">document</span>.body.clientWidth</span><br><span class="line"><span class="comment">// 打开浮层时</span></span><br><span class="line">$body.style.overflow = <span class="string">'hidden'</span></span><br><span class="line">$body.style.boxSizing = <span class="string">'border-box'</span></span><br><span class="line">$body.style.paddingRight = <span class="string">`<span class="subst">$&#123;scrollBarWidth&#125;</span>px`</span></span><br><span class="line"><span class="comment">// 关闭浮层时，恢复原始设置</span></span><br><span class="line">[<span class="string">'overflow'</span>, <span class="string">'boxSizing'</span>, <span class="string">'paddingRight'</span>]</span><br><span class="line">.forEach(<span class="function">(<span class="params">x: OverflowHiddenPcStyleType</span>) =&gt;</span> &#123;</span><br><span class="line">    $body.style[x] = bodyStyle[x] || <span class="string">''</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="Android端"><a href="#Android端" class="headerlink" title="Android端"></a>Android端</h4><p>Android端的实现与个人的方案思路基本一致，打开弹层时将底部元素fixed并设置top偏移，关闭浮层时恢复现场，注意到底部元素必须同时设置html和body。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> scrollTop = $html.scrollTop || $body.scrollTop</span><br><span class="line"><span class="keyword">const</span> htmlStyle = &#123; ...$html.style &#125;</span><br><span class="line"><span class="keyword">const</span> bodyStyle = &#123; ...$body.style &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开浮层时，fixed底部</span></span><br><span class="line">$html.style.height = <span class="string">'100%'</span></span><br><span class="line">$html.style.overflow = <span class="string">'hidden'</span></span><br><span class="line">$body.style.top = <span class="string">`-<span class="subst">$&#123;scrollTop&#125;</span>px`</span></span><br><span class="line">$body.style.width = <span class="string">'100%'</span></span><br><span class="line">$body.style.height = <span class="string">'auto'</span></span><br><span class="line">$body.style.position = <span class="string">'fixed'</span></span><br><span class="line">$body.style.overflow = <span class="string">'hidden'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭浮层时，恢复现场</span></span><br><span class="line">$html.style.height = htmlStyle.height || <span class="string">''</span></span><br><span class="line">$html.style.overflow = htmlStyle.overflow || <span class="string">''</span></span><br><span class="line">[<span class="string">'top'</span>, <span class="string">'width'</span>, <span class="string">'height'</span>, <span class="string">'overflow'</span>, <span class="string">'position'</span>]</span><br><span class="line">.forEach(<span class="function">(<span class="params">x: OverflowHiddenMobileStyleType</span>) =&gt;</span> &#123;</span><br><span class="line">  $body.style[x] = bodyStyle[x] || <span class="string">''</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.scrollTo(<span class="number">0</span>, scrollTop)</span><br></pre></td></tr></table></figure></p><h4 id="iOS端"><a href="#iOS端" class="headerlink" title="iOS端"></a>iOS端</h4><p>iOS端在打开浮层时，禁用了底部的<code>touchmove</code>事件，如果弹窗内部元素需要可滚动，则通过另外的函数自行处理。关闭浮层时移除所有事件监听。经测试，该方案在Android下弹窗滚动到边界时，底部元素有几率出现滚动。该库在iPhone 6p下初次打开无法滚动。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***  打开浮层时,处理浮层和底部元素的滚动事件 ***/</span></span><br><span class="line"><span class="comment">// 1. targetElement为需要滚动的元素容器，处理其滚动</span></span><br><span class="line"><span class="keyword">if</span> (targetElement &amp;&amp; lockedElements.indexOf(targetElement) === <span class="number">-1</span>) &#123;</span><br><span class="line">    targetElement.ontouchstart = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        initialClientY = event.targetTouches[<span class="number">0</span>].clientY</span><br><span class="line">    &#125;</span><br><span class="line">    targetElement.ontouchmove = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.targetTouches.length !== <span class="number">1</span>) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 手动处理滚动</span></span><br><span class="line">        handleScroll(event, targetElement)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 记录可滚动元素</span></span><br><span class="line">    lockedElements.push(targetElement)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> handleScroll = <span class="function">(<span class="params">event, targetElement</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> clientY = event.targetTouches[<span class="number">0</span>].clientY - initialClientY</span><br><span class="line">    <span class="keyword">if</span> (targetElement) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; scrollTop, scrollHeight, clientHeight &#125; = targetElement</span><br><span class="line">        <span class="comment">// 向上滚动时 且 已经到达顶部</span></span><br><span class="line">        <span class="keyword">const</span> isOnTop = clientY &gt; <span class="number">0</span> &amp;&amp; scrollTop === <span class="number">0</span></span><br><span class="line">        <span class="comment">// 当向下滚动 且 已经到达底部</span></span><br><span class="line">        <span class="keyword">const</span> isOnBottom = clientY &lt; <span class="number">0</span></span><br><span class="line">                          &amp;&amp; scrollTop + clientHeight + <span class="number">1</span> &gt;= scrollHeight</span><br><span class="line">        <span class="keyword">if</span> (isOnTop || isOnBottom) &#123;</span><br><span class="line">            <span class="keyword">return</span> preventDefault(event)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    event.stopPropagation()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 禁止document的touchMove事件</span></span><br><span class="line"><span class="keyword">if</span> (!documentListenerAdded) &#123;</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(</span><br><span class="line">      <span class="string">'touchmove'</span>,</span><br><span class="line">      preventDefault,</span><br><span class="line">      eventListenerOptions)</span><br><span class="line">    documentListenerAdded = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/***  关闭浮层时，移除时间监听 ***/</span></span><br><span class="line"><span class="keyword">if</span> (targetElement) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = lockedElements.indexOf(targetElement)</span><br><span class="line">    <span class="keyword">if</span> (index !== <span class="number">-1</span>) &#123;</span><br><span class="line">        targetElement.ontouchmove = <span class="literal">null</span></span><br><span class="line">        targetElement.ontouchstart = <span class="literal">null</span></span><br><span class="line">        lockedElements.splice(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (documentListenerAdded) &#123;</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(</span><br><span class="line">      <span class="string">'touchmove'</span>,</span><br><span class="line">      preventDefault,</span><br><span class="line">      eventListenerOptions)</span><br><span class="line">    documentListenerAdded = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="ui组件库都是怎么实现的？"><a href="#ui组件库都是怎么实现的？" class="headerlink" title="ui组件库都是怎么实现的？"></a>ui组件库都是怎么实现的？</h3><p>用库可以较好的完成这个需求，但是对于滑动穿透这样的小问题，每次都引入库解决有点小题大做。基于上述考虑，选取了京东的nutui/有赞的vant/饿了么的mintui对比其实现方案，对比如下：       </p><table><thead><tr><th>组件库</th><th>实现思路</th><th>实现形式</th></tr></thead><tbody><tr><td><a href="https://github.com/youzan/vant/blob/dev/src/mixins/popup/index.js" target="_blank" rel="noopener">vant</a></td><td>touch事件处理</td><td>mixins，抽取了复杂复用逻辑</td></tr><tr><td><a href="https://github.com/ElemeFE/mint-ui/tree/master/src/utils/popup" target="_blank" rel="noopener">mint</a></td><td>touch事件处理</td><td>mixins，抽取了复杂逻辑，但实现方案上依赖组件结构，复用性不强</td></tr><tr><td><a href="https://github.com/jdf2e/nutui/blob/master/src/packages/dialog/dialog.vue" target="_blank" rel="noopener">nut</a></td><td>fixed底层背景</td><td>组件内部函数，简洁易读，复用性不强</td></tr></tbody></table><p>对比了一下三个方案，并实际测试（iOS8+/Android4+），还是无法兼容所有机型，最终的还是按照库的基本思路包装了一下组件。<br>另外加入overscroll-behavior虽然兼容性不佳，但是安卓原生浏览器和chrome浏览器仍然有部分支持。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于半透明蒙层阻止滚动</span></span><br><span class="line">mask.addEventListener(</span><br><span class="line">  <span class="string">'touchmove'</span>, </span><br><span class="line">  <span class="keyword">this</span>.preventDefault,</span><br><span class="line">  &#123; <span class="attr">capture</span>: <span class="literal">false</span>, <span class="attr">passive</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">  <span class="literal">false</span>);</span><br><span class="line"><span class="comment">// 对可滚动元素容器手动处理滚动</span></span><br><span class="line">onTouchMove(event, targetElement) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (targetElement) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            scrollTop,</span><br><span class="line">            scrollHeight,</span><br><span class="line">            clientHeight</span><br><span class="line">        &#125; = targetElement</span><br><span class="line">        <span class="comment">// 向上滚动时 且 已经到达顶部</span></span><br><span class="line">        <span class="keyword">const</span> isOnTop = <span class="keyword">this</span>.deltaY &gt; <span class="number">0</span> &amp;&amp; scrollTop === <span class="number">0</span></span><br><span class="line">        <span class="comment">// 当向下滚动 且 已经到达底部</span></span><br><span class="line">        <span class="keyword">const</span> isOnBottom = <span class="keyword">this</span>.deltaY &lt; <span class="number">0</span></span><br><span class="line">                          &amp;&amp; scrollTop + clientHeight + <span class="number">1</span> &gt;= scrollHeight</span><br><span class="line">        <span class="keyword">if</span> (isOnTop || isOnBottom) &#123;</span><br><span class="line">            <span class="keyword">this</span>.preventDefault(event)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    event.stopPropagation()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 关闭弹窗时，移除所有事件</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><h2 id="多弹窗层级问题"><a href="#多弹窗层级问题" class="headerlink" title="多弹窗层级问题"></a>多弹窗层级问题</h2><p>当前后打开两个弹窗，用户的预期是按照打开的先后顺序，越后打开的弹窗在越上层，简而言之就是新弹窗永远在最上层。可以通过记录当前出现过的最大zIndex，新弹窗<code>zIndex = zIndex+1</code>。 另外滑动穿透问题在多弹窗情况下也需要处理，对于非当前最高层级弹窗，不应当收到滚动影响。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$el.style.zIndex = context.zIndex + <span class="number">1</span>; </span><br><span class="line">context.zIndex += <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p><h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>业务上的弹窗样式一般比较复杂，如果只是简单通用的弹窗样式，想要解决滑动穿透问题，可以通过<code>Vue.extend</code>扩展，将弹窗组件直接挂载到document下（element-ui中就使用了类似的做法），不会和主体内容互相影响，调用起来也更加灵活。   </p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="ref1"><a href="https://tuateam.github.io/tua-body-scroll-lock/" target="_blank" rel="noopener">[1] tua-scroll-body-lock</a></a><br><a href="ref2"><a href="https://juejin.im/post/5ca4816e5188250b251e34e9" target="_blank" rel="noopener">[2] 滑动穿透(锁body)终极探索</a></a><br><a href="https://blog.csdn.net/riddle1981/article/details/102659958" target="_blank" rel="noopener">[3] vant-popup</a><br><a href="https://github.com/jdf2e/nutui" target="_blank" rel="noopener">[4] NUTUI</a>   </p>]]></content>
      
      
      <categories>
          
          <category> vue组件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
            <tag> 组件沉淀 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>算法应用之自定义公式计算</title>
      <link href="/2019/12/19/%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%AC%E5%BC%8F%E8%AE%A1%E7%AE%97/"/>
      <url>/2019/12/19/%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%AC%E5%BC%8F%E8%AE%A1%E7%AE%97/</url>
      
        <content type="html"><![CDATA[<h2 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h2><p>实现代码：<a href="https://github.com/winniecjy/formula-calculator" target="_blank" rel="noopener">https://github.com/winniecjy/formula-calculator</a><br>demo：<a href="https://winniecjy.github.io/formula-calculator/dist/index.html" target="_blank" rel="noopener">https://winniecjy.github.io/formula-calculator/dist/index.html</a><br><img src="https://img10.360buyimg.com/imagetools/jfs/t1/99277/36/7487/45111/5dfc6318Ef7c502e3/67ae98bfa7ff0d65.gif" alt="demo"></p><h2 id="业务背景"><a href="#业务背景" class="headerlink" title="业务背景"></a>业务背景</h2><p>最近的业务涉及到了很多数据的计算，数据库提供了一些基础数据，基于这些数据和公式运算才可以得出最终的目标数据。<br>在目标数据量较少的前提下简单粗暴的计算就可以实现功能了，随着目标数据越来越多样，涉及到越来越多的基础数据，问题就随之而来了：   </p><ul><li>基础数据可能来源于不同的数据表不同字段。   </li><li>公式只是基本的四则运算但是数量较多，而且后续可能会有所增减。    </li></ul><p>这些问题导致代码越来越长，可读性降低，而且后续修改成本越来越大。如果有别的同学要介入这个项目，光找公式具体在哪里进行计算就要花老半天。这个功能很容易实现，但是要随着公式数量增加和使用到的字段增多，代码就会越来越丑陋。<br><strong>最终方案是：将公式作为配置项抽离出来，方便后续增加/修改。基于固定格式的公式配置来进行运算得出目标结果</strong>。    </p><h2 id="四则运算实现"><a href="#四则运算实现" class="headerlink" title="四则运算实现"></a>四则运算实现</h2><p>要对公式进行运算，首先需要实现基础的四则运算（包含符号()+-*/），用于解析一个字符串的计算式子（如：’(7+5)/3-1’）。算法思路如下：     </p><h3 id="第一步：中缀表达式转后缀表达式"><a href="#第一步：中缀表达式转后缀表达式" class="headerlink" title="第一步：中缀表达式转后缀表达式"></a>第一步：中缀表达式转后缀表达式</h3><p>中缀表达式是利于人理解的表达方式，而后缀表达式更方便计算机的运算。所以首先将中缀表达式转换成后缀表达式。这个过程需要一个辅助处理的栈，从左到右扫描表达式里的每一个字符，执行以下操作：       </p><ul><li>为数字，直接添加到后缀表达式末尾</li><li>为+-*/运算符，弹出所有优先级大于或者等于该运算符的辅助栈顶元素到后缀表达式中，然后将该运算符入栈</li><li>为左括号(，直接入栈</li><li>为右括号)，弹出栈顶元素到后缀表达式中，直到匹配到第一个左括号，括号不输出到后缀表达式    </li></ul><p>遍历完成后，将辅助栈中的元素输出，则得到后缀表达式。<br>说明：操作符优先级为：() &lt; +- &lt; */<br>以A*(B-C)/D为例，处理过程如下：    </p><table><thead><tr><th>当前字符</th><th>后缀表达式</th><th>辅助栈</th></tr></thead><tbody><tr><td>A</td><td>A</td><td></td></tr><tr><td>*</td><td>A</td><td>*</td></tr><tr><td>(</td><td>A</td><td>*(</td></tr><tr><td>B</td><td>AB</td><td>*(</td></tr><tr><td>-</td><td>AB</td><td>*(-</td></tr><tr><td>C</td><td>ABC</td><td>*(-</td></tr><tr><td>)</td><td>ABC-</td><td>*</td></tr><tr><td>/</td><td>ABC-*</td><td>/</td></tr><tr><td>D</td><td>ABC-*D</td><td>/</td></tr><tr><td></td><td>ABC-*D/</td></tr></tbody></table><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">infixToPostfix</span>(<span class="params">infix, postfix</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> postfixHelper = Stack()</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;infix.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> c = infix[i]</span><br><span class="line">        <span class="keyword">if</span> (!isOper(c)) &#123; <span class="comment">// 处理操作数</span></span><br><span class="line">            <span class="keyword">let</span> operands = <span class="string">""</span></span><br><span class="line">            <span class="keyword">while</span> (i&lt;infix.length &amp;&amp; !isOper(infix[i])) &#123;</span><br><span class="line">                operands += infix[i++]</span><br><span class="line">            &#125;</span><br><span class="line">            postfix.push(operands)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 处理操作符做出处理</span></span><br><span class="line">            handlerSymbol(c, postfixHelper, postfix)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果输入结束，将栈内元素全部弹出，加入后缀表达式中</span></span><br><span class="line">    <span class="keyword">while</span> (!postfixHelper.empty()) &#123;</span><br><span class="line">        <span class="keyword">let</span> c = postfixHelper.top()</span><br><span class="line">        postfix.push(c)</span><br><span class="line">        postfixHelper.pop()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第二步：计算后缀表达式"><a href="#第二步：计算后缀表达式" class="headerlink" title="第二步：计算后缀表达式"></a>第二步：计算后缀表达式</h3><p>计算后缀表达式，同样需要一个辅助处理的栈，从左到右遍历字符，遇到操作数压入辅助栈中；遇到操作符则从栈顶取出两个元素，第一个为<strong>右运算数</strong>，第二个为<strong>左运算数</strong>（注意这个顺序在除法中是结果相关的）。运算后的结果入栈。遍历完成后，辅助栈顶的元素则为所求。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calcPostFix</span>(<span class="params">postfix, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> helperStack = Stack()</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;postfix.length; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> c = postfix[i]</span><br><span class="line">    <span class="comment">// 如果是操作数，压入栈中</span></span><br><span class="line">    <span class="keyword">if</span> (!isOper(c)) &#123;</span><br><span class="line">        <span class="keyword">let</span> op = formatData(c, data) <span class="comment">// 根据公式规则获取具体数据</span></span><br><span class="line">        helperStack.push(op)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果是操作符，从栈中弹出元素进行计算</span></span><br><span class="line">      <span class="keyword">let</span> op1 = helperStack.top()</span><br><span class="line">      helperStack.pop()</span><br><span class="line">      <span class="keyword">let</span> op2 = helperStack.top()</span><br><span class="line">      helperStack.pop()</span><br><span class="line">      <span class="keyword">if</span> (op1 === <span class="literal">null</span> || op2 === <span class="literal">null</span>) &#123;</span><br><span class="line">        helperStack.push(<span class="literal">null</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">"+"</span>:</span><br><span class="line">            helperStack.push(op2 + op1)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          <span class="keyword">case</span> <span class="string">"-"</span>:</span><br><span class="line">            helperStack.push(op2 - op1)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          <span class="keyword">case</span> <span class="string">"*"</span>:</span><br><span class="line">            helperStack.push(op2 * op1)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          <span class="keyword">case</span> <span class="string">"/"</span>:</span><br><span class="line">            helperStack.push(op2 / op1) <span class="comment">// 注意是op2(op)op1而不是op1(op)op2</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> helperStack.top()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="公式的配置规则"><a href="#公式的配置规则" class="headerlink" title="公式的配置规则"></a>公式的配置规则</h2><p>实现了四则运算后，我们的主体功能已经基本完成只差临门一脚了。细心的同学会发现，在计算后缀表达式的时候，操作数入栈之前先使用<code>formData</code>构造数据，我们的公式数据匹配就在这里实现。<br>目前比较简单的匹配思路是以<code>[数据表名称]_[字段名]</code>为固定格式，入参data格式为：      </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data  = &#123;</span><br><span class="line">    [数据表名称]: &#123;</span><br><span class="line">        [字段<span class="number">1</span>]: <span class="number">123</span>,</span><br><span class="line">        [字段<span class="number">2</span>]: <span class="number">456</span>,</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过正则匹配，可以获取数据表名称和字段名，从data中获取到正确操作数。   </p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="关于扩展"><a href="#关于扩展" class="headerlink" title="关于扩展"></a>关于扩展</h3><p>目前该功能只是后台简单应用，可以保证公式合法性。后续可能将该功能可暴露给业务使用者，让业务使用者可以自定义获取想要的数据和公式。<br>如果后续有需求，需要将这个简陋的功能再包装一层，保证公式的合法性，同时需要考虑数据安全性问题。   </p><h3 id="关于eval"><a href="#关于eval" class="headerlink" title="关于eval"></a>关于eval</h3><p>以目前的公式配置原则，直接通过<code>db1.field1-db2.field2</code>的格式，以eval计算字符串也可以得出结果。基于以下的考虑没有使用：</p><ul><li>eval是一个比较危险的函数，该功能后续考虑开放给用户，不建议使用。   </li><li>目前的计算规则比较简单，因为数据表之间有同一个关键字段进行匹配，确保返回数据只有一条，后续如有其他变动，目前正则的形式扩展性更好。   </li></ul>]]></content>
      
      
      <categories>
          
          <category> 复盘 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析工具项目 </tag>
            
            <tag> 项目复盘 </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录之MAC环境下一次重新安装nvm和nrm</title>
      <link href="/2019/09/05/%E8%AE%B0%E5%BD%95%E4%B9%8BMAC%E7%8E%AF%E5%A2%83%E4%B8%8B%E4%B8%80%E6%AC%A1%E9%87%8D%E6%96%B0%E5%AE%89%E8%A3%85nvm%E5%92%8Cnrm/"/>
      <url>/2019/09/05/%E8%AE%B0%E5%BD%95%E4%B9%8BMAC%E7%8E%AF%E5%A2%83%E4%B8%8B%E4%B8%80%E6%AC%A1%E9%87%8D%E6%96%B0%E5%AE%89%E8%A3%85nvm%E5%92%8Cnrm/</url>
      
        <content type="html"><![CDATA[<h2 id="简短介绍"><a href="#简短介绍" class="headerlink" title="简短介绍"></a>简短介绍</h2><p>nvm：node版本管理器，允许快速地在同一台设备上进行多个node版本之间切换。<br>nrm：npm源管理器，允许快速地在 npm 源间切换。   </p><h2 id="重新安装"><a href="#重新安装" class="headerlink" title="重新安装"></a>重新安装</h2><blockquote><p>前情提要：本地环境已有一个安装失败的nvm和单独安装的node。   </p></blockquote><h3 id="1-删除本地的nvm和node版本"><a href="#1-删除本地的nvm和node版本" class="headerlink" title="1. 删除本地的nvm和node版本"></a>1. 删除本地的nvm和node版本</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nvm：rm -rf ~/.nvm</span><br><span class="line"><span class="keyword">node</span><span class="title">（brew</span>安装）：brew uninstall <span class="keyword">node</span><span class="title"></span></span><br><span class="line"><span class="title">node</span>（官网安装）：sudo rm -rf /usr/local/&#123;bin/&#123;<span class="keyword">node</span><span class="title">,npm</span>&#125;,lib/node_modules/npm,lib/<span class="keyword">node</span><span class="title">,share</span>/man/*/<span class="keyword">node</span>.<span class="title">*&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-删除-NVM-DIR"><a href="#2-删除-NVM-DIR" class="headerlink" title="2. 删除$NVM_DIR"></a>2. 删除<code>$NVM_DIR</code></h3><p>可检查以下目录<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/.zshrc</span><br><span class="line">~/.bash_profile</span><br><span class="line">~/.bashrc</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>删除后重启终端，或通过如<code>source ~/.zshrc</code>操作，使得环境变量生效。检查是否删除成功可以通过：<code>echo $NVM_DIR</code>   </p><h3 id="3-安装nvm"><a href="#3-安装nvm" class="headerlink" title="3. 安装nvm"></a>3. 安装nvm</h3><p>按照官网说明即可：<a href="https://github.com/nvm-sh/nvm" target="_blank" rel="noopener">https://github.com/nvm-sh/nvm</a></p><h3 id="4-设置默认node版本"><a href="#4-设置默认node版本" class="headerlink" title="4. 设置默认node版本"></a>4. 设置默认node版本</h3><p>通过官方的安装方法，此时已经可以使用nvm下载/切换不同版本的node，为了避免每次使用前都要通过<code>nvm use [version]</code>方法来设置版本，我们可以为其设置一个默认版本：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm alias<span class="built_in"> default </span>v8.9.1</span><br></pre></td></tr></table></figure></p><h3 id="5-使用nvm时的全局安装"><a href="#5-使用nvm时的全局安装" class="headerlink" title="5. 使用nvm时的全局安装"></a>5. 使用nvm时的全局安装</h3><p>由于使用了nvm，与系统默认的全局安装路径不一致，所以会发生全局安装的包找不到的情况，需要设置全局文件夹（注意版本号替换为当前使用的版本）：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm<span class="built_in"> config </span><span class="builtin-name">set</span><span class="built_in"> prefix </span><span class="variable">$NVM_DIR</span>/versions/node/v8.9.1</span><br></pre></td></tr></table></figure></p><p>此时，不同版本的node之前全局安装包不共享，每一个版本下的全局文件夹路径都需要单独设置。</p>]]></content>
      
      
      <categories>
          
          <category> 复盘 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> 记录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录第一次typescript重构后端</title>
      <link href="/2019/08/05/%E8%AE%B0%E5%BD%95%E7%AC%AC%E4%B8%80%E6%AC%A1typescript%E9%87%8D%E6%9E%84%E5%90%8E%E7%AB%AF/"/>
      <url>/2019/08/05/%E8%AE%B0%E5%BD%95%E7%AC%AC%E4%B8%80%E6%AC%A1typescript%E9%87%8D%E6%9E%84%E5%90%8E%E7%AB%AF/</url>
      
        <content type="html"><![CDATA[<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>学习typescript最主要的是学习类型声明方法，官方文档很详细，适合作为字典，哪里不是特别理解的时候进行查阅。<br>快速入门的教程网上也有很多了，个人参考的是<a href="https://ts.xcatliu.com/" target="_blank" rel="noopener">typescript入门教程</a>，适合有一定Java/C语言基础的同学食用，介绍比较简单明了。   </p><h2 id="代码检查eslint-prettier"><a href="#代码检查eslint-prettier" class="headerlink" title="代码检查eslint+prettier"></a>代码检查eslint+prettier</h2><p>项目中使用的是thinkjs 3.0框架，默认配置了<code>tslint</code>，由于typescript官方决定转向eslint，tslint不再维护，所以还是修改了一下配置，采用<code>eslint+prettier</code>来对代码进行检查。<code>tslint</code>的检查规则使用的是腾讯的<a href="https://github.com/AlloyTeam/eslint-config-alloy" target="_blank" rel="noopener">AlloyTeam Eslint规则</a>，同时加入了一些项目配置。<br>eslint主要负责语法检查，配置如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  extends: [</span><br><span class="line">      <span class="string">'eslint-config-alloy/typescript'</span>,</span><br><span class="line">      <span class="comment">// "prettier" // eslint-config-prettier:  关闭一些不必要的或者是与prettier冲突的lint选项，由于AlloyTeam的typescript规则与标准规则有重复，无法起到应有的作用，建议根据prettier配置对</span></span><br><span class="line">  ],</span><br><span class="line">  globals: &#123;</span><br><span class="line">      <span class="comment">// 这里填入你的项目需要的全局变量</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 这里值为 false 表示这个全局变量不允许被重新赋值，比如：</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// jQuery: false,</span></span><br><span class="line">      <span class="comment">// $: false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  rules: &#123;</span><br><span class="line">      <span class="comment">// 项目个性化设置</span></span><br><span class="line">      <span class="string">'prefer-promise-reject-errors'</span>: <span class="string">'warn'</span>,</span><br><span class="line">      <span class="string">'@typescript-eslint/prefer-for-of'</span>: <span class="string">'warn'</span>,</span><br><span class="line">      <span class="string">'max-depth'</span>: <span class="string">'warn'</span>,</span><br><span class="line">      <span class="string">'complexity'</span>: <span class="string">'warn'</span>,</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 关闭与prettier重复的格式化配置</span></span><br><span class="line">      <span class="string">"semi"</span>: <span class="string">'off'</span>,</span><br><span class="line">      <span class="string">'@typescript-eslint/semi'</span>: <span class="string">'off'</span>,</span><br><span class="line">      <span class="string">'indent'</span>: <span class="string">'off'</span>,</span><br><span class="line">      <span class="string">'@typescript-eslint/indent'</span>: <span class="string">'off'</span>,</span><br><span class="line">      <span class="comment">// 配置部分格式化规则</span></span><br><span class="line">      <span class="string">'array-bracket-spacing'</span>: [<span class="string">'error'</span>, <span class="string">'always'</span>, &#123; </span><br><span class="line">        <span class="string">"singleValue"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"objectsInArrays"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"arraysInArrays"</span>: <span class="literal">false</span> </span><br><span class="line">      &#125;] <span class="comment">// 数组对象内首尾空格</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>prettier主要负责代码风格统一，配置如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="string">"printWidth"</span>: <span class="number">100</span>, <span class="comment">// 一行宽度</span></span><br><span class="line">  <span class="string">"tabWidth"</span>: <span class="number">2</span>, <span class="comment">// 缩进宽度</span></span><br><span class="line">  <span class="string">"semi"</span>: <span class="literal">false</span>, <span class="comment">// 末尾分号</span></span><br><span class="line">  <span class="string">"quoteProps"</span>: <span class="string">"consistent"</span>, <span class="comment">// object中的属性是否需要引号保持一致</span></span><br><span class="line">  <span class="string">"trailingComma"</span>: <span class="string">"es5"</span>, <span class="comment">// 在对象或数组最后一个元素后面是否加逗号（在ES5中加尾逗号）</span></span><br><span class="line">  <span class="string">"bracketSpacing"</span>: <span class="literal">true</span>, <span class="comment">// 对象括号内首尾空格</span></span><br><span class="line">  <span class="string">"arrowParens"</span>: <span class="string">"always"</span>, <span class="comment">// 箭头函数参数需括号</span></span><br><span class="line">  <span class="string">"proseWrap"</span>: <span class="string">"preserve"</span>, <span class="comment">// 代码超出是否要换行 preserve保留</span></span><br><span class="line">  <span class="string">"endOfLine"</span>: <span class="string">"auto"</span>, <span class="comment">// 结尾是 \n \r \n\r auto</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="流程化代码检查和格式化：husky"><a href="#流程化代码检查和格式化：husky" class="headerlink" title="流程化代码检查和格式化：husky"></a>流程化代码检查和格式化：husky</h2><p>为了防止不规范的代码被commit并push到云端，增加了<code>precommit</code>钩子。<br>首先需要安装husky：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">npm install husky --save-dev</span><br><span class="line">```      </span><br><span class="line"></span><br><span class="line">在`package.json`文件中添加脚本，在每次`git commit`前都会先prettier进行格式化，然后用eslint检查语法规范等，最后编译检查：   </span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"script"</span>: &#123;</span><br><span class="line">        <span class="string">"precommit"</span>: <span class="string">"npm run compile"</span>,</span><br><span class="line">        <span class="string">"compile"</span>: <span class="string">"npm run fix:eslint &amp;&amp; npm run fix:prettier &amp;&amp; tsc --skipLibCheck"</span>,</span><br><span class="line">        <span class="string">"fix:eslint"</span>: <span class="string">"eslint \"src/**/*.ts\" --ext .ts --fix"</span>,</span><br><span class="line">        <span class="string">"fix:prettier"</span>: <span class="string">"prettier --config \".prettierrc.js\" --write \"src/**/*.ts\""</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>typescript是一个强类型语言，类型定义是最好的接口文档，对于多人开发/大型项目来说，能够很好的协助开发。   </li><li>从javascript迁移到typescript很容易，即使没有进行任何定义，直接将.js文件重命名为.ts即可，使用JavaScript的大型项目可以很快的迁移到typescript，可以不需要立即重构全部旧代码。   </li><li>使用typescript增加了编译阶段，可以在编译阶段发现大部分可能的错误，但是即便编译出错也可以生成JavaScript文件。   </li><li>typescript入门容易，但是想要用得好比较难。对于一些复杂需求的类型的定义，需要深入研究和探讨。   </li></ol>]]></content>
      
      
      <categories>
          
          <category> 复盘 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析工具项目 </tag>
            
            <tag> 项目复盘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>赶鸭子上架的全栈开发踩坑思考</title>
      <link href="/2019/06/27/%E8%B5%B6%E9%B8%AD%E5%AD%90%E4%B8%8A%E6%9E%B6%E7%9A%84%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91%E8%B8%A9%E5%9D%91%E6%80%9D%E8%80%83/"/>
      <url>/2019/06/27/%E8%B5%B6%E9%B8%AD%E5%AD%90%E4%B8%8A%E6%9E%B6%E7%9A%84%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91%E8%B8%A9%E5%9D%91%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<p>完全赶鸭子上架的全栈开发之旅，过程可以说是很崩溃，做完回顾发现留坑过多，痛定思痛还是要重新整理一下代码结构，复盘整个项目搞清楚到底菜在哪里，下面是此次开发过程中的一些具体问题的总结。   </p><h2 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h2><p>项目名称：数据分析平台<br>项目描述：对活动会场数据进行分析，提供模块化的结论   </p><h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><blockquote><p>框架选用：vue+vuex+vue-router<br>UI框架：element-ui</p></blockquote><h3 id="1-关于在前台页面处理数据"><a href="#1-关于在前台页面处理数据" class="headerlink" title="1. 关于在前台页面处理数据"></a>1. 关于在前台页面处理数据</h3><p><strong>初步考虑</strong>：一开始采用的方案是前台处理excel数据然后post数据到后台存储，主要考量有二，一是去除上传文件这一步骤，简化实现；二是前台对数据表格式进行校验，如果有错误可直接返回，减少不必要的带宽消耗。通过webworker也可以避免浏览器假死。<br><strong>实际问题</strong>：低估了数据量级，实际拿到的excel表甚至超过了10MB，部分sheet甚至达到了百万条数据，浏览器的处理能力和内存有限，出现了<code>out of memory</code>错误。<br><strong>解决方案</strong>：将这一步骤移交给后台处理     </p><h3 id="2-关于vue-router的使用"><a href="#2-关于vue-router的使用" class="headerlink" title="2. 关于vue-router的使用"></a>2. 关于vue-router的使用</h3><p><strong>初步考虑</strong>：PC站点不可避免的有站内导航和跳转，另一方面为了提升体验，页面缓存也是需要的，综上考虑引入了vue-router。    </p><ul><li><p><strong>实际问题01</strong>：贪图方便全员<code>keepAlive</code>了，导致页面缓存多了卡顿，懒惰是原罪<br><strong>解决方案</strong>：去除不必要的keepAlive      </p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router配置</span></span><br><span class="line">&#123; </span><br><span class="line">    path: <span class="string">'/upload'</span>,</span><br><span class="line">    name: <span class="string">'upload'</span>,</span><br><span class="line">    component: DataUpload,</span><br><span class="line">    meta: &#123;</span><br><span class="line">        keepAlive: <span class="literal">true</span> <span class="comment">// 需要被缓存</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    path: <span class="string">'/export'</span>,</span><br><span class="line">    name: <span class="string">'export'</span>,</span><br><span class="line">    component: ReportExport,</span><br><span class="line">    meta: &#123;</span><br><span class="line">        keepAlive: <span class="literal">false</span> <span class="comment">// 不需要被缓存</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入页面</span></span><br><span class="line">&lt;keep-alive&gt;</span><br><span class="line">    &lt;router-view v-<span class="keyword">if</span>=<span class="string">"$route.meta.keepAlive"</span> /&gt;</span><br><span class="line">&lt;<span class="regexp">/keep-alive&gt;</span></span><br><span class="line"><span class="regexp">&lt;router-view v-if="!$route.meta.keepAlive"/</span>&gt;</span><br></pre></td></tr></table></figure></li><li><p><strong>实际问题02</strong>：需要新开页面展示某些信息<br><strong>解决方案</strong>：由于信息量级小，所以最终通过url带参的方式实现，router页面跳转   </p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新开页面</span></span><br><span class="line">router.resolve(&#123;</span><br><span class="line">    name: <span class="string">"show-report-only"</span>,</span><br><span class="line">    query: &#123;</span><br><span class="line">        url: url,</span><br><span class="line">        name: name </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">window</span>.open(href, <span class="string">'_blank'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一种带参跳转（不能新开页面）</span></span><br><span class="line">router.push(&#123; <span class="attr">name</span>: <span class="string">'user'</span>, <span class="attr">params</span>: &#123; <span class="attr">userId</span>: <span class="string">'123'</span> &#125;&#125;) <span class="comment">// 参数存储在内存中，不在url显示</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="3-关于vuex的使用"><a href="#3-关于vuex的使用" class="headerlink" title="3. 关于vuex的使用"></a>3. 关于vuex的使用</h3><p><strong>初步考虑</strong>：前期考虑不足，典型的我坑我自己。现在就是后悔，非常后悔。<br><strong>实际问题</strong>：vuex是在项目进行到一定程度之后才加进去的，整个项目组件之间存在很多的共享信息，包括基础分析数据/页面状态等，当代码量级上去之后，简单的组件之间传值已经无法维持数据共享，而且组件之间的依赖过强，代码可读性严重下降。<br><strong>解决方案</strong>：加入vuex来留存全局的状态信息。   </p><h3 id="4-多复用操作的实现：Vue-directive指令"><a href="#4-多复用操作的实现：Vue-directive指令" class="headerlink" title="4. 多复用操作的实现：Vue.directive指令"></a>4. 多复用操作的实现：Vue.directive指令</h3><p><strong>实际问题</strong>：在实际的实现场景下，有一些功能是基本所有组件都会使用到的，比如说都存在一个按钮，点击之后需要进行一系列类似的操作，这个时候就需要自定义指令上场，避免成为ctrlC/ctrlV工程师。<br><strong>解决方案</strong>：加入自定义指令，统一管理类似的功能，提升可复用性，降低后期修改成本。   </p><h2 id="nodejs后端"><a href="#nodejs后端" class="headerlink" title="nodejs后端"></a>nodejs后端</h2><blockquote><p>框架选用：express<br>代理服务器：nginx   </p></blockquote><h3 id="0-关于框架选择的思考"><a href="#0-关于框架选择的思考" class="headerlink" title="0. 关于框架选择的思考"></a>0. 关于框架选择的思考</h3><p>在做这个项目之前没有正儿八经的用nodejs做后台开发，倒是之前在校期间，用过java和PHP，大概的思路是有的。基于这个前提下，还是保守的选用全家桶型框架express，使用之后感觉确实挺全的，但是有许多功能在实际使用中并不需要，后续考虑迁移到koa瘦个身。   </p><h3 id="1-post大数据超时"><a href="#1-post大数据超时" class="headerlink" title="1. post大数据超时"></a>1. post大数据超时</h3><p><strong>实际问题</strong>：后端最“重”的一个功能就是存数据，正如前端存excel表数据遇到的问题，将excel表上传到后端处理也有类似的问题，数据量过大，处理完成之后还要将几百万条数据存进数据库，容易造成超时，502/504错误。<br><strong>解决方案</strong>：首选优化sql语句，加速处理；目前的快速解决方法是将express的socket连接超时时间。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">socket</span>) </span>&#123;</span><br><span class="line">    socket.setTimeout(<span class="number">30</span> * <span class="number">1000</span>);  <span class="comment">// 超时时间，此处为30s</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p><strong>后续优化</strong>：将接口拆分为2个接口异步操作，一个用于执行处理数据，另一个接口用于获取处理进度。   </p><h3 id="2-涉及文件云存储"><a href="#2-涉及文件云存储" class="headerlink" title="2. 涉及文件云存储"></a>2. 涉及文件云存储</h3><p><strong>前期疏漏</strong>：前期很理所当然的将文件存储在了服务器本地，实际上对于需要长期存储的数据应当有专门的文件服务器来存储，后端逻辑与存储空间应当隔离。<br><strong>解决方案</strong>：使用公司内部的oss存储，该接口必须线上调用，本地调用可能失败或响应时间过长。   </p><h3 id="3-CORS问题"><a href="#3-CORS问题" class="headerlink" title="3. CORS问题"></a>3. CORS问题</h3><p><strong>实际问题</strong>：对于附带身份凭证的请求，服务器端设置<code>Access-Control-Allow-Origin</code>为<code>*</code>无效<br><strong>解决方案</strong>：<code>res.header(&#39;Access-Control-Allow-Origin&#39;, req.header(&#39;origin&#39;));</code>   </p><h3 id="4-关于Docker"><a href="#4-关于Docker" class="headerlink" title="4. 关于Docker"></a>4. 关于Docker</h3><p>作为一个菜鸟完全不知道docker是什么东西怎么用，此次部署是傻瓜式操作，完全是大佬写好的配置文件，直接走平台部署。不懂就要学，先简单的入个门，后续输出一些学习内容出来。<br>目前只是了解了一下<code>Docker</code>是什么，拿来做什么。<code>Docker</code>类似于虚拟机的概念，只是<code>Docker</code>虚拟的是操作系统，它将同一个操作系统上管理的应用隔离开来，可以快速的创建和停止应用，不同应用之间互不影响。   </p><h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><blockquote><p>mysql</p></blockquote><h3 id="1-纯SQL语句与ORM库"><a href="#1-纯SQL语句与ORM库" class="headerlink" title="1. 纯SQL语句与ORM库"></a>1. 纯SQL语句与ORM库</h3><p><strong>实际问题</strong>：我肯定是脑子瓦特了，才会手写SQL，是框架不够好用还是加班不够久。<br><strong>后续改进</strong>：为了后续项目能够更好兼容推进，改用ORM库来重构代码。   </p><h3 id="2-数据库结构设计领悟"><a href="#2-数据库结构设计领悟" class="headerlink" title="2. 数据库结构设计领悟"></a>2. 数据库结构设计领悟</h3><p>数据库真的是一门走一步要看三步的活计，前期设计作死在后面都是要还的。这一次设计过程中，又由于需求频繁变动，导致数据库修改避无可避，产生了一些非专业的感悟：   </p><ul><li>慎用自增ID，尤其是对于需要更新的数据，对于一些无法用单一字段作为<code>primary key</code>的表，可以考虑多个字段通过md5之类的加密算法，生成唯一的ID作为<code>primary key</code>。   </li><li>在前期需求不明朗，或者说项目最开始设计的时候，字段最好不要做过多的限制，比如说枚举类型，可以用tinyint来替代，后续如果有增减也不需要修改。   </li><li>前期慎重使用<code>unique</code>或<code>foreign key</code>之类的限制性功能，后期需求谁也说不准，很容易翻车。另外如外键之类的功能也降低了数据添加的可控性。      </li><li>避免或尽量减少对一些较为特殊的内置字段类型/内置方法的使用，比如mysql的enum类型可以用varchar类型代替，timestamp类型可以用bigint存储时间戳代替，主要是考虑后续可能需要对多种数据库进行兼容。   </li></ul>]]></content>
      
      
      <categories>
          
          <category> 复盘 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析工具项目 </tag>
            
            <tag> 项目复盘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phaser2-&gt;3：来个打地鼠试水</title>
      <link href="/2019/06/25/phaser2-%3E3%EF%BC%9A%E6%9D%A5%E4%B8%AA%E6%89%93%E5%9C%B0%E9%BC%A0%E8%AF%95%E6%B0%B4/"/>
      <url>/2019/06/25/phaser2-%3E3%EF%BC%9A%E6%9D%A5%E4%B8%AA%E6%89%93%E5%9C%B0%E9%BC%A0%E8%AF%95%E6%B0%B4/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文中phaser具体版本<br>    phaser2：2.8.1<br>    phaser3：3.17.0</p></blockquote><p><a href="#param1">一、实现效果</a><br><a href="#param2">二、实现细节</a><br><a href="#param3">三、项目总结</a><br><a href="#param4">四、参考文档</a>   </p><h2 id="一、实现效果"><a href="#一、实现效果" class="headerlink" title="一、实现效果"></a><i id="param1"></i>一、实现效果</h2><p><img src="https://img13.360buyimg.com/imagetools/jfs/t29857/279/1583344553/266188/c4b33b93/5ce4fca2N40bc5de6.gif" alt="效果图片"><br><img src="https://img14.360buyimg.com/imagetools/jfs/t1/67216/40/2877/17289/5d11d9f2E323511f3/e4ea982897f63823.png" alt="体验地址"><br><a href="https://github.com/winniecjy/phaser-dadishu/" target="_blank" rel="noopener">源码地址(phaser2&amp;phaser3)：https://github.com/winniecjy/phaser-dadishu/</a><br><a href="https://winniecjy.github.io/phaser-dadishu/ver-phaser2/dist/" target="_blank" rel="noopener">体验地址：https://winniecjy.github.io/phaser-dadishu/ver-phaser2/dist/</a>   </p><h2 id="二、实现细节"><a href="#二、实现细节" class="headerlink" title="二、实现细节"></a><i id="param2"></i>二、实现细节</h2><p>这个demo其实是之前学习phaser2的时候做的，现在用来改成phaser3，刚好可以接触一下新的API变动有多大。<br>按照游戏实现的逻辑顺序，下面捋一捋用到的Phaser3 API，同时也与Phaser2 API进行简单对比。     </p><h3 id="第一步：初始化游戏new-Phaser-Game"><a href="#第一步：初始化游戏new-Phaser-Game" class="headerlink" title="第一步：初始化游戏new Phaser.Game"></a>第一步：初始化游戏<code>new Phaser.Game</code></h3><p>初始化画布参数，包括画布宽高，渲染方式，并将其插入dom结构中。phaser3中用scenes替代了phaser2中的states，为了避免与state machines概念混淆。<br>游戏中的一个scene是一个独立的场景，拥有自己的独立资源，包括相机系统、显示列表、更新步骤、事件处理、物理系统等等。游戏一次只能执行一个scene，一个场景通过多个钩子函数来维护，包括init、preload、create、update等。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phaser 3：https://photonstorm.github.io/phaser3-docs/Phaser.Types.Core.html#.GameConfig</span></span><br><span class="line">conf = &#123;</span><br><span class="line">  width: <span class="number">750</span>, </span><br><span class="line">  height: <span class="number">750</span>/<span class="built_in">window</span>.innerWidth*<span class="built_in">window</span>.innerHeight,</span><br><span class="line">  type: Phaser.AUTO, <span class="comment">// 渲染方法</span></span><br><span class="line">  parent: <span class="string">'container'</span>, <span class="comment">// 将包含游戏画布的dom元素</span></span><br><span class="line">  backgroundColor: <span class="string">'#f9c04c'</span>, </span><br><span class="line">  scale: &#123;</span><br><span class="line">      mode: Phaser.Scale.FIT <span class="comment">// 缩放模式，此处按比例调整画布大小，相当于contain</span></span><br><span class="line">  &#125;,</span><br><span class="line">  scene: &#123; <span class="comment">// 初始化场景，游戏最开始状态</span></span><br><span class="line">    init: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="comment">// 当场景开始时第一个执行，可以用于初始化变量或重定向到其他场景 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    preload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="comment">// 第二个执行的函数，预加载游戏资源，不会在这里创建对象 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 当preload完成之后执行，preload的资源加载完成，可以在这里创建对象 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    update: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="comment">// 画布更新，在游戏的每一帧都执行 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...... 其他函数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">game = <span class="keyword">new</span> Phaser.Game(conf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// phaser 2：http://phaser.io/docs/2.6.2/Phaser.Game.html</span></span><br><span class="line">game = <span class="keyword">new</span> Phaser.Game(<span class="number">750</span>, <span class="number">750</span>/<span class="built_in">window</span>.innerWidth*<span class="built_in">window</span>.innerHeight, Phaser.AUTO, <span class="string">'container'</span>, </span><br><span class="line">  &#123; <span class="comment">// 初始化场景，游戏最开始状态</span></span><br><span class="line">    init: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="comment">// 当场景开始时第一个执行，可以用于初始化变量或重定向到其他场景 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    preload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="comment">// 第二个执行的函数，预加载游戏资源，不会在这里创建对象 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 当preload完成之后执行，preload的资源加载完成，可以在这里创建对象 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    update: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="comment">// 画布更新，在游戏的每一帧都执行 </span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...... 其他函数</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></p><h3 id="第二步：预加载资源"><a href="#第二步：预加载资源" class="headerlink" title="第二步：预加载资源"></a>第二步：预加载资源</h3><p>预加载资源操作一般在<code>preload</code>函数中执行，这一部分的API，phaser2和phaser3基本一致，不过phaser3对游戏对象结构进行了修改，phaser2中是树状结构，游戏中所有对象都来自于根对象<code>Phaser.Game</code>，对象也拥有自己的子对象。phaser3中将这些对象拆解出来，游戏对象<code>Phaser.Game</code>不包含其他对象组，且对象组不具有任何的位置或者属性。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phaser3: https://photonstorm.github.io/phaser3-docs/Phaser.Loader.LoaderPlugin.html</span></span><br><span class="line">preload: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"start loading ..."</span>);</span><br><span class="line">    <span class="keyword">this</span>.numbersJson = <span class="built_in">require</span>(<span class="string">'../json/numbers.json'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// loader挂载在Phaser.Scene下</span></span><br><span class="line">    <span class="keyword">this</span>.load.image(<span class="string">'bg'</span>, <span class="string">'./img/holes-bg.png'</span>);</span><br><span class="line">    <span class="keyword">this</span>.load.image(<span class="string">'hamster'</span>, <span class="string">'./img/hamster.png'</span>);</span><br><span class="line">    <span class="keyword">this</span>.load.image(<span class="string">'hammer'</span>, <span class="string">'./img/hammer.png'</span>);</span><br><span class="line">    <span class="keyword">this</span>.load.image(<span class="string">'lightning'</span>, <span class="string">'./img/lightning.png'</span>);</span><br><span class="line">    <span class="keyword">this</span>.load.atlas(<span class="string">'sprite_numbers'</span>, <span class="string">'./img/numbers.png'</span>, <span class="keyword">this</span>.numbersJson);</span><br><span class="line">    <span class="keyword">this</span>.load.on(<span class="string">'complete'</span>, loadProgress);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loadProgress</span>(<span class="params">loader, finishedNum</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;finishedNum&#125;</span>个资源加载完毕，可以开始游戏了！`</span>);</span><br><span class="line">        $(<span class="string">".cjy_panel .start_btn"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 移除开始界面</span></span><br><span class="line">            $(<span class="string">".cjy_panel"</span>).hide();</span><br><span class="line">            customGame.scene.start(<span class="string">'play'</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// phaser2: http://phaser.io/docs/2.6.2/Phaser.Loader.html</span></span><br><span class="line">preload: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"start loading ..."</span>);</span><br><span class="line">  <span class="keyword">this</span>.numbersJson = <span class="built_in">require</span>(<span class="string">'../json/numbers.json'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">window</span>.customGame)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 这些属性在Phaser3中已被移除，需要通过初始化配置</span></span><br><span class="line">  <span class="built_in">window</span>.customGame.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;</span><br><span class="line">  <span class="built_in">window</span>.customGame.stage.backgroundColor = <span class="string">'#f9c04c'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loader挂载在Phaser.game下</span></span><br><span class="line">  <span class="built_in">window</span>.customGame.load.image(<span class="string">'bg'</span>, <span class="string">'./img/holes-bg.png'</span>);</span><br><span class="line">  <span class="built_in">window</span>.customGame.load.image(<span class="string">'hamster'</span>, <span class="string">'./img/hamster.png'</span>);</span><br><span class="line">  <span class="built_in">window</span>.customGame.load.image(<span class="string">'hammer'</span>, <span class="string">'./img/hammer.png'</span>);</span><br><span class="line">  <span class="built_in">window</span>.customGame.load.image(<span class="string">'lightning'</span>, <span class="string">'./img/lightning.png'</span>);</span><br><span class="line">  <span class="built_in">window</span>.customGame.load.atlasJSONHash(<span class="string">'sprite_numbers'</span>, <span class="string">'./img/numbers.png'</span>, <span class="string">''</span>, <span class="keyword">this</span>.numbersJson);</span><br><span class="line">  <span class="built_in">window</span>.customGame.load.onLoadComplete.add(loadProgress, <span class="keyword">this</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadProgress</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'资源加载完毕，可以开始游戏啦！'</span>)</span><br><span class="line">    $(<span class="string">".cjy_panel .start_btn"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"开始游戏！"</span>);</span><br><span class="line">        <span class="comment">// 移除开始界面</span></span><br><span class="line">        $(<span class="string">".cjy_panel"</span>).hide();</span><br><span class="line">        customGame.state.start(<span class="string">'play'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="第三步：创建对象"><a href="#第三步：创建对象" class="headerlink" title="第三步：创建对象"></a>第三步：创建对象</h3><p>创建对象操作一般在<code>create</code>函数中执行，这一部分的API基本一致，差别与<code>load</code>相似，都是由于修改了整体数据结构导致的。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phaser3: https://photonstorm.github.io/phaser3-docs/Phaser.GameObjects.GameObjectCreator.html</span></span><br><span class="line"><span class="comment">// 对象的创建</span></span><br><span class="line"><span class="keyword">this</span>.hammer = <span class="keyword">this</span>.add.sprite(hammerx, hammery, <span class="string">'hammer'</span>).setOrigin(<span class="number">0</span>, <span class="number">0.8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// phaser2: http://phaser.io/docs/2.6.2/Phaser.GameObjectFactory.html</span></span><br><span class="line"><span class="keyword">this</span>.hammer = customGame.add.sprite(hammerx, hammery, <span class="string">'hammer'</span>);</span><br><span class="line"><span class="keyword">this</span>.hammer.anchor.setTo(<span class="number">0</span>, <span class="number">0.8</span>);</span><br></pre></td></tr></table></figure></p><h3 id="第四步：动画"><a href="#第四步：动画" class="headerlink" title="第四步：动画"></a>第四步：动画</h3><p>phaser2和phaser3都提供了内置tween动画供开发者使用，相比较于phaser2，phaser3中的tween动画配置更加灵活丰富，具体完整的配置项列表可以参照<a href="https://photonstorm.github.io/phaser3-docs/Phaser.Types.Tweens.html#.TweenBuilderConfig" target="_blank" rel="noopener">官方文档</a>。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phaser3: https://photonstorm.github.io/phaser3-docs/Phaser.Tweens.TweenManager.html</span></span><br><span class="line"><span class="keyword">this</span>.tweens.add(&#123;</span><br><span class="line">  targets: [<span class="keyword">this</span>.hammer],</span><br><span class="line">  angle: <span class="number">45</span>,</span><br><span class="line">  duration: <span class="number">50</span>,</span><br><span class="line">  callbackScope: <span class="keyword">this</span>,</span><br><span class="line">  ease: <span class="string">'Linear'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// phaser2: http://phaser.io/docs/2.6.2/Phaser.Tween.html</span></span><br><span class="line"><span class="keyword">var</span> rotateTween = customGame.add.tween(<span class="keyword">this</span>.hammer);</span><br><span class="line">rotateTween.to(&#123;</span><br><span class="line">    angle: <span class="number">45</span></span><br><span class="line">&#125;, <span class="number">50</span>, Phaser.Easing.Cubic.In, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure></p><h3 id="第五步：交互行为"><a href="#第五步：交互行为" class="headerlink" title="第五步：交互行为"></a>第五步：交互行为</h3><p>phaser本身没有dom概念，所有的交互都需要依赖phaser自身的API，通过<code>Phaser.Input</code>统一管理所有的input事件。当交互发生时，与之交互的<code>Phaser.Game</code>对象将向下分发事件，phaser3可以在scene/gameObject中监听该事件，不同的位置监听事件其作用域不同，优先级也不同，优先级较高的事件处理器可阻止向低优先级事件传递（stop propagation）。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phaser3: https://photonstorm.github.io/phaser3-docs/Phaser.Input.Events.html</span></span><br><span class="line"><span class="keyword">this</span>.input.on(<span class="string">'pointerdown'</span>, onTap, <span class="keyword">this</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onTap</span>(<span class="params">pointer,currentlyOver</span>) </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// phaser2: http://phaser.io/docs/2.6.2/Phaser.Input.html</span></span><br><span class="line">customGame.input.onTap.add(onTap, <span class="keyword">this</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onTap</span>(<span class="params">pointer, doubleTap</span>) </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure></p><h3 id="第六步：计时器"><a href="#第六步：计时器" class="headerlink" title="第六步：计时器"></a>第六步：计时器</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phaser3: https://photonstorm.github.io/phaser3-docs/Phaser.Time.TimerEvent.html</span></span><br><span class="line"><span class="keyword">this</span>.time.addEvent(&#123;</span><br><span class="line">  loop: <span class="literal">true</span>,</span><br><span class="line">  delay: <span class="number">1000</span>,</span><br><span class="line">  callback: timerFn,</span><br><span class="line">  callbackScope: <span class="keyword">this</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// phaser2: http://phaser.io/docs/2.6.2/Phaser.Timer.html#loop</span></span><br><span class="line">customGame.time.events.loop(Phaser.Timer.SECOND, <span class="keyword">this</span>.timerFn, <span class="keyword">this</span>); <span class="comment">//利用时钟对象来重复产生管道</span></span><br><span class="line">customGame.time.events.start();</span><br></pre></td></tr></table></figure><h2 id="三、项目总结"><a href="#三、项目总结" class="headerlink" title="三、项目总结"></a><i id="param3"></i>三、项目总结</h2><p>一些可以改进优化的细节：     </p><ul><li>【前端】资源预加载与游戏过程应当在同一个scene中，之前没捋清楚逻辑，把这两个步骤拆开了    </li><li>【交互】疯狂点击页面会出现很多个小锤子，短时间内多次点击应该只响应一次</li><li>【交互】打到地鼠时的反馈感加强，比如地鼠有晕眩动效/音效提示/+1效果等等   </li><li>【玩法】地鼠出现时间越来越快   </li><li>【玩法】主角多样化，除了地鼠还可以有炸弹/手拿礼物的地鼠/其他道具，分数不同     </li></ul><p>phaser2上手较快，API简单，官方文档示例比较丰富，值得继续探索，后续会试水一下物理引擎。phaser3是正在开发的版本，相较于phaser2 API变化较多，文档完善度不够，基本上是查源码猜API。试水过程可以感受到phaser3对API设计重新考量，比如用对象来代替原有的基本数据类型作为函数参数，可读性和灵活性更佳。另外，phaser3增强了camera的功能，新增了对Matter.js物理引擎的支持，对2D骨骼动画的支持等等，此处不进行赘述，详细的可以查看phaser官网的具体公告，或者是参考文章 <a href="https://aotu.io/notes/2018/12/23/phaser3/" target="_blank" rel="noopener">全新Phaser3游戏引擎特性一览（来自凹凸实验室）</a> 。<br>关于自学：个人觉得phaser API的学习方法最直观的是在控制台打印一下，尤其是对于初学者来说，对于其中的结构没有清晰的认识，直接看文档容易混乱，具体使用也可以参照<a href="https://labs.phaser.io/" target="_blank" rel="noopener">官方示例</a>。<br>彩虹屁结束之后，不得不说，如果是项目实际使用，建议还是使用稳定版本phaser2，简单的小游戏还是够用的。   </p><h2 id="六、参考文档"><a href="#六、参考文档" class="headerlink" title="六、参考文档"></a><i id="param4"></i>六、参考文档</h2><ol><li><a href="http://phaser.io/" target="_blank" rel="noopener">Phaser官网：http://phaser.io/</a></li><li><a href="http://phaser.io/docs/2.6.2/index" target="_blank" rel="noopener">Phaser2 API文档：http://phaser.io/docs/2.6.2/index</a></li><li><a href="https://photonstorm.github.io/phaser3-docs/" target="_blank" rel="noopener">Phaser3 API文档：https://photonstorm.github.io/phaser3-docs/</a></li><li><a href="https://labs.phaser.io/" target="_blank" rel="noopener">Phaser3官方示例：https://labs.phaser.io/</a></li><li><a href="https://aotu.io/notes/2018/12/23/phaser3/" target="_blank" rel="noopener">全新Phaser3游戏引擎特性一览：https://aotu.io/notes/2018/12/23/phaser3/</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 深入学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小项目 </tag>
            
            <tag> phaser </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>优化动画卡顿：卡顿原因分析及优化方案</title>
      <link href="/2019/03/14/%E4%BC%98%E5%8C%96%E5%8A%A8%E7%94%BB%E5%8D%A1%E9%A1%BF%EF%BC%9A%E5%8D%A1%E9%A1%BF%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/"/>
      <url>/2019/03/14/%E4%BC%98%E5%8C%96%E5%8A%A8%E7%94%BB%E5%8D%A1%E9%A1%BF%EF%BC%9A%E5%8D%A1%E9%A1%BF%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul><li><a href="#1">一、动画卡顿分析</a><ul><li><a href="#1-0">动画卡顿的原因</a></li><li><a href="#1-1">页面渲染流程</a></li></ul></li><li><a href="#2">二、优化方法</a><ul><li><a href="#2-0"><code>JavaScript</code>：优化JavaScript的执行效率</a></li><li><a href="#2-1"><code>Style</code>：降低样式计算复杂度和范围</a></li><li><a href="#2-2"><code>Layout</code>：避免大规模、复杂的布局</a></li><li><a href="#2-3"><code>Paint/Composite</code>：GPU加速</a></li></ul></li><li><a href="#3">三、参考</a></li></ul><h1 id="一、动画卡顿分析"><a href="#一、动画卡顿分析" class="headerlink" title="一、动画卡顿分析"></a><span id="1">一、动画卡顿分析</span></h1><h2 id="动画卡顿的原因"><a href="#动画卡顿的原因" class="headerlink" title="动画卡顿的原因"></a><span id="1-0">动画卡顿的原因</span></h2><p>大多数设备的刷新频率是60次/秒，也就是1秒钟的动画是由60个画面连在一起生成的，所以要求浏览器对每一帧画面的渲染工作要在16ms内完成。当渲染时间超出16ms时，1秒钟内少于60个画面生成，就会有不连贯、卡顿的感觉，影响用户体验。</p><h2 id="页面渲染流程"><a href="#页面渲染流程" class="headerlink" title="页面渲染流程"></a><span id="1-1">页面渲染流程</span></h2><p>一个页面帧在客户端的渲染分为以下几步：<br><img src="https://img14.360buyimg.com/imagetools/jfs/t1/25420/23/7433/43692/5c6bc518E8ebc6723/1ba7bf69d1e49c34.png" alt="页面渲染流程 来源：Google">     </p><ol><li><code>JavaScript</code>：JavaScript实现动画效果，DOM操作等。   </li><li><code>Style（样式计算）</code>：确认每个DOM元素应用的CSS样式规则。   </li><li><code>Layout（布局）</code>：计算每个DOM元素最终在屏幕上的大小和位置。由于DOM元素的布局是相对的，所以当某个元素发生变化影响了布局时，其他元素也会随之变化，则需要回退重新渲染，这个过程称之为reflow。   </li><li><code>Paint（绘制）</code>：在多个层上绘制DOM元素的文字、颜色、图像、边框和阴影等。   </li><li><code>Composite（Render Layer合并）</code>：按照合理的顺序合并图层并显示到屏幕上。<br>浏览器在实际渲染页面的时候需要经过一系列的映射，由HTML页面构建出来的DOM树到最终的图层，映射过程如下图(来源：<a href="#3">参考[3]</a>)所示（注意下图类名在后续有所更改，RenderObject-&gt;LayoutObject，RenderLayer-&gt;PaintLayer）：<br><img src="https://img14.360buyimg.com/imagetools/jfs/t1/19835/12/10577/51755/5c88750fE37bd3acb/f2f49b172da86e5a.png" alt="The Compositing Tree"></li></ol><ul><li><strong>Node-&gt;RenderObject</strong>：DOM树的每个Node都有一个对应的RenderObject（一对一关系，RenderObject包含了Node的内容）；   </li><li><p><strong>RenderObject -&gt; RenderLayer</strong>：一个或多个RenderObject对应一个RenderLayer（多对一），RenderLayer用于保证元素之间的层级关系，一般来说位于同一位置的且层级相同的元素位于同一个Render Layer，只有某些特殊的RenderObject会专门创建一个新的渲染层，其他的RenderObject与第一个拥有RenderLayer的祖先元素共用一个。常见的生成RenderLayer的RenderObject拥有以下的一种特征<a href="#3">参考[3]</a>： </p><ul><li>页面根元素</li><li>有CSS定位属性（relative, absolute, fixed, sticky）    </li><li>transparent不为1</li><li>overflow不为visible</li><li>有CSS mask属性</li><li>有CSS box-reflect属性</li><li>有CSS filter属性</li><li>3D或硬件加速的2D canvas元素</li><li>video元素</li></ul></li><li><p><strong>RenderLayer -&gt; GraphicsLayer</strong>：一个或多个RenderLayer对应一个GraphicsLayer（多对一），某些被认为是Compositing Layer的RenderLayer单独对应一个GraphicsLayer，其他RenderLayer与第一个拥有GraphicsLayer的祖先元素共用一个GraphicsLayer。每个GraphicsLayer有一个GraphicsContext用于绘制其对应的RenderLayers，合成器将GraphicsContexts的位图合成，最终显示到屏幕上。渲染层提升为合成层的原因如下：   </p><ul><li>有3D transform属性</li><li>有perspective属性</li><li>3D canvas或硬件加速的2D canvas</li><li>硬件加速的iframe元素（如iframe嵌入的页面有合成层，合成层需要硬件加速）</li><li>使用了硬件加速的插件，如flash</li><li>对opacity/transform属性应用了animation/transition（当animation/transition为active）   </li><li>子元素是compositing layer</li><li>兄弟元素是compositing layer，与当前的非composting layer有重叠，层级低于当前层</li><li>有will-change属性       </li></ul></li></ul><h1 id="二、优化方法"><a href="#二、优化方法" class="headerlink" title="二、优化方法"></a><span id="2">二、优化方法</span></h1><p>在网上可以看到很多的优化方案总结，大佬们都写的很好。   </p><blockquote><p>Talk is cheap. Show me the code.    </p></blockquote><p>结合页面渲染流程，这里将结合一些测试代码，分析动画的各种优化方案和效果：   </p><ul><li><code>JavaScript</code>：优化JavaScript的执行效率<ul><li><code>requestAnimationFrame</code>代替<code>setTimeout</code>和<code>setInterval</code></li><li>可并行的DOM元素更新划分为多个小任务</li><li>DOM无关的耗时操作放到<code>Web Workers</code>中</li></ul></li><li><code>Style</code>：降低样式计算复杂度和范围<ul><li>降低样式选择器的复杂度</li><li>减少需要执行样式计算的元素个数   </li></ul></li><li><code>Layout</code>：避免大规模、复杂的布局<ul><li>避免频繁改变布局</li><li>用flexbox布局替代老的布局模型</li><li>避免强制同步布局事件</li></ul></li><li><code>Paint/Composite</code>：GPU加速<ul><li>将移动或渐变元素由渲染层（RenderLayer）提升为合成层（Compositing Layer）</li><li>避免提升合成层的陷阱</li></ul></li></ul><h2 id="JavaScript：优化JavaScript的执行效率"><a href="#JavaScript：优化JavaScript的执行效率" class="headerlink" title="JavaScript：优化JavaScript的执行效率"></a><span id="2-0"><code>JavaScript</code>：优化JavaScript的执行效率</span></h2><h3 id="1-requestAnimationFrame代替setTimeout和setInterval"><a href="#1-requestAnimationFrame代替setTimeout和setInterval" class="headerlink" title="1. requestAnimationFrame代替setTimeout和setInterval"></a>1. <code>requestAnimationFrame</code>代替<code>setTimeout</code>和<code>setInterval</code></h3><p><strong>为什么<code>setTimeout</code>和<code>setInterval</code>不好？</strong><br>由于js是单线程执行，所以为了防止某个任务执行时间过长而导致进程阻塞，js中存在异步队列的概念，对于如<code>setTimeout</code>和<code>ajax</code>请求都是把进程放到了异步队列中，当主进程为空时才执行异步队列中的任务。所以 <code>setTimeout</code>和<code>setInterval</code>无法保证回调函数的执行时机，可能会在一帧之内执行多次导致多次页面渲染，浪费CPU资源甚至产生卡顿，或者是在一帧即将结束时执行导致重新渲染，出现掉帧的情况。<br><strong><code>requestAnimationFrame</code>是怎么优化的？</strong></p><ul><li>CPU节能，当页面被隐藏或最小化时，暂停渲染。   </li><li>函数节流，其循环间隔是由屏幕刷新频率决定的，保证回调函数在屏幕的每一次刷新间隔中只执行一次。    </li></ul><p><strong>优化效果具体如何？</strong><a href="https://codepen.io/JoeyCai/pen/XOwXwy" target="_blank" rel="noopener">DEMO</a><br>    通过chrome的performance面板查看具体表现的差别。<br>    通过<code>setTimeout</code>进行了3次渲染，而且有长时间帧出现：<br>    <img src="https://img10.360buyimg.com/imagetools/jfs/t1/9752/6/14504/771355/5c6e8e33Eb93736f4/0b5cb0adc3ea5c8f.jpg" alt="setTimeout"><br>    使用<code>requestAnimationFrame</code>DOM操作部分合并，只进行了2次渲染，长时间帧也被优化：<br>    <img src="https://img13.360buyimg.com/imagetools/jfs/t1/32704/5/2719/675214/5c6e8e33Ed56b5b04/bf06524cbff562cc.jpg" alt="requestAnimationFrame">   </p><h3 id="2-DOM无关的耗时操作放到Web-Worker中"><a href="#2-DOM无关的耗时操作放到Web-Worker中" class="headerlink" title="2. DOM无关的耗时操作放到Web Worker中"></a>2. DOM无关的耗时操作放到<code>Web Worker</code>中</h3><p><strong><code>Web Worker</code>的好处是什么？</strong><br>JavaScript是单线程的，如果频繁的进行耗时操作（如实时更新数据），就会造成拥堵，影响用户交互体验。<code>Web Worker</code>的作用在于为JavaScript创建了多线程环境，worker线程在后台运行，受主线程控制，两者互不干扰。worker线程负担高延迟且UI无关的任务，主线程负责UI交互就会相对流畅。<br><strong>需要注意</strong>   </p><ul><li><code>Web Worker</code>无法操作DOM，本质上只是将数据刷新和页面渲染拆开执行。</li><li><code>Web Worker</code>遵循同源策略且限制本地访问。</li><li>用一次多余的网络请求和浏览器线程资源来换取高效执行。    </li></ul><p><strong>优化效果具体如何？</strong><a href="https://codepen.io/JoeyCai/project/editor/ZqandE" target="_blank" rel="noopener">DEMO</a><br>可以通过chrome的performance面板查看具体表现的差别：<br>不使用<code>web worker</code>，减少了一次网络请求，但是出现了长时间帧，有卡帧的风险。<br><img src="https://img12.360buyimg.com/imagetools/jfs/t1/25172/28/8409/564851/5c74ec5eE57284d6e/df0bcd6f3351087f.jpg" alt="不使用worker"><br>使用了<code>web worker</code>之后，耗时操作无关的任务不再被阻塞，但是增加了网络延迟。如果在项目中使用worker，初始化时间需要好好斟酌。<br><img src="https://img13.360buyimg.com/imagetools/jfs/t1/17237/39/8303/651249/5c74eccfE8c9bdbd6/d408441c34165184.jpg" alt="使用worker"></p><p><strong>可考虑的应用场景</strong>  </p><ul><li>轮询服务器获取数据   </li><li>频繁的数据上报   </li><li>耗时的数据处理</li></ul><h2 id="Style：降低样式计算复杂度和范围"><a href="#Style：降低样式计算复杂度和范围" class="headerlink" title="Style：降低样式计算复杂度和范围"></a><span id="2-1"><code>Style</code>：降低样式计算复杂度和范围</span></h2><h3 id="1-降低样式选择器的复杂度？"><a href="#1-降低样式选择器的复杂度？" class="headerlink" title="1. 降低样式选择器的复杂度？"></a>1. <em>降低样式选择器的复杂度？</em></h3><p>降低样式选择器的复杂度是常常被提出的一个优化方法，实际上这个方法的效果比较微弱，根据Ivan Curic的文章<a href="#refs-5">[5]</a>的测试方法(<a href="https://codepen.io/ivancuric/pen/ZaWxqV" target="_blank" rel="noopener">DEMO</a>)，在一个拥有50000个节点的页面中，不同选择器复杂度对于性能的影响不会超过20ms，而一般情况下，页面的节点数都不会达到这个数量。<br>优化效果微弱的原因在于浏览器引擎对选择器速度进行了优化，不同引擎的性能优化方案不同，所以开发者的优化是否有效是难以预测的，至少对于静态元素的优化性价比是极低的。<br>通过测试可以确认的一点是，应当<strong>减少伪类选择器和过长的选择器的使用</strong>。推荐按照如OOCSS、BEM等命名规范来组织CSS，优点是在微弱优化性能的同时也提高了代码可维护性。   </p><h3 id="2-减少需要执行样式计算的元素个数"><a href="#2-减少需要执行样式计算的元素个数" class="headerlink" title="2. 减少需要执行样式计算的元素个数"></a>2. 减少需要执行样式计算的元素个数</h3><p>这一点是针对较早的浏览器而言，较早的浏览器如改变了<code>body</code>元素上的一个类，则其子元素都需要重新计算样式。<br>现代浏览器都进行了优化，所以优化效果要视具体应用场景而言。目前尚未挖掘到应用例子，后期如有发现回来填坑。  </p><h2 id="Layout：避免大规模、复杂的布局"><a href="#Layout：避免大规模、复杂的布局" class="headerlink" title=" Layout：避免大规模、复杂的布局"></a><span id="2-2"> <code>Layout</code>：避免大规模、复杂的布局</span></h2><h3 id="1-避免频繁触发布局"><a href="#1-避免频繁触发布局" class="headerlink" title="1. 避免频繁触发布局"></a>1. 避免频繁触发布局</h3><p>不同的属性导致的渲染成本不尽相同，这一点在css动画时对比尤其明显。触发layout或者paint的动画属性尤其消耗性能，所以应当尽量使用<code>transform</code>和<code>opacity</code>作为动画属性，如果无法实现则考虑采用JavaScript实现动画。<br><strong>性能差别有多大？</strong><br>以width和transform为例，分别实现动画的性能差别：<a href="https://codepen.io/JoeyCai/pen/BbNavp" target="_blank" rel="noopener">DEMO</a><br>通过width实现动画，帧率较低且曲线抖动明显，右下角也给出了一帧的渲染过程，触发了样式计算，布局，绘制和渲染层合并：<br><img src="https://img14.360buyimg.com/imagetools/jfs/t1/9917/2/15827/442526/5c764912E4a21de39/cc6866d97ec11f1b.png" alt="width实现动画"><br>通过transform实现动画，可以发现帧率虽然也低但是平稳，渲染过程只触发了样式计算和、绘制和渲染层合并（仅当元素为合成层时，不会触发绘制。后面将详细讲述）：<br><img src="https://img14.360buyimg.com/imagetools/jfs/t1/17764/7/8535/398481/5c7648c0Ee511a7d1/6233890c687bb85b.png" alt="transform实现动画"></p><h3 id="2-用flexbox布局替代老的布局模型"><a href="#2-用flexbox布局替代老的布局模型" class="headerlink" title="2. 用flexbox布局替代老的布局模型"></a>2. 用flexbox布局替代老的布局模型</h3><p>常用的经典布局方案有基于浮动的布局、基于绝对定位的布局，flexbox布局相较而言更加高效。在能用flexbox布局的项目中，尽量用flexbox布局。以下<a href="https://codepen.io/JoeyCai/pen/vPLWjQ" target="_blank" rel="noopener">DEMO</a>尝试用三种布局方式渲染一样的界面效果来测试性能：<br>绝对布局：对于每一个元素都需要唯一的定位坐标，当元素较多时，CSS文件偏大，导致在样式计算上花费了较多的时间。<br><img src="https://img13.360buyimg.com/imagetools/jfs/t1/18552/10/8755/413725/5c78fed1E451f7fbc/a912ac13678feb3a.jpg" alt="绝对布局"><br>浮动布局：浮动元素之间定位会互相影响，部分浮动元素也受到文档流影响，导致布局所需时间较长。<br><img src="https://img11.360buyimg.com/imagetools/jfs/t1/8544/17/15769/406636/5c78fe8bEa78f88e3/e40a0d94beed9025.jpg" alt="浮动布局"><br>弹性布局：对比前两种布局方案而言，性能有较显著的提升。<br><img src="https://img11.360buyimg.com/imagetools/jfs/t1/14490/38/8676/397959/5c78feb7E45544822/0308de0c0c8a7317.jpg" alt="弹性布局">   </p><h3 id="3-避免强制同步布局事件"><a href="#3-避免强制同步布局事件" class="headerlink" title="3. 避免强制同步布局事件"></a>3. 避免强制同步布局事件</h3><p><strong>什么是强制同步布局？</strong><br>前面提到了页面渲染流程是JavaScript-&gt;Style-&gt;Layout-&gt;Paint-&gt;Composite，强制同步布局就是强制浏览器在执行JavaScript脚本前先执行布局。<br><strong>什么情况会导致强制同步布局？</strong><br>JavaScript运行时，获取到的元素属性样式都是上一帧的数值，所以如果在当前帧的渲染流程中，获取当前帧的某个元素属性之前对该元素进行了修改，浏览器就必须先应用属性再执行JavaScript逻辑，简而言之就是DOM先写后读操作，尤其是连续的读写操作，对浏览器的性能影响更大。<br><strong>对性能影响有多大？</strong><a href="https://codepen.io/JoeyCai/pen/NJryQz" target="_blank" rel="noopener">DEMO</a><br>DEMO通过改变1000个节点的属性，测试强制同步布局事件对性能的影响，具体参照下图。可以发现性能的损耗是极大的，连续的读写操作导致连续的强制同步事件触发，JavaScript执行时间变得很长：<br><img src="https://img11.360buyimg.com/imagetools/jfs/t1/20407/22/9210/435015/5c7cd4a7E5ec454a1/814a3da7231f7e94.jpg" alt="强制同步布局"></p><h2 id="Paint-Composite：GPU加速"><a href="#Paint-Composite：GPU加速" class="headerlink" title="Paint/Composite：GPU加速"></a><span id="2-3"><code>Paint/Composite</code>：GPU加速</span></h2><h3 id="1-将移动或渐变元素由渲染层（RenderLayer）提升为合成层（Compositing-Layer）"><a href="#1-将移动或渐变元素由渲染层（RenderLayer）提升为合成层（Compositing-Layer）" class="headerlink" title="1. 将移动或渐变元素由渲染层（RenderLayer）提升为合成层（Compositing Layer）"></a>1. 将移动或渐变元素由渲染层（RenderLayer）提升为合成层（Compositing Layer）</h3><p><em>注：可在Chrome的开发者工具的layers面板查看合成层，layers面板打开方法command+shift+p(mac)/ctrl+shift+p(windows) -&gt; show layers</em><br>将复杂/频繁变化的元素提升到合成层，这样的好处是该元素绘制的时候不会触发其他元素的绘制。渲染层提升为合成层的原因如下（注意以下原因是在渲染层的基础之上）：   </p><ul><li>有3D transform属性</li><li>有perspective属性</li><li>3D canvas或硬件加速的2D canvas</li><li>硬件加速的iframe元素（如iframe嵌入的页面有合成层，合成层需要硬件加速）</li><li>使用了硬件加速的插件，如flash/iframe</li><li>对opacity/transform属性应用了animation/transition（当animation/transition为active）   </li><li>will-change属性为opacity、transform、top、left、bottom、right</li><li>子元素是compositing layer</li><li>兄弟元素是compositing layer，与当前的非composting layer有重叠，composting layer的层级低于非composting layer层        </li></ul><p><strong>为什么会有性能提升？</strong>   </p><ul><li>只重绘需要重绘的部分</li><li>GPU加速：合成层的位图直接由GPU合成，比CPU处理速度更快 </li></ul><p><strong>性能提升有多少？</strong>   <a href="https://codepen.io/JoeyCai/pen/QoqMeO" target="_blank" rel="noopener">DEMO</a><br>通过demo可以看到，提升为合成层之后，paint所需的时间大大减少。<br><img src="https://img13.360buyimg.com/imagetools/jfs/t1/16031/7/10460/249740/5c871e47Ea6fc73a7/6dff807ff7296591.jpg" alt="render layer -&gt; compositing layer">   </p><p><strong>提升合成层是不是越多越好？</strong><br>可以看到提升合成层后，paint时间大大下降。但是合成层的创建需要消耗额外的内存和管理资源，过多的合成层给页面带来的内存开销很大，<a href="https://codepen.io/JoeyCai/pen/NJaOvy" target="_blank" rel="noopener">DEMO</a>创建了5000个元素，全部元素都提升为合成层与不提升时的内存消耗进行对比。这一点在移动端尤其需要注意，相比较于PC，移动设备的内存资源更加紧张。<br><img src="https://img14.360buyimg.com/imagetools/jfs/t1/30928/10/5654/389279/5c87757cE22aa61cc/1b0b1d36b15cd200.jpg" alt="过多合成层">     </p><p><strong>只提升动画元素的渲染层</strong><br>基于提升为合成层来提升性能的原理，当页面其他部分绘制比较复杂且相对静态时，我们可以考虑将动画元素单独提升为合成层，减少动画元素对页面其他元素的影响。      </p><h3 id="2-避免提升合成层的陷阱"><a href="#2-避免提升合成层的陷阱" class="headerlink" title="2. 避免提升合成层的陷阱"></a>2. 避免提升合成层的陷阱</h3><p>回顾一下提升为合成层的最后一个原因：兄弟元素是compositing layer，与当前的非composting layer有重叠，composting layer的层级低于非composting layer层。<br>这种情况下导致的提升合成层一般都是预期外的。其原因与屏幕的渲染流程有关，我们回忆一下页面映射的最后一步，每一个Compositing Layer对应一张位图，合成器最后将这些位图根据层级关系合并起来最终输出到屏幕。此时我们假设A是已知的合成层，而B理想中应当是普通渲染层，其层级关系如图所示：<br><img src="https://img10.360buyimg.com/imagetools/jfs/t1/29982/12/10660/38006/5c8783e5E829c400b/f80855a3afd155f9.jpg" alt="层级陷阱"><br>B作为普通渲染层与父级元素位于同一张位图，A单独在一张位图，此时合并的时候层级就会出现问题，如果直接将B置于A之上，有可能导致层级低于A的B的父元素反而显示在了A之上，反之A，B的层级关系就不对了。浏览器此时的解决方案，就是将B也单独出来作为compositing layer进行渲染，导致了意料外的compositing layer生成。<br>这种时候第一直觉就是避免重叠的发生不就好了嘛？然而事情并不简单。在查找资料的时候发现了一个神奇宝贝——<strong>assumedOverlap</strong>。字面意思是假设重叠，对于无法/难以判断是否会与compositing layer重合的某些元素，浏览器假设会发生重叠，提升为compositing layer。<br>对此浏览器也进行了优化的，通过层压缩（Layer Squashing）处理，将与合成层有重叠且连续多个的渲染层合并为一个合成层。防止由于重叠导致的提升合成层过多，导致的层爆炸（Layer Explosion），可参考<a href="https://codepen.io/JoeyCai/pen/jJaoop" target="_blank" rel="noopener">DEMO</a>。<br>然而层压缩还是有解决不了的情况，查看<a href="https://chromium.googlesource.com/chromium/blink/+/master/Source/platform/graphics/CompositingReasons.cpp" target="_blank" rel="noopener">源码</a>可以列出以下原因（注意一下都是在重叠/假设重叠的前提下）：      </p><ul><li><code>scrollsWithRespectToSquashingLayer</code>：渲染层相对于压缩层滚动，当滚动的渲染层与合成层重叠时，会有新的合成层生成且无法压缩。<a href="https://codepen.io/JoeyCai/pen/LaOvoM" target="_blank" rel="noopener">DEMO(这个例子不是很好，codepen用iframe嵌入，整个iframe都变成了合成层，如果想看效果可以在本地看)</a>   </li><li><code>squashingSparsityExceeded</code>：渲染层压缩后会导致压缩层过于稀疏。<a href="https://codepen.io/JoeyCai/pen/ZPaNmV" target="_blank" rel="noopener">DEMO</a>   </li><li><code>squashingClippingContainerMismatch</code>：渲染层和压缩层的裁剪容器（clip container）不同，简单理解就是重叠的渲染层的容器overflow类型不同。<a href="https://codepen.io/JoeyCai/pen/xBpBrG" target="_blank" rel="noopener">DEMO</a>   </li><li><code>squashingOpacityAncestorMismatch</code>：渲染层与压缩层的继承自祖先的opacity属性不同。<a href="https://codepen.io/JoeyCai/pen/VRrorE" target="_blank" rel="noopener">DEMO</a>   </li><li><code>squashingTransformAncestorMismatch</code>：渲染层与压缩层的继承自祖先的transform不同。<a href="https://codepen.io/JoeyCai/pen/wOpOLQ" target="_blank" rel="noopener">DEMO</a></li><li><code>squashingFilterAncestorMismatch</code>：渲染层与压缩层的继承自祖先的filter属性不同，或者是渲染层本身有filter属性。<a href="https://codepen.io/JoeyCai/pen/WmdmLL" target="_blank" rel="noopener">DEMO</a>   </li><li><code>squashingWouldBreakPaintOrder</code>：无法在不打乱渲染顺序的前提下压缩（e.g. 父元素有mask/filter属性，子元素与压缩层overlap，则假如合并了，父元素的mask/filter属性无法局部应用在压缩层，导致渲染结果有误）。<a href="https://codepen.io/JoeyCai/pen/eXyoMg" target="_blank" rel="noopener">DEMO</a>  </li><li><code>squashingVideoIsDisallowed</code>：video元素无法被压缩。<a href="https://codepen.io/JoeyCai/pen/zbpXME" target="_blank" rel="noopener">DEMO</a>   </li><li><code>squashedLayerClipsCompositingDescendants</code>：当合成层是被剪切的子元素时，与之重叠的渲染层无法被压缩。<a href="https://codepen.io/JoeyCai/pen/XGZrgY" target="_blank" rel="noopener">DEMO</a></li><li><code>squashingLayoutPartIsDisallowed</code>：无法压缩frame/iframe/plugin。   </li><li><code>squashingReflectionDisallowed</code>：无法压缩有reflection属性的渲染层。 <a href="https://codepen.io/JoeyCai/pen/QoQWgB" target="_blank" rel="noopener">DEMO</a>  </li><li><code>squashingBlendingDisallowed</code>：无法压缩有blend mode属性的渲染层。<a href="https://codepen.io/JoeyCai/pen/vPdYdm" target="_blank" rel="noopener">DEMO</a>   </li><li><code>squashingNearestFixedPositionMismatch</code>：渲染层的最近fixed元素与压缩层不同，无法被压缩。<a href="https://codepen.io/JoeyCai/pen/EMQaWW" target="_blank" rel="noopener">DEMO</a>    </li></ul><p>当发现页面明明没有什么内容却比较卡的时候可以检查一下是不是这个原因，以下给出常见的层压缩解决不了的情况：   </p><ol><li>带<code>transform</code>动画的元素，其后的元素为<code>relative/absolute</code>定位<br>原因：relative元素和relative下的absolute元素由于assumedOverlap原因都被被提升为合成层，又由于设置了overflow:hidden，基于前面提到的<code>squashingClippingContainerMismatch</code>，渲染层与合成层的裁剪容器不同，导致无法层压缩，出现过多的合成层。<br>解决方法：为动画的元素设置<code>z-index</code>扰乱compositing layer的排序。<a href="https://codepen.io/JoeyCai/pen/GeOeWy" target="_blank" rel="noopener">DEMO</a>   </li></ol><h1 id="三、参考"><a href="#三、参考" class="headerlink" title="三、参考"></a>三、<span id="3">参考</span></h1><p>本文结构主要参照文章[1]，对其中的一些优化点进行了实际测试和扩展，也算是一篇读后感吧~<br>关于层压缩部分情况过于复杂，没找到什么资料，感觉还没有完全吃透，后面有机会再重新整理一下。感恩以下大佬！</p><ol><li>深度剖析浏览器渲染性能原理，你到底知道多少？ <a href="https://www.jianshu.com/p/a32b890c29b1" target="_blank" rel="noopener">https://www.jianshu.com/p/a32b890c29b1</a></li><li><span id="refs-5">Optimizing CSS: ID Selectors and Other Myths <a href="https://www.sitepoint.com/optimizing-css-id-selectors-and-other-myths/" target="_blank" rel="noopener">https://www.sitepoint.com/optimizing-css-id-selectors-and-other-myths/</a></span>      </li><li>GPU Accelerated Compositing in Chrome <a href="http://www.chromium.org/developers/design-documents/gpu-accelerated-compositing-in-chrome" target="_blank" rel="noopener">http://www.chromium.org/developers/design-documents/gpu-accelerated-compositing-in-chrome</a></li><li>GPU加速是什么 <a href="https://aotu.io/notes/2017/04/11/GPU/" target="_blank" rel="noopener">https://aotu.io/notes/2017/04/11/GPU/</a></li><li>Blink Compositing Update: Recap and Squashing <a href="https://docs.google.com/presentation/d/1WOhbWLkhMyo4vZUaHq-FO-mt0B2sejXw-lMwohD5iUo/edit#slide=id.gccb6cccc_0719" target="_blank" rel="noopener">https://docs.google.com/presentation/d/1WOhbWLkhMyo4vZUaHq-FO-mt0B2sejXw-lMwohD5iUo/edit#slide=id.gccb6cccc_0719</a>      </li><li>无线性能优化：Composite <a href="http://taobaofed.org/blog/2016/04/25/performance-composite/" target="_blank" rel="noopener">http://taobaofed.org/blog/2016/04/25/performance-composite/</a></li></ol><p>撒花完结~欢迎指教~   </p>]]></content>
      
      
      <categories>
          
          <category> 深入学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 性能优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报14（20190308）</title>
      <link href="/2019/03/08/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A514%EF%BC%8820190308%EF%BC%89/"/>
      <url>/2019/03/08/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A514%EF%BC%8820190308%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="新鲜速报"><a href="#新鲜速报" class="headerlink" title="新鲜速报"></a>新鲜速报</h2><ol><li>http/3</li><li>一些少用的 Web APIs: <a href="https://juejin.im/post/5c6b64dfe51d457f926d5232" target="_blank" rel="noopener">https://juejin.im/post/5c6b64dfe51d457f926d5232</a></li><li>React 2019计划：<a href="https://reactjs.org/blog/2018/11/27/react-16-roadmap.html" target="_blank" rel="noopener">https://reactjs.org/blog/2018/11/27/react-16-roadmap.html</a></li><li>RunJS：输入JS代码片段可预览执行效果，支持最新的ES特性。<a href="https://runjs.dev/?spm=a2c4e.11153940.blogcont690689.47.67c75204uf7Ktb" target="_blank" rel="noopener">https://runjs.dev/?spm=a2c4e.11153940.blogcont690689.47.67c75204uf7Ktb</a></li><li>波函数坍缩算法(WaveFunctionCollapse is Constraint Solving in the Wild)：<a href="http://dy.163.com/v2/article/detail/E41BJIKO0511DSSR.html" target="_blank" rel="noopener">http://dy.163.com/v2/article/detail/E41BJIKO0511DSSR.html</a></li><li>视线追踪算法：<a href="https://blog.csdn.net/krapnik/article/details/80636031" target="_blank" rel="noopener">https://blog.csdn.net/krapnik/article/details/80636031</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报13（20190222）</title>
      <link href="/2019/02/22/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A513%EF%BC%8820190222%EF%BC%89/"/>
      <url>/2019/02/22/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A513%EF%BC%8820190222%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="行业动态"><a href="#行业动态" class="headerlink" title="行业动态"></a>行业动态</h2><ol><li><p>fuse.js：轻量级模糊搜索插件   </p><ul><li>链接：<a href="https://fusejs.io/" target="_blank" rel="noopener">https://fusejs.io/</a></li><li>关键词：轻量级（11KB），零依赖，模糊搜索</li><li>应用：适合于小数据量的简单搜索，可依据匹配程度排序</li></ul></li><li><p>3个值得期待的JavaScript新特性      </p><ul><li>链接：<a href="https://mp.weixin.qq.com/s/aM5vlKkka8GEFSFM222fNg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/aM5vlKkka8GEFSFM222fNg</a>   </li><li><p>简述   </p><ul><li><p>可选运算符(Optional Chaining, stage-1)：简单的防止访问object时，由于数据结构不规范导致的报错。   </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    user: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(data.user?.address?.street); <span class="comment">// undefined</span></span><br><span class="line"><span class="comment">// 可替代以下写法</span></span><br><span class="line"><span class="comment">// const street = data &amp;&amp; data.user &amp;&amp; data.user.address &amp;&amp; data.user.address.street;</span></span><br></pre></td></tr></table></figure></li><li><p>空值合并(Nullish Coalescing, stage-1)：判断是否为<code>null</code>或<code>undefined</code>，可以在保护<code>0</code>，<code>false</code>，<code></code>的情况下，设置默认值</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> val1 = <span class="literal">undefined</span>, val2 = <span class="literal">null</span>, val3 = <span class="number">0</span>, val4 = <span class="literal">false</span>, val5 = <span class="string">''</span>;</span><br><span class="line">val1 ?? <span class="string">'default value'</span>; <span class="comment">// val1 = 'default value'</span></span><br><span class="line">val2 ?? <span class="string">'default value'</span>; <span class="comment">// val2 = 'default value'</span></span><br><span class="line">val3 ?? <span class="string">'default value'</span>; <span class="comment">// val3 = 0</span></span><br><span class="line">val4 ?? <span class="string">'default value'</span>; <span class="comment">// val4 = false</span></span><br><span class="line">val5 ?? <span class="string">'default value'</span>; <span class="comment">// val5 = ''</span></span><br></pre></td></tr></table></figure></li><li><p>管道运算符(The Pipeline Operator, stage-1)：链式调用函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> result = <span class="string">"hello"</span></span><br><span class="line">    |&gt; doubleSay</span><br><span class="line">    |&gt; capitalize</span><br><span class="line">    |&gt; exclaim;</span><br><span class="line"><span class="comment">// 替代以下写法</span></span><br><span class="line"><span class="comment">// result = exclaim(capitalize(doubleSay("hello")))</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ol><ol start="3"><li>常见的CSS图形绘制合集   <ul><li>链接：<a href="https://www.zhangxinxu.com/wordpress/2019/01/pure-css-shapes/" target="_blank" rel="noopener">https://www.zhangxinxu.com/wordpress/2019/01/pure-css-shapes/</a></li><li>以下均为CSS绘制的图形，具体实现可参照链接<br><img src="https://img10.360buyimg.com/imagetools/jfs/t1/18445/22/7664/76460/5c6fa789Eef5f2834/29d0c0d187e37344.jpg" alt="css图形">   </li></ul></li></ol><h2 id="近期问题记录"><a href="#近期问题记录" class="headerlink" title="近期问题记录"></a>近期问题记录</h2><ol><li>页面<strong>视频资源会发出3次请求</strong>的原因<ul><li>原因分析：<a href="https://www.zhangxinxu.com/wordpress/2018/12/video-moov-box/" target="_blank" rel="noopener">https://www.zhangxinxu.com/wordpress/2018/12/video-moov-box/</a></li><li>简述：解释了一下页面中某些video资源会请求3次的原因，赶忙看了一下之前做的项目拉取视频也有这个问题，文章中修复方案实测有效。除此之外发现使用http链接，请求依旧会有2次，第一次请求的code为307，原因是后台做了强制https访问的限制（基于HSTS），改用https链接问题解决。</li></ul></li><li><code>babel</code>舍弃了以前的<code>babel-*-*</code>的命名方式，7.x版本采用了<code>@babel/*-*</code>形式，使用7.x版本babel安装插件时需要注意对应。   </li><li>animation动画安卓下卡顿？   <ul><li>原因分析：修改width/height/margin，误差叠加</li><li>解决：   <ul><li>修改为transform，避免重排；</li><li>修改为单一属性变化，减少误差；</li><li>加入<code>transform: translateZ(0)</code>启动GPU加速</li></ul></li></ul></li></ol><h2 id="好玩的H5案例"><a href="#好玩的H5案例" class="headerlink" title="好玩的H5案例"></a>好玩的H5案例</h2><ol><li>我的剪纸新年照<br> 分析：<a href="https://www.h5anli.com/cases/201902/chuanghua.html" target="_blank" rel="noopener">https://www.h5anli.com/cases/201902/chuanghua.html</a><br> h5链接：<a href="http://m.baconbuy.com/qq/paperCuts/" target="_blank" rel="noopener">http://m.baconbuy.com/qq/paperCuts/</a>     </li><li>我家年夜饭（类似汪年全家福）<br> 分析：<a href="https://www.h5anli.com/cases/201902/pupupula.html" target="_blank" rel="noopener">https://www.h5anli.com/cases/201902/pupupula.html</a><br> h5链接：<a href="https://pupupula.net/nian/index.html?from=singlemessage" target="_blank" rel="noopener">https://pupupula.net/nian/index.html?from=singlemessage</a>     </li></ol><h2 id="关注学习ing"><a href="#关注学习ing" class="headerlink" title="关注学习ing"></a>关注学习ing</h2><ol><li>Lottie<br><a href="https://airbnb.design/introducing-lottie/" target="_blank" rel="noopener">https://airbnb.design/introducing-lottie/</a><br><a href="http://test.imweb.io/topic/5b23a745d4c96b9b1b4c4efc" target="_blank" rel="noopener">http://test.imweb.io/topic/5b23a745d4c96b9b1b4c4efc</a></li><li>parcel   <ul><li>链接：<a href="http://www.itbaby.me/doc/parcel/" target="_blank" rel="noopener">http://www.itbaby.me/doc/parcel/</a>  </li><li>关键词：web应用打包器，执行快，零配置</li></ul></li><li>react devtools：<a href="https://github.com/facebook/react-devtools" target="_blank" rel="noopener">https://github.com/facebook/react-devtools</a><br>这个没啥，就是好工具，用上用上~   </li><li>优化动画卡顿：近期正在整理输出相关文章</li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报12（20190125）</title>
      <link href="/2019/01/25/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A512%EF%BC%8820190125%EF%BC%89/"/>
      <url>/2019/01/25/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A512%EF%BC%8820190125%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="一月行业动态"><a href="#一月行业动态" class="headerlink" title="一月行业动态"></a>一月行业动态</h2><h3 id="1-设计稿生成代码插件一览"><a href="#1-设计稿生成代码插件一览" class="headerlink" title="1. 设计稿生成代码插件一览"></a>1. 设计稿生成代码插件一览</h3><ul><li>imgcook（淘宝）<ul><li>功能：目前支持将sketch设计稿生成模块化的html+css代码，输出代码格式支持小程序/React/H5/Rax</li><li>原理：参照图层结构分析+图像识别处理</li><li>体验：<a href="https://imgcook.taobao.org/" target="_blank" rel="noopener">https://imgcook.taobao.org/</a></li></ul></li><li>sketch2code（微软开源）<ul><li>功能：将草图翻译为HTML代码</li><li>原理：上传图片-&gt; 视觉模型预测图像中的html元素并标出位置 -&gt;文本识别预测元素中的文本 -&gt; 布局算法依据预测元素的边框信息生成网格结构 -&gt; 生成html代码</li><li>体验：<a href="https://sketch2code.azurewebsites.net/" target="_blank" rel="noopener">https://sketch2code.azurewebsites.net/</a></li></ul></li><li>Dapollo（蚂蚁金服）<ul><li>功能：提供丰富的内置组件/图标/页面模板，且都有对应的开发代码，设计开发一体化。支持ios/Android/H5/小程序</li><li>原理：sketch插件</li><li>体验：<a href="https://oursketch.com/plugin/dapollo" target="_blank" rel="noopener">https://oursketch.com/plugin/dapollo</a></li></ul></li><li>pix2code（理论性参考）<ul><li>功能：AI参照UI图片生成代码</li><li>原理：pix2code模型把单个的GUI截屏图片作为输入，基于卷积神经网络和循环升级网络产生计算机标签。</li><li>体验：<a href="https://uizard.io/research/#pix2code上包含17年-18年关于这个模型的相关论文，可以看看其中的实验数据" target="_blank" rel="noopener">https://uizard.io/research/#pix2code上包含17年-18年关于这个模型的相关论文，可以看看其中的实验数据</a>   </li></ul></li></ul><h3 id="2-uni-app：基于vue开发跨平台应用的前端框架"><a href="#2-uni-app：基于vue开发跨平台应用的前端框架" class="headerlink" title="2. uni-app：基于vue开发跨平台应用的前端框架"></a>2. uni-app：基于vue开发跨平台应用的前端框架</h3><ul><li>描述：DCloud公司开发，基于vuejs的跨平台框架（iOS/Android/H5/微信小程序/支付宝小程序/百度小程序）</li><li>思考：看似很厉害，细看是个大杂烩全家桶，转小程序使用的是美团的mpvue框架，转移动应用使用的是dcloud之前推出的HTML5Plus引擎</li><li>体验：<a href="https://uniapp.dcloud.io/" target="_blank" rel="noopener">https://uniapp.dcloud.io/</a>   </li></ul><h3 id="3-Bash简化常用命令"><a href="#3-Bash简化常用命令" class="headerlink" title="3. Bash简化常用命令"></a>3. Bash简化常用命令</h3><ul><li>描述：用一个指令代替一连串的指令</li><li>举例：上传代码到git，可以通过alias设置指令别名 alias gitpush= =’function _gitpush() {git add .; git commit -m $1; git push origin master;}; _gitpush’</li><li>参考：<a href="https://medium.com/@raimibinkarim/9-bash-aliases-to-make-your-life-easier-3e5855aa95fa" target="_blank" rel="noopener">https://medium.com/@raimibinkarim/9-bash-aliases-to-make-your-life-easier-3e5855aa95fa</a>   </li></ul><h3 id="4-一句话动态"><a href="#4-一句话动态" class="headerlink" title="4. 一句话动态"></a>4. 一句话动态</h3><ul><li>第13届D2前端技术论坛相关ppt已共享，后续会有相关视频分享，可以持续关注：<a href="https://www.yuque.com/d2forum/content/d213" target="_blank" rel="noopener">https://www.yuque.com/d2forum/content/d213</a></li><li>第2届SEE Conf 2019蚂蚁金服体验科技大会，演讲视频与PPT：<a href="https://www.yuque.com/seeconf/content/kbnzac" target="_blank" rel="noopener">https://www.yuque.com/seeconf/content/kbnzac</a></li><li>美团点评-2018前端技术年货：<a href="https://awps-assets.meituan.net/mit-x/2018-ebook-bundle3/2018-ebook-frontend.pdf" target="_blank" rel="noopener">https://awps-assets.meituan.net/mit-x/2018-ebook-bundle3/2018-ebook-frontend.pdf</a></li><li>基于threejs的在线3D场景编辑器：<a href="https://tengge1.github.io/ShadowEditor-examples/" target="_blank" rel="noopener">https://tengge1.github.io/ShadowEditor-examples/</a></li><li>一些css动效的整理，适合找找灵感   <ul><li><a href="https://qishaoxuan.github.io/css_tricks/" target="_blank" rel="noopener">https://qishaoxuan.github.io/css_tricks/</a>   </li><li><a href="https://chokcoco.github.io/CSS-Inspiration/#/" target="_blank" rel="noopener">https://chokcoco.github.io/CSS-Inspiration/#/</a></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报11（20190111）</title>
      <link href="/2019/01/11/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A511%EF%BC%8820190111%EF%BC%89/"/>
      <url>/2019/01/11/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A511%EF%BC%8820190111%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="2018年度问题整理"><a href="#2018年度问题整理" class="headerlink" title="2018年度问题整理"></a>2018年度问题整理</h2><h3 id="1-倒计时"><a href="#1-倒计时" class="headerlink" title="1. 倒计时"></a>1. 倒计时</h3><ul><li><strong>【锁屏处理】</strong> 使用setInterval进行倒计时，锁屏时会中断执行。需要通过visibilityChange事件处理。</li><li><strong>【精确度】</strong> 长时间的倒计时不精准，在低端手机下尤其明显。进入页面时获取服务器时间和本地时间的差值，服务器时间作为初始时间，用setInterval每隔400毫秒更新一次时间戳作为当前时间，每隔1分钟获取本地时间与进入页面时的本地时间对比作为校准值，校准当前时间。</li></ul><h3 id="2-视频"><a href="#2-视频" class="headerlink" title="2. 视频"></a>2. 视频</h3><ul><li><strong>【自动播放】</strong> 只有ios10+支持无音轨/设置静音的视频自动播放，其他情况下都需要用户手动触发（click/touchstart事件） ，可考虑的降级方案有低端机下用GIF/逐帧动画（建议帧数不超过30帧，超出在部分手机上有闪屏情况出现）代替。</li><li><strong>【预加载】</strong> 设置preload表示在页面加载后马上加载，个人通常的做法是设置该属性，src置空，在需要播放的时候再设置src，以此达到按需加载的目的。</li><li><strong>【微信/部分浏览器video层级】</strong> 在安卓机下，微信和部分浏览器中，video总在最顶层，且暂时没有发现覆盖它的方法。微信端目前唯一的解决方法是成为白名单(2019.01.06)，浏览器暂时无解。   </li><li><strong>【iphone默认全屏播放】</strong> 在video标签中添加属性<code>&lt;video playsinline=&quot;true&quot; -webkit-playsinline=&quot;true&quot;&gt;&lt;/video&gt;</code>。</li><li><strong>【锁屏处理】</strong> 锁屏后应当暂停视频，同采用事件visibilitychange处理。</li><li><strong>【浏览器下暂停有广告】</strong> 浏览器原生插入的广告，暂时木有办法。可考虑的处理方案是在视频暂停时将视频缩小为1px * 1px用一张图片占位。</li><li><strong>【视频上传地址】</strong> ViOS和安卓需要分别上传到两个服务器，ios上传到<a href="http://storage.jd.com" target="_blank" rel="noopener">http://storage.jd.com/*</a>，在<a href="https://oss.jd.com" target="_blank" rel="noopener">oss.jd.com</a>上传。安卓上传到<a href="https://static.360buyimg.com/" target="_blank" rel="noopener">https://static.360buyimg.com/*</a>域名下，需要木木和李杰提交，寒冰审批。</li></ul><h3 id="3-音频"><a href="#3-音频" class="headerlink" title="3. 音频"></a>3. 音频</h3><ul><li><strong>【自动播放】</strong> 需要用户手动触发才可播放。</li><li><strong>【循环播放有停顿感】</strong> 音频的前后衔接最好有淡出淡入，手机原生播放器循环播放音频时会有近1秒的停顿，如果没有淡出淡入会有停顿感。</li><li><strong>【静音】</strong> iOS8及以下，IE9及以下不支持muted属性。</li><li><strong>【初始化延迟】</strong> iOS Safari浏览器初始化一个新的音频有延时，因为iOS需要实例化一个新的音频对象再通过网络请求音频资源。解决方案是在页面ready之后把每个文件都load，提前预加载。</li></ul><h3 id="4-运营模式"><a href="#4-运营模式" class="headerlink" title="4. 运营模式"></a>4. 运营模式</h3><ul><li><strong>【自定义模块延后加载】</strong> 头图最好用运营模块占位，然后再用自定义代码往上加功能，保证首屏加载的时候，头图的位置没有重排重绘，也可以防止下面的楼层往上顶，占用首屏加载资源。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报10（20181228）</title>
      <link href="/2018/12/28/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A510%EF%BC%8820181228%EF%BC%89/"/>
      <url>/2018/12/28/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A510%EF%BC%8820181228%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、12月行业动态"><a href="#一、12月行业动态" class="headerlink" title="一、12月行业动态"></a>一、12月行业动态</h3><ol><li><p><strong>微信小程序近期更新一览</strong>  </p><ul><li>20181112起，小程序跳转小程序数量不可超过10个，且不支持动态修改   </li><li>20190114起，获取用户位置信息时需填写用途说明，否则无法正常调用地理位置相关接口   </li><li>20180114起，不再支持使用“提前发起授权接口”获取用户信息  </li><li>从小程序基础库版本2.1.1或以上、及开发者工具1.02.1808300或以上开始，小程序支持npm安装第三方包     </li></ul></li><li><p><strong>在App、微信、h5页面切换音频播放功能的兼容性问题</strong></p><ul><li>播放音频需要用户主动触发  </li><li>多音频切换方法：  </li><li>在多个audio标签之间切换。优点是使用方便，缺点是资源占用高；  </li><li>将多个音频合并为一个文件，播放不同的音频选择相应时段。优点是兼容性好，缺点是比较繁琐；  </li><li>应用切换到后台后再切换回来，音乐续播，在visiblityChange事件中触发<br>参考：<a href="https://jdc.jd.com/archives/212874" target="_blank" rel="noopener">https://jdc.jd.com/archives/212874</a></li></ul></li><li><p><strong>轻量级移动web特效解决方案omi-transform</strong>   </p><ul><li>描述：以修改DOM属性为代价，提供可编程性高的动效方案   </li><li>优点：   <ul><li>使用matrix3d为最终输出DOM对象，硬件加速   </li><li>可编程性高   </li><li>轻量级   </li><li>有原生版本和react版本，可与多种框架配合使用   </li></ul></li><li>参考：<a href="http://www.alloyteam.com/2018/11/13436/" target="_blank" rel="noopener">http://www.alloyteam.com/2018/11/13436/</a></li></ul></li></ol><h3 id="二、本周项目"><a href="#二、本周项目" class="headerlink" title="二、本周项目"></a>二、本周项目</h3><ol><li><p><strong>【自测中】大黄蜂互动游戏</strong></p><ul><li><p>iOS下Safari上滑切换音效失败<br>audio.play()在Safari下只能写在touchstart事件才能生效   </p></li><li><p>Android下站内偶现视频解析异常<br>目前没有发现原因，抓包返回也正常，过了一段时间突然就好了，猜测是服务器问题   </p></li><li><p>黑屏是音乐还会继续播放的问题<br>黑屏时需要特殊处理，关闭声音并且若有视频则暂停视频，通过visibilityChange事件触发   </p></li><li><p>网速慢的时候视频加载时间很长<br>目前无解，只能够添加提示文案【正在加载…】，缓解一下这个问题</p></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报09（20181214）</title>
      <link href="/2018/12/14/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A509%EF%BC%8820181214%EF%BC%89/"/>
      <url>/2018/12/14/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A509%EF%BC%8820181214%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、本周项目"><a href="#一、本周项目" class="headerlink" title="一、本周项目"></a>一、本周项目</h3><ol><li><strong>[已完成] 双十二主会场预热期问题总结</strong>   <ul><li>东家小院返回图片过大，对首屏加载速度有影响<br>解决：<ul><li>对于能够处理图片大小的链接，前端进行处理（依据网络状况/是否支持webp/是否已设置size等），修改quality和size。</li></ul></li><li>运营模式下，自定义代码的请求会被运营模块阻塞，当请求较多/请求资源较大时，可能因为超时失败。<br>解决：   <ul><li>自定义代码css和js尽量内联，减少请求数目；   </li><li>多自定义模块能够合并的尽量合并；   </li><li>头图尽量用运营模块搭建，如果功能比较复杂，可以先用运营模块放头图的图片，然后再用自定义代码往上加数据或其他。防止下面的运营楼层出现在首屏优先加载，影响首屏资源数；   </li></ul></li><li>运营模式下，多模块楼层若出现在首屏，对于加载速度有较大的影响，尤其是有多个tab且tab内部结构复杂时，会阻塞自定义代码请求。   </li></ul></li></ol><ol start="2"><li><strong>[进行中] 大黄蜂互动游戏</strong>   <ul><li>之前做的视频类H5一般都是循环播放，此次的需求时只播放一次，在Android浏览器端播放结束会有广告出现<ul><li>（不彻底解决方案）在视频播放结束后马上隐藏视频，用一张图片代替原位置（如果视频暂停的时候还是会有同样的问题）。</li></ul></li><li>Android微信下会有全屏按钮<ul><li>若视频本身为全屏，可以通过拉高视频，将按钮撑到可视区域之外</li><li>若视频非全屏展示，则该按钮无法去除（微信下视频层级过高无法被遮住）</li><li>用 canvas实现视频播放性能不佳，慎重使用</li></ul></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报08（20181130）</title>
      <link href="/2018/11/30/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A508%EF%BC%8820181130%EF%BC%89/"/>
      <url>/2018/11/30/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A508%EF%BC%8820181130%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、本周项目"><a href="#一、本周项目" class="headerlink" title="一、本周项目"></a>一、本周项目</h3><ol><li><strong>[待提测] 双十二主会场小院标签楼层</strong>   <ul><li>进度：100%   </li><li>问题：上游接口还在测试中，接口未上线影响提测进度。   </li></ul></li></ol><ol start="2"><li><strong>[进行中] 测试机管理小程序</strong>   <ul><li>描述：通过扫描每个手机专有的二维码借取/归还部门内测试机，提供个人手机及凹凸实验室测试机信息查询。</li><li>进度： 80%</li><li>问题：一开始没有想好完整的交互模式，导致一边做一边改，影响效率</li></ul></li></ol><h3 id="二、小程序云开发踩坑总结"><a href="#二、小程序云开发踩坑总结" class="headerlink" title="二、小程序云开发踩坑总结"></a>二、小程序云开发踩坑总结</h3><ol><li><p><strong>问题整理</strong></p><ul><li>云开发数据库无法联表查询，导致每次查询手机列表都要同时取出三个表的数据，再进行处理，拉取数据十分耗时。小程序云开发社区反馈后期会优化联表操作，建议目前采用添加冗余的方式来加快数据拉取。</li><li>上传文件到小程序云开发服务器后，返回的是一个文件fileid，通过这个ID生成的图片链接有效期最长只有一天。</li><li>为了前后端解耦，考虑将所有的数据库操作都放在了云函数中，由于功能不同导致云函数数量很多，对于复杂需求难以维护。</li><li>小程序码生成的接口共有A/B/C三个，其中A/C有数量限制，只有B是不限数量，但是只能生成线上小程序的小程序码。</li></ul></li><li><p><strong>总结</strong><br>目前云开发的功能还比较简单，而且BUG较多，想要试水的话建议可以用一用云函数，方便代码复用，其他如云数据库，只支持简单的增删改查，稍微复杂的操作就会很吃力，而云存储给的权限比较吝啬，生成文件链接还需要根据文件ID再访问一次，链接有效期最长只有一天，用起来比较繁琐。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报07（20181116）</title>
      <link href="/2018/11/16/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A507%EF%BC%8820181116%EF%BC%89/"/>
      <url>/2018/11/16/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A507%EF%BC%8820181116%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、项目总结"><a href="#一、项目总结" class="headerlink" title="一、项目总结"></a>一、项目总结</h3><ol><li><strong>[已完成] 站内攻略高潮期问题总结</strong><ul><li>此次数据查询请求数据量过大，测试提出在弱网络环境下有可能请求超时。 解决：提供一个网络超时toast，提升用户体验。   </li><li>红包雨预约需要每个整点都可预约，每个整点的预约事件id必须不同，用户每次预约都只是预约了某一整点的红包雨。日历组件无法实现规律性的每隔多少时间就提醒一次的预约。</li></ul></li><li><strong>[进行中] 测试机管理小程序</strong><ul><li>描述：通过扫描每个手机专有的二维码借取/归还部门内测试机，提供个人手机及凹凸实验室测试机信息查询。</li><li>进度： 50%，预计下周内完成</li><li>问题：小程序提供的云数据库限制，设计的数据库结构效率较低</li></ul></li></ol><h3 id="二、本周学习"><a href="#二、本周学习" class="headerlink" title="二、本周学习"></a>二、本周学习</h3><ol><li><p>小程序原生开发</p><ul><li>目录结构说明<br><img src="/images/weekly/07/miniprogram.png" alt="小程序原生开发目录结构"> </li><li>vscode插件辅助开发<br><strong>live sass compile</strong>：修改配置文件”extensionName”: “.wxss”，将sass实时打包为wxss。同理如果是习惯用less的，可以用Easy WXLESS。<br><strong>vscode weapp api</strong>：提供小程序API提示。<br><strong>vscode-wechat</strong>：wxml和wxss语法高亮支持，本来支持本地预览，但是这个插件目前没有维护，预览功能有bug。<br>sublime可参考<a href="https://www.jianshu.com/p/ec0f7c936f23" target="_blank" rel="noopener">https://www.jianshu.com/p/ec0f7c936f23</a>   </li><li>注意点记录  <ul><li>小程序是数据驱动开发，无法操作DOM   </li><li>小程序是微信的内部应用，无法获取到window/document   </li><li>云函数上传部署速度很慢，如果在云函数内调用了云数据库，需要上传部署并安装依赖，速度就更慢了，建议本地测试好函数再部署上去。   </li><li>一次只能对一个数据表进行增删改查，如果需要多表关联查询，需要分多次操作。   </li><li>数据表读写操作权限只有四种，注意无法实现所有人均可写数据。   </li></ul></li></ul></li><li><p>闯关模式游戏，画画为最主要的互动元素，由玩家画出主角/武器，游戏的开发比较简单，互动方式比较新颖。<br>参考案例： <a href="http://zj.qq.com/money/ywl_game_halloween.htm" target="_blank" rel="noopener">http://zj.qq.com/money/ywl_game_halloween.htm</a><br>做了一个简单的demo，实现主体功能，画画并显示到界面上：<br><img src="/images/weekly/07/draw2playQR.png" alt="扫一扫体验demo"><br><img src="/images/weekly/07/draw2play.gif" alt="demo效果"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报06（20181102）</title>
      <link href="/2018/11/02/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A506%EF%BC%8820181102%EF%BC%89/"/>
      <url>/2018/11/02/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A506%EF%BC%8820181102%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、行业动态"><a href="#一、行业动态" class="headerlink" title="一、行业动态"></a>一、行业动态</h3><ol><li><strong>WebAssembly标准</strong><br>把除javascript外的编程语言转换为能在现代浏览器中运行的代码的技术，目的是和javascript结合用于开发大型web项目，提升性能。该标准受到了主流浏览器的支持（Firefox/Chrome/Safari/Edge），但是依据PSPDFKit对WebAssembly的实际测试，除了Firefox外的其他浏览器测试结果都不理想，有兴趣的同学可以看看PSPDFKit开源的WebAssembly测试基准，具体的测试效果如下：<br><img src="/images/weekly/06/webassembly.png" alt="webassembly性能测试"></li><li><strong>小程序云开发</strong>    <ul><li>描述：帮助开发者快速构建微信小程序的后端服务，提供了云函数、云数据库和云文件存储能力，并将这些能力封装成特定的接口，以wx.cloud.xx的形式调用。</li><li>思考：<ul><li>接口只能在小程序环境中调用，适用于逻辑简单的小程序开发。</li><li>降低了开发门槛，弱化了后端在小程序开发中的作用，安全性和稳定性由官方保证。</li></ul></li><li>来源：<a href="http://www.alloyteam.com/page/0/" target="_blank" rel="noopener">http://www.alloyteam.com/page/0/</a></li></ul></li></ol><h3 id="二、本周项目：M端站内攻略高潮期"><a href="#二、本周项目：M端站内攻略高潮期" class="headerlink" title="二、本周项目：M端站内攻略高潮期"></a>二、本周项目：M端站内攻略高潮期</h3><ol><li>秒杀倒计时一开始的实现策略是setTimeout+定时更新服务器时间校准。后期发现当手机黑屏时，setTimeout也会随之终止。<br><strong>解决</strong>：初始时计算出本地时间与服务器时间的差值，然后以本地时间+差值作为当前时间，进行倒计时。同样定期更新服务器时间校准差值。</li><li>榜单接口很不稳定，subsku字段经常不下发或者为空？<br><strong>解决</strong>：加入兜底方案，当返回的subsku少于3个时，选用下一个榜单，当少于3个榜单符合条件时隐藏楼层。</li></ol><h3 id="三、零散分享"><a href="#三、零散分享" class="headerlink" title="三、零散分享"></a>三、零散分享</h3><p>前段时间开始试着写threejs的文档，体会到写文档是一件很困难的事情，近期刚好看到一篇介绍怎么撰写技术文档的文章，有兴趣的同学可以看看详细内容~文章将技术文档分为了四类，分别介绍了撰写这四类文档的注意点，总结如下：   </p><table><thead><tr><th>类型</th><th>介绍</th><th>要点</th></tr></thead><tbody><tr><td>教程（tutorial）</td><td>1. 学习导向<br> 2. 适合入门<br> 3. 系列课程</td><td>1. 边学边做，要让读者感受到立竿见影的效果<br> 2. 提供具体的可操作的步骤，减少抽象的概念和不必要的解释</td></tr><tr><td>指导（guide）</td><td>1. 目标导向<br> 2. 解决问题<br> 3. 分步骤</td><td>1. 提供一系列的步骤达到具体的结果，目的是解决问题<br> 2. 不需要解释概念，解决方法具有一定的弹性，适用于不同场景<br> 3. 实用性优先，不需要面面俱到，比如说一些大部分都知道的操作可以直接省去</td></tr><tr><td>解释（explanation）</td><td>1. 理解导向<br> 2. 背景介绍</td><td>1. 介绍项目背景环境<br> 2. 提供与同类型的对比，或者说是备选方案</td></tr><tr><td>参考（reference）</td><td>1. 信息导向<br> 2. 描述性<br> 3. 精确完整</td><td>1. 文档结构与代码结构一致<br> 2. 整体的格式保持一致<br> 3. 只描述，不提供具体的应用，精确第一</td></tr></tbody></table><p>详情见<a href="https://www.divio.com/blog/documentation/，" target="_blank" rel="noopener">https://www.divio.com/blog/documentation/，</a> </p>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报05（20181021）</title>
      <link href="/2018/10/21/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A505%EF%BC%8820181021%EF%BC%89/"/>
      <url>/2018/10/21/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A505%EF%BC%8820181021%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、本周项目：岁月神偷H5-amp-站内攻略详细版高潮期（10-17-11-02）"><a href="#一、本周项目：岁月神偷H5-amp-站内攻略详细版高潮期（10-17-11-02）" class="headerlink" title="一、本周项目：岁月神偷H5&amp;站内攻略详细版高潮期（10.17 ~ 11.02）"></a>一、本周项目：岁月神偷H5&amp;站内攻略详细版高潮期（10.17 ~ 11.02）</h3><ol><li>部分安卓机下（测试机华为P10 Android8.0.0）音频播放必须通过click事件触发。</li><li>IScroll禁用了原生的click事件，官方推荐使用封装的tap事件，而tap事件只在页面滑动且滑动距离小于10px时触发。</li></ol><h3 id="二、近期学习"><a href="#二、近期学习" class="headerlink" title="二、近期学习"></a>二、近期学习</h3><h4 id="1-three-js：WebGL第三方库"><a href="#1-three-js：WebGL第三方库" class="headerlink" title="1. three.js：WebGL第三方库"></a>1. three.js：WebGL第三方库</h4><ul><li><strong>描述</strong>：目前使用比较广泛的开源3D动画库</li><li><strong>进度</strong>：80%</li><li><strong>输出</strong>：目前正在整理学习文章，详细文章如下，更复杂的一些问题等大促过后再继续学习~<ul><li><a href="https://winniecjy.github.io/2018/10/11/threejs%E5%9F%BA%E7%A1%80%E4%B8%8A%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96/" target="_blank" rel="noopener">threejs基础上：初始化</a></li><li><a href="https://winniecjy.github.io/2018/10/11/threejs%E5%9F%BA%E7%A1%80%E4%B8%8B%EF%BC%9A%E8%B4%B4%E5%9B%BE%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%85%89%E7%85%A7/" target="_blank" rel="noopener">threejs基础下：贴图资源加载与光照</a></li><li><a href="https://winniecjy.github.io/2018/10/11/threejs%E8%BF%9B%E9%98%B6%E4%B8%8A%EF%BC%9A%E5%8A%A8%E7%94%BB/" target="_blank" rel="noopener">threejs进阶上：动画</a></li><li><a href="https://winniecjy.github.io/2018/10/11/threejs%E8%BF%9B%E9%98%B6%E4%B8%8B%EF%BC%9A%E4%BA%A4%E4%BA%92/" target="_blank" rel="noopener">threejs进阶下：交互</a></li><li><a href="https://winniecjy.github.io/2018/10/11/threejs%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/" target="_blank" rel="noopener">threejs问题集锦（随时更新）</a></li></ul></li><li><strong>DEMO</strong><ul><li>[BUG已修复] 3D地球，可拖动旋转。地球上有城市坐标，点击将该位置旋转到屏幕中央，下方显示城市名称，体验链接和效果展示如下：<br>链接：<a href="https://h5.m.jd.com/babelDiy/Zeus/iGeFvMLrNuQqQwwW4grhhREEDVS/index.html" target="_blank" rel="noopener">https://h5.m.jd.com/babelDiy/Zeus/iGeFvMLrNuQqQwwW4grhhREEDVS/index.html</a><br><img src="/images/weekly/05/qrearth.png" alt="扫一扫体验3D地球"><br><img src="/images/weekly/05/earth.gif" alt="3D地球效果">   </li><li>简单的全景，之前看到的一个全景是需要鱼眼贴图，且比例为2:1，对图片资源要求比较高，所以试着采用了六面体贴图实现了全景demo，感觉效果比球状全景要好很多，顶部和底部不会穿帮，对贴图的要求也降低了不少，只需要提供前/后/上/下/左/右6个面的图二图即可，体验链接和效果展示如下：<br>链接：<a href="https://h5.m.jd.com/babelDiy/Zeus/PmFEDsErFeuFrSgqVUsx11pbuZq/index.html" target="_blank" rel="noopener">https://h5.m.jd.com/babelDiy/Zeus/PmFEDsErFeuFrSgqVUsx11pbuZq/index.html</a><br><img src="/images/weekly/05/qraround.png" alt="扫一扫体验简单全景"><br><img src="/images/weekly/05/around.gif" alt="简单全景效果">   </li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>threejs问题集锦</title>
      <link href="/2018/10/11/threejs%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/"/>
      <url>/2018/10/11/threejs%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="#map">贴图</a></li><li><a href="#official-plugin">官方插件</a></li></ul><h3 id="贴图"><a href="#贴图" class="headerlink" title="贴图"></a><div id="map">贴图</div></h3><ol><li>贴图大小限制<br>WebGL对于texture的支持是有大小限制的，使用CanvasRenderer也会有同样的限制，只要手机支持WebGL，可以保证允许2048*2048的贴图，因此贴图最好不超过该限制。</li></ol><h4 id="官方插件"><a href="#官方插件" class="headerlink" title="官方插件"></a><div id="official-plugin">官方插件</div></h4><ol><li>使用最新版<code>OrbitControls.js</code>(2018/10/11)后，点击事件无法生效<br>最新版的代码在所有涉及到的事件中都添加了<code>event.preventDefault()</code>，注释掉对应的就可以了。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> threejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>threejs进阶下：交互</title>
      <link href="/2018/10/11/threejs%E8%BF%9B%E9%98%B6%E4%B8%8B%EF%BC%9A%E4%BA%A4%E4%BA%92/"/>
      <url>/2018/10/11/threejs%E8%BF%9B%E9%98%B6%E4%B8%8B%EF%BC%9A%E4%BA%A4%E4%BA%92/</url>
      
        <content type="html"><![CDATA[<h3 id="Raycaster"><a href="#Raycaster" class="headerlink" title="Raycaster"></a>Raycaster</h3><p><code>THREE.Raycaster</code>是threejs中比较重要的一个类，可以用于物体选择和碰撞检测。实现原理是生成一条从显示的起点到重点的一条射线，检测与射线相交的物体集合。    </p><h4 id="new-Raycaster-origin-direction-near-far"><a href="#new-Raycaster-origin-direction-near-far" class="headerlink" title="new Raycaster(origin, direction, near, far)"></a>new Raycaster(origin, direction, near, far)</h4><ul><li>origin：光线投射的起点向量</li><li>direction：光线投射的方向向量，归一化</li><li>near：投射近点，用于限制光线的起点，不能为负，缺省为0</li><li>far：投射远点，用于限制光线的终点，不能小于near，缺省为无穷大</li></ul><h4 id="setFromCamera-coords-camera"><a href="#setFromCamera-coords-camera" class="headerlink" title="setFromCamera(coords, camera)"></a>setFromCamera(coords, camera)</h4><p>用一个新的原点和方向向量来更新射线，参数说明如下。</p><ul><li><p>coords：鼠标的归一化二维坐标，归一化方法如下：</p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mouse.x = (e.clientX / <span class="built_in">window</span>.innerWidth) * <span class="number">2</span> <span class="number">-1</span>;</span><br><span class="line">mouse.y = - (e.clientY / <span class="built_in">window</span>.innerHeight) * <span class="number">2</span> + <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li><li><p>camera：射线起点处的相机，即把射线起点设置在该相机位置处</p></li></ul><h4 id="intersectObject-object-recursive"><a href="#intersectObject-object-recursive" class="headerlink" title="intersectObject(object, recursive)"></a>intersectObject(object, recursive)</h4><p>检查射线和物体之间的交叉点，交叉点按距离排序返回，最接近为第一个，返回值为一个对象数组。</p><ul><li>object：用于检测和射线相交的物体</li><li>recursive：若为true，则检查所有后代，否则只检查本身，缺省值为false</li></ul><h4 id="点击返回选中物体"><a href="#点击返回选中物体" class="headerlink" title="点击返回选中物体"></a>点击返回选中物体</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> raycaster = <span class="keyword">new</span> THREE.Raycaster(origin, direction, near, far);</span><br><span class="line">mouse.x = (e.clientX / <span class="built_in">window</span>.innerWidth) * <span class="number">2</span> <span class="number">-1</span>;</span><br><span class="line">mouse.y = - (e.clientY / <span class="built_in">window</span>.innerHeight) * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">raycaster.setFromCamera(mouse, camera);</span><br><span class="line"><span class="keyword">var</span> intersects = raycaster.intersectObjects(locationGroup.children, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h4 id="碰撞检测"><a href="#碰撞检测" class="headerlink" title="碰撞检测"></a>碰撞检测</h4><p>原理是通过以物体中心为起点，向各个顶点发出射线，检测射线是否与其他物体相交，若相交则检查最近的一个交点与射线起点的距离，如果这个距离比物体中心到物体顶点的距离要小，则说明发生了碰撞。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 获取物体中心点</span></span><br><span class="line"><span class="keyword">var</span> originP = obj.position.clone(); </span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;obj.geometry.vertices.length; i++) &#123;</span><br><span class="line">    <span class="comment">// 获取顶点坐标，将本地坐标乘以变换矩阵，得到了物体在世界坐标系中的值</span></span><br><span class="line">    <span class="keyword">var</span> vertex = obj.geometry.vertices[i].clone().applyMatrix4(obj.matrix);</span><br><span class="line">    <span class="comment">// 获取由中心指向顶点的向量</span></span><br><span class="line">    <span class="keyword">var</span> directV = vertex.sub(obj.position);</span><br><span class="line">    <span class="comment">// 方向向量归一化并发射射线</span></span><br><span class="line">    <span class="keyword">var</span> ray = <span class="keyword">new</span> Three.Raycaster(originP, directV.clone().normalize());</span><br><span class="line">    <span class="comment">// 检测相交物体和距离</span></span><br><span class="line">    <span class="keyword">var</span> collisionRes = ray.intersectObjects(collideMeshList, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (collisionRes.length&gt;<span class="number">0</span> &amp;&amp; collisionRes[<span class="number">0</span>].distance &lt; directV.length() ) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'发生碰撞'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><p><a href="https://blog.csdn.net/birdflyto206/article/details/52414382" target="_blank" rel="noopener">https://blog.csdn.net/birdflyto206/article/details/52414382</a></p><h3 id="相机操作"><a href="#相机操作" class="headerlink" title="相机操作"></a>相机操作</h3><p>模型移动常常通过相机的移动来实现，常用的相机控件如下：   </p><p>FirstPersonControls：第一人称控件，键盘移动，鼠标转动<br>FlyControls：飞行器模拟控件，键盘和鼠标来控制相机的移动和转动<br>RollControls：翻滚控件，FlyControls的简化版，可以绕z轴旋转<br>TrackballControls：轨迹球控件，用鼠标来轻松移动、平移和缩放场景<br>OrbitControls：轨道控件，在场景中绕某个对象旋转、平移<br>PathControls：路径控件，相机可以沿着预定义的路径移动。可以四处观看，但不能改变自身的位置</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> threejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>threejs进阶上：动画</title>
      <link href="/2018/10/11/threejs%E8%BF%9B%E9%98%B6%E4%B8%8A%EF%BC%9A%E5%8A%A8%E7%94%BB/"/>
      <url>/2018/10/11/threejs%E8%BF%9B%E9%98%B6%E4%B8%8A%EF%BC%9A%E5%8A%A8%E7%94%BB/</url>
      
        <content type="html"><![CDATA[<h3 id="简单动画"><a href="#简单动画" class="headerlink" title="简单动画"></a>简单动画</h3><p>对于一些简单的动画，比如旋转/位置变换等等，可以直接使用<code>requestAnimationFrame</code>来进行重绘，示例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    earth.rotation.y += <span class="number">0.005</span>;</span><br><span class="line">    cloud.rotation.y += <span class="number">0.003</span>;</span><br><span class="line"></span><br><span class="line">    renderer.render(scene, camera);</span><br><span class="line">    <span class="keyword">var</span> id = requestAnimationFrame(render);</span><br><span class="line">&#125;</span><br><span class="line">render();</span><br></pre></td></tr></table></figure></p><p><code>requestAnimationFrame</code>方法设置的动画，停止的方式如<code>cancelRequestFrame(id)</code>。<br>通过<code>requestAnimationFrame</code>实现的动画是匀速的，如果希望有缓动效果，可以结合补间动画库<a href="http://www.createjs.cc/tweenjs/" target="_blank" rel="noopener">tween.js</a>来实现。</p><h3 id="模型骨骼动画"><a href="#模型骨骼动画" class="headerlink" title="模型骨骼动画"></a>模型骨骼动画</h3><p><em>注意：复杂的骨骼动画容易出问题而且定位较难，建议<strong>谨慎使用</strong>。</em><br>three.js提供了各种各样的模型加载器，但是这些加载器的完善程度有待商榷，容易出现问题。官方目前推荐使用的是<code>glTF</code>格式的模型数据，支持较好。<br>使用官方示例的模型测试没什么问题，实际应用估计问题还比较多，考虑到使用模型导入动画的资源大小问题，实际应用可能比较困难，待之后使用到再进行补充。</p><h3 id="性能插件stats"><a href="#性能插件stats" class="headerlink" title="性能插件stats"></a>性能插件stats</h3><p>Three.js辅助库，显示性能帧数，每次刷新所用时间，占用内存。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 引入插件</span></span><br><span class="line">&lt;script src=<span class="string">"../lib/stats.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 实例化组件并添加到dom中</span></span><br><span class="line"><span class="keyword">var</span> stats = <span class="keyword">new</span> Stats();</span><br><span class="line">container.appendChild(stats.dom);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 在requestAnimationFrame()函数调用里面更新stats</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    stats.update();</span><br><span class="line">    requestAnimationFrame(render);</span><br><span class="line">&#125;</span><br><span class="line">render();</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> threejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>threejs基础下：贴图资源加载与光照</title>
      <link href="/2018/10/11/threejs%E5%9F%BA%E7%A1%80%E4%B8%8B%EF%BC%9A%E8%B4%B4%E5%9B%BE%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%85%89%E7%85%A7/"/>
      <url>/2018/10/11/threejs%E5%9F%BA%E7%A1%80%E4%B8%8B%EF%BC%9A%E8%B4%B4%E5%9B%BE%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%85%89%E7%85%A7/</url>
      
        <content type="html"><![CDATA[<h3 id="加载器Loaders"><a href="#加载器Loaders" class="headerlink" title="加载器Loaders"></a>加载器Loaders</h3><p>加载器是threejs中很重要的一个步骤，可以用于加载纹理/图片/模型/音频等资源，不同的loader对应不同格式的文件，loaders通用流程如下：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var loader = new THREE.[<span class="string">Loader</span>](<span class="link"></span>);</span><br><span class="line">/* </span><br><span class="line"> * 函数名：.load(url, onLoad, onProgress, onError)</span><br><span class="line"> * url：资源地址</span><br><span class="line"> * onLoad: 加载完成的回调，参数是已加载的资源文本</span><br><span class="line"> * onProgress: 加载中的调用，参数是XmlHttpRequest实例</span><br><span class="line"> * onError：加载出错时调用</span><br><span class="line">*/</span><br><span class="line">loader.load(url, onLoad, onProgress, onError)</span><br></pre></td></tr></table></figure></p><h4 id="1-TextureLoader-ImageLoader"><a href="#1-TextureLoader-ImageLoader" class="headerlink" title="1. TextureLoader/ImageLoader"></a>1. TextureLoader/ImageLoader</h4><p>加载图片资源，可以作为贴图(map)覆盖在物体上或者直接绘制在canvas上。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loader = <span class="keyword">new</span> THREE.TextureLoader();</span><br><span class="line">loader.load(<span class="string">'texture/earth.jpg'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> texture </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 作为纹理，或直接使用TextureLoader</span></span><br><span class="line">    <span class="comment">// var geometry = new THREE.SphereGeometry(15, 10, 10);</span></span><br><span class="line">    <span class="comment">// var meterial = new THREE.MeshBasicMaterial(&#123;color: 0x739783, map:texture&#125;);</span></span><br><span class="line">    <span class="comment">// earth = new THREE.Mesh(geometry, material);</span></span><br><span class="line">    <span class="comment">// scene.add(earth);</span></span><br><span class="line">    <span class="comment">// 直接绘制在canvas上</span></span><br><span class="line">    <span class="keyword">var</span> canvas =<span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span><br><span class="line">    <span class="keyword">var</span> context = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">    context.drawImage(texture, <span class="number">100</span>, <span class="number">100</span>);    </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h4 id="2-AudioLoader"><a href="#2-AudioLoader" class="headerlink" title="2. AudioLoader"></a>2. AudioLoader</h4><p>加载音乐也是常见的需求，加载音乐并播放的实现方法如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化侦听器并添加到相机中</span></span><br><span class="line"><span class="keyword">var</span> listener = <span class="keyword">new</span> THREE.AudioListener();</span><br><span class="line">camera.add(listener);</span><br><span class="line"><span class="comment">// 实例化一个音频对象并添加到场景中</span></span><br><span class="line"><span class="keyword">var</span> audio = <span class="keyword">new</span> THREE.audio( audioListener );</span><br><span class="line">scene.add(audio);</span><br><span class="line"><span class="comment">// 加载资源</span></span><br><span class="line"><span class="keyword">var</span> loader = <span class="keyword">new</span> THREE.AudioLoader();</span><br><span class="line">loader.load( <span class="string">'audio/amobient.ogg'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">audioBuffer</span>) </span>&#123;</span><br><span class="line">    audio.setBuffer(audioBuffer);</span><br><span class="line">    audio.play();</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">xhr</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( (xhr.loaded / xhr.total * <span class="number">100</span>) + <span class="string">"% is loaded"</span> );</span><br><span class="line">&#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">xhr</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'An error happened'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>音频可以做到与场景相关，比如说做出3D音效，或者是让音乐可视化。在这里暂时不讨论，在之后使用到的时候再进行具体研究。</p><h4 id="3-JSONLoader"><a href="#3-JSONLoader" class="headerlink" title="3. JSONLoader"></a>3. JSONLoader</h4><p>实际项目中的物体可能十分复杂，不可以简单地用几何体实现，3D模型导出的JSON文件即可以存放物体的模型，也可以存放其材质和动画信息。解析一个 JSON 结构的数据并返回一个 object ，包含解析后的 geometry 和 materials。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loader = <span class="keyword">new</span> <span class="type">THREE</span>.JSONLoader();</span><br><span class="line">loader.load(</span><br><span class="line">    <span class="string">'./monster/monster.js'</span>,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> </span>(geometry, materials) &#123;</span><br><span class="line">        <span class="keyword">var</span> material = <span class="keyword">new</span> <span class="type">THREE</span>.MultiMaterial(materials);</span><br><span class="line">        <span class="keyword">var</span> object = <span class="keyword">new</span> <span class="type">THREE</span>.Mesh(geometry, material);</span><br><span class="line">        scene.add(object);</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p><strong>注意</strong>：</p><ul><li>使用加载的资源时，要适时重新渲染，否则无法生效。</li><li>存在跨域问题。</li></ul><hr><h3 id="贴图详解"><a href="#贴图详解" class="headerlink" title="贴图详解"></a>贴图详解</h3><p>大部分贴图都是通过材质（Meterial）中的属性来应用到模型上，不同材质支持的贴图不同，需要具体问题具体分析，以下列出目前使用过的贴图介绍。      </p><h4 id="1-凹凸贴图（Bump-Map）"><a href="#1-凹凸贴图（Bump-Map）" class="headerlink" title="1. 凹凸贴图（Bump Map）"></a>1. 凹凸贴图（Bump Map）</h4><p>用于给模型增加立体感，实际上并没有改变模型的形状，而是通过模型表面的阴影来达到凹凸的效果，使用方法如下：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> meterial = <span class="keyword">new</span> <span class="type">THREE</span>.MeshPhongMaterial(&#123;</span><br><span class="line">    bumpMap: <span class="type">textureLoader</span>.load(<span class="string">'./img_bump.jpg'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h4 id="2-漫反射贴图（Diffuse-Map）"><a href="#2-漫反射贴图（Diffuse-Map）" class="headerlink" title="2. 漫反射贴图（Diffuse Map）"></a>2. 漫反射贴图（Diffuse Map）</h4><p>用于表现物体表面的反射和表面颜色，即表现出物体被光照射到而显现的颜色和强度。漫反射贴图可以反映出物体的固有色及纹理，还有贴图上的光影。对于由几个模型拼接成的模型来说，光影是不必要的，因为通过打光就可以实现光影效果了，比如由许多砖模型拼凑成的一道墙。而对于一个整体，比如说一道墙的模型，砖块是由贴图实现的，那么在砖缝上绘制投影就很有必要了。</p><h4 id="3-高光贴图（Specular-Map）"><a href="#3-高光贴图（Specular-Map）" class="headerlink" title="3. 高光贴图（Specular Map）"></a>3. 高光贴图（Specular Map）</h4><p>用来表现当光线照到模型表面时其表面属性，不同材质反射光的强度不同。越偏向RGB(0,0,0)的部分高光越弱，越偏向RGB(255,255,255)的部分高光越强。高光贴图需要与凹凸贴图和漫反射贴图配合使用，展现的材质才会趋近于真实世界。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> meterial = <span class="keyword">new</span> <span class="type">THREE</span>.MeshPhongMaterial(&#123;</span><br><span class="line">    specular: <span class="type">0x404040</span>, <span class="comment">// 高光颜色</span></span><br><span class="line">    shininess: <span class="type">5</span>,              <span class="comment">// 高光平滑度，默认30，值越高越强烈</span></span><br><span class="line">    specularMap: <span class="type">textureLoader</span>.load(<span class="string">'./img_spec.jpg'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h4 id="4-环境贴图（Cube-Map）"><a href="#4-环境贴图（Cube-Map）" class="headerlink" title="4. 环境贴图（Cube Map）"></a>4. 环境贴图（Cube Map）</h4><p>通过一个虚拟的立方体包围住物体，通过上下左右前后6张图来模拟真实环境，threejs将这些图片渲染成无缝环境盒子。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 立方体环境，顺序是前后上下右左</span></span><br><span class="line"><span class="keyword">var</span> cubeTexture = <span class="keyword">new</span> <span class="type">THREE</span>.CubeTextureLoader().setPath(<span class="string">'../img/skyBox'</span>).load(&#123;</span><br><span class="line">    <span class="string">'px.jpg'</span>, <span class="string">'nx.jpg'</span>,</span><br><span class="line">    <span class="string">'py.jpg'</span>, <span class="string">'ny.jpg'</span>,</span><br><span class="line">    <span class="string">'pz.jpg'</span>, <span class="string">'nz.jpg'</span></span><br><span class="line">&#125;)</span><br><span class="line">scene.background = cubeTexture;</span><br></pre></td></tr></table></figure></p><hr><h3 id="光源Lights"><a href="#光源Lights" class="headerlink" title="光源Lights"></a>光源Lights</h3><p>为了让图片看起来更加立体真实，通常需要增加一些光线。<br><strong>注意：</strong>只有部分的材质会受到光照的影响，比如MeshPhongMaterial、MeshLambertMaterial等，如MeshBasicMaterial是不会受到光照影响的。 </p><h4 id="1-环境光（AmbientLight）"><a href="#1-环境光（AmbientLight）" class="headerlink" title="1. 环境光（AmbientLight）"></a>1. 环境光（AmbientLight）</h4><p>这种光应用到全局范围内的所有对象，可用于提高全局亮度，弱化阴影，给全局添加一个基调色。<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> light = <span class="function"><span class="keyword">new</span> <span class="title">THREE</span>.<span class="title">AmbientLight</span>(color, instensity); <span class="comment">// 创建一个给定颜色和强度的环境光</span></span></span><br><span class="line"><span class="function"><span class="title">scene</span>.<span class="title">add</span>(light);</span></span><br></pre></td></tr></table></figure></p><h4 id="2-平行光（DirectionalLight）"><a href="#2-平行光（DirectionalLight）" class="headerlink" title="2. 平行光（DirectionalLight）"></a>2. 平行光（DirectionalLight）</h4><p>产生平行的光线，当材质为<code>MeshLambertMaterial</code>或<code>MeshPhongMaterial</code>时才会受到影响。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> light = <span class="keyword">new</span> <span class="type">THREE</span>.DirectionalLight(hex, instensity)</span><br></pre></td></tr></table></figure></p><h4 id="3-点光源（PointLight）"><a href="#3-点光源（PointLight）" class="headerlink" title="3. 点光源（PointLight）"></a>3. 点光源（PointLight）</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="strong">*</span></span><br><span class="line"><span class="strong">*</span> hex：颜色的RGB值，如0x333333</span><br><span class="line"><span class="bullet">* </span>intensity：光强，optional</span><br><span class="line"><span class="bullet">* </span>distance：光照为0处到光源的距离，0表示到无穷远处为0，默认值，optional</span><br><span class="line"><span class="bullet">* </span>decay：沿着光照距离的衰退量，为2时实现现实世界的光衰减，缺省为1，optional</span><br><span class="line"><span class="strong">*/</span></span><br><span class="line"><span class="strong">var light = new THREE.PointLight(hex, intensity, distance, decay)</span></span><br></pre></td></tr></table></figure><h4 id="PointLight和DirectionalLight常用属性"><a href="#PointLight和DirectionalLight常用属性" class="headerlink" title="PointLight和DirectionalLight常用属性"></a>PointLight和DirectionalLight常用属性</h4><table><thead><tr><th>常用属性</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>target</td><td>-</td><td>阴影相机定位的目标，必须为THREE.Object3D对象（如THREE.Mesh）</td></tr><tr><td>penumbra</td><td>0.0</td><td>聚光锥的半影衰减百分比[0, 1]</td></tr><tr><td>shadow</td><td>-</td><td>用于存储光照阴影的所有信息，具体属性可参考<a href="http://techbrood.com/threejs/docs/#%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C/%E5%85%89%E7%85%A7(Lights" target="_blank" rel="noopener">光照阴影</a>/%E5%85%89%E7%85%A7%E9%98%B4%E5%BD%B1(LightShadow))</td></tr><tr><td>castShadow</td><td>false</td><td>是否投射动态阴影，<font color="tomato"><em>很耗费计算资源</em></font></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> threejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>threejs基础上：初始化</title>
      <link href="/2018/10/11/threejs%E5%9F%BA%E7%A1%80%E4%B8%8A%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
      <url>/2018/10/11/threejs%E5%9F%BA%E7%A1%80%E4%B8%8A%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>Three.js是一个用于简化webGL编程的3D库，即使在不支持webGL的环境下也能做到优雅降级，以下教程将围绕构建这个地球DEMO来展开。   </p><p>ThreeJs中最主要的有三个对象场景（scene）、相机（camera）、渲染器（renderer）。scene是布景空间，camera是拍摄镜头，render是用来将scene和camera生成的场景渲染到屏幕上，有了这三个对象才能将场景渲染到网页上去。   </p><hr><h3 id="初始化对象"><a href="#初始化对象" class="headerlink" title="初始化对象"></a>初始化对象</h3><h4 id="1、初始化场景scene"><a href="#1、初始化场景scene" class="headerlink" title="1、初始化场景scene"></a>1、初始化场景scene</h4><p>场景相当于是一个容器来容纳所有的物体，创建场景如下：   </p><p><code>var scene = new THREE.Scene();</code>   </p><p>设置背景scene.background，可以为纯色，也可以为图片资源：</p><p><code>scene.background = new THREE.Color(0xffffff)</code></p><h4 id="2、相机camera"><a href="#2、相机camera" class="headerlink" title="2、相机camera"></a>2、相机camera</h4><p>THREE中的camera有三种，最常用的是远景相机，也就是人眼观察世界的模式，在相机拍摄的3D空间之外的物体不会被渲染。</p><p><code>var camera = new THREE.PespectiveCamera(fov, aspect, near,far);</code></p><table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>fov</td><td>number</td><td>50</td><td>视野角度</td></tr><tr><td>aspect</td><td>number</td><td>1</td><td>实际窗口的宽高比</td></tr><tr><td>near</td><td>number</td><td>0.1</td><td>相机到近平面的距离</td></tr><tr><td>far</td><td>number</td><td>2000</td><td>相机到远平面的距离</td></tr></tbody></table><h4 id="3、初始化渲染器renderer"><a href="#3、初始化渲染器renderer" class="headerlink" title="3、初始化渲染器renderer"></a>3、初始化渲染器renderer</h4><p>创建一个WebGL渲染器，可以通过插件<code>Detector.js</code>检测canvas/webgl兼容性，并在页面添加不兼容信息。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> renderer = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(Detector.webgl)</span><br><span class="line">    renderer = <span class="keyword">new</span> THREE.WebGLRenderer(&#123;<span class="attr">antialias</span>: <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(Detector.canvas)</span><br><span class="line">    renderer = <span class="keyword">new</span> THREE.CanvasRenderer()      </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'不兼容'</span>)</span><br></pre></td></tr></table></figure></p><p>antialias属性开启用于抗锯齿。初始化渲染器有一些<a href="http://techbrood.com/threejs/docs/#%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C/%E6%B8%B2%E6%9F%93%E5%99%A8%28Renderers%29/WebGL%E6%B8%B2%E6%9F%93%E5%99%A8%28WebGLRenderer%29" target="_blank" rel="noopener">其他参数</a>，一般不需要设置使用默认值即可。   </p><h5 id="setSize-width-height-updateStyle"><a href="#setSize-width-height-updateStyle" class="headerlink" title="setSize(width, height, updateStyle)"></a>setSize(width, height, updateStyle)</h5><p>调整输出canvas尺寸（宽度，高度），通常设置为屏幕大小，若不是则需考虑设备像素比并设置视口（viewport）以匹配尺寸，updateStyle为true时，则显式添加像素输出canvas的样式中，默认为false。</p><h5 id="setViewport-x-y-width-height"><a href="#setViewport-x-y-width-height" class="headerlink" title="setViewport(x, y, width, height)"></a>setViewport(x, y, width, height)</h5><p>设置视口，从(x, y)到(x+width, y+height)，<strong>*注意：</strong>此处的(x, y)是该区域的左下角*</p><h5 id="renderer-domElement"><a href="#renderer-domElement" class="headerlink" title="renderer.domElement"></a>renderer.domElement</h5><p>渲染器renderer的domElement元素表示渲染器中的画布，通常需要将domElement挂载到body下面，渲染的结果就能正确显示了。   </p><p><code>document.body.appendChild(renderer.domElement)</code>;   </p><h5 id="setPixelRatio-value"><a href="#setPixelRatio-value" class="headerlink" title="setPixelRatio(value)"></a>setPixelRatio(value)</h5><p>设置设备像素比，用于HiDPI设备防止模糊输出canvas。</p><p><code>renderer.setPixelRatio(window.devicePixelRatio)</code></p><p>到这里，我们已经构建好了基本的“舞台”，就差“演员”上场了~</p><hr><h3 id="展示一个球体"><a href="#展示一个球体" class="headerlink" title="展示一个球体"></a>展示一个球体</h3><h4 id="1-创建物体"><a href="#1-创建物体" class="headerlink" title="1. 创建物体"></a>1. 创建物体</h4><h5 id="Mesh对象"><a href="#Mesh对象" class="headerlink" title="Mesh对象"></a>Mesh对象</h5><p>可以通过类似以下方式创建：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> geometry = <span class="keyword">new</span> THREE.SphereGeometry(<span class="number">15</span>, <span class="number">10</span>, <span class="number">10</span>); <span class="comment">/* 几何模型，用于定义结构 */</span></span><br><span class="line"><span class="keyword">var</span> meterial = <span class="keyword">new</span> THREE.MeshNormalMeterial(); <span class="comment">/* 材质，用于定义外观 */</span></span><br><span class="line"><span class="keyword">var</span> earth = <span class="keyword">new</span> THREE.Mesh(geometry, meterial);</span><br></pre></td></tr></table></figure></p><p>一个普通的物体对象的构成需要两个参数。</p><ul><li><strong>Geometry</strong>：在threejs中有两种几何体（基本几何体和buffer几何体）。<br><strong><em>基本几何体</em></strong> 是通过类来管理自身信息，比如顶点位置、颜色等，便于操作，用于创建经常变化的物体；<br><strong><em>buffer几何体</em></strong> 是用数组存储的，且保存在内存缓存区，减低对GPU的消耗，适用于一经创建就不需要修改的物体。<br>不同的集合</li><li><strong>Meterial</strong>：不同材质的显示效果不同，可以在具体使用到的时候再进行查看，以下给出简单地描述，在需要使用的时候才去看具体的材质即可：   </li></ul><table><thead><tr><th>材质</th><th>描述</th></tr></thead><tbody><tr><td>Material</td><td>材料基类</td></tr><tr><td>MeshBasicMaterial</td><td>基于深度着色的材质，由物体和相机的距离决定颜色，可以做出逐渐消失的效果</td></tr><tr><td>MeshDepthMaterial</td><td>渲染成简单的平面多边形，不考虑光照的影响</td></tr><tr><td>MeshNormalMaterial</td><td>计算法向量颜色的材质</td></tr><tr><td>MeshLambertMaterial</td><td>对光源做出反应，可用于创建暗淡的材质</td></tr><tr><td>MeshPhongMaterial</td><td>对光源做出反应，可用于创建光亮的材质</td></tr><tr><td>MeshFaceMaterial</td><td>为几何体的每一面指定材质，更像是一种材质容器</td></tr><tr><td>THREE.SceneUtil.createMultiMaterialObject</td><td>同时应用多种材质</td></tr><tr><td>ShaderMaterial</td><td>自己创建着色程序，需要通过GLSL语言</td></tr><tr><td>LineBasicMaterial</td><td>只能应用于THREE.Line</td></tr><tr><td>LineDashedMaterial</td><td>只能应用于THREE.Line</td></tr></tbody></table><p> 附：Meterial的<a href="http://techbrood.com/threejs/docs/#%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C/%E6%9D%90%E6%96%99%28Materials%29/%E6%9D%90%E6%96%99%28Material%29" target="_blank" rel="noopener">所有通用属性</a>，其中需要注意的有：   </p><ul><li>overdraw：解决绘制三角形时出现间隙，当设置为0.5时效果较好</li></ul><h4 id="2-添加到场景"><a href="#2-添加到场景" class="headerlink" title="2. 添加到场景"></a>2. 添加到场景</h4><p>将物体添加到场景中：   </p><p><code>scene.add(earth);</code></p><p>注意通过scene.add方法添加到场景的位置默认为原点(0,0,0)，此时跟相机位置是重叠的，需要移动一下相机的位置才能够看到物体。</p><p><code>camera.position.z = 50;</code></p><h4 id="3-渲染页面"><a href="#3-渲染页面" class="headerlink" title="3. 渲染页面"></a>3. 渲染页面</h4><p><code>renderer.render(scene, camera);</code>   </p><p>这样我们就简单地渲染出了一个带有静态球体的场景，由于此处使用的材质只是一个颜色，所以添加了经纬线使他看起来更像球体。    </p><hr><h3 id="附表：对象的通用属性-函数"><a href="#附表：对象的通用属性-函数" class="headerlink" title="*附表：对象的通用属性/函数"></a>*<em>附表：对象的通用属性/函数</em></h3><p>以下给出3D对象的通用属性与函数，属性值可以直接通过console.log查看。</p><table><thead><tr><th>属性/函数</th><th>描述</th></tr></thead><tbody><tr><td>position</td><td>决定对象相对于其父对象的位置，大部分情况下一个对象的父对象是THREE.Scene()对象</td></tr><tr><td>rotation</td><td>对象的局部旋转，单位为弧度</td></tr><tr><td>scale</td><td>控制对象的缩放</td></tr><tr><td>up</td><td>空间向上的方向，缺省是THREE.Vector3(0, 1, 0)</td></tr><tr><td>translateX/ranslateY/ranslateZ(distance)</td><td>沿X/Y/Z轴平移对象</td></tr><tr><td>rotateX/rotateY/rotateZ(rad)</td><td>沿X/Y/Z轴平移对象</td></tr><tr><td>lookAt(vector)</td><td>一个世界向量观察点，用于旋转模型以面对观察点</td></tr><tr><td>add(object, …)</td><td>添加object为该对象的子对象</td></tr><tr><td>remove(object, …)</td><td>删除object子对象</td></tr><tr><td>clone(recursive)</td><td>克隆对象，当recursive为true时（默认为true），对象的后代也会被克隆</td></tr></tbody></table><p>以上属性可以通过<code>obj.[attr].x/obj.[attr].y/obj.[attr].z</code>来设置，或者是一次性设置3个值<code>obj.[attr].set(x, y, z)</code> </p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> threejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报04（20181005）</title>
      <link href="/2018/10/05/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A504%EF%BC%8820181005%EF%BC%89/"/>
      <url>/2018/10/05/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A504%EF%BC%8820181005%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、本周项目：岁月神偷H5（9-20-10-3）"><a href="#一、本周项目：岁月神偷H5（9-20-10-3）" class="headerlink" title="一、本周项目：岁月神偷H5（9.20 - 10.3）"></a>一、本周项目：岁月神偷H5（9.20 - 10.3）</h3><ol><li>问题与解决   </li></ol><ul><li>在微信和浏览器中有上拉/下拉回弹效果，在此次H5中需要禁用<br>考虑到H5中会有两种状态，一种是手指滑动，屏幕滚动；另一种是手指滑动，屏幕不滚动，展示一些动画效果。所以此次采用iscroll控制滚动，禁用掉原生，可以避免微信和浏览器下拉/上拉回弹效果，同时也能更好的控制滚动。   </li><li>之前一直使用ssh上传git代码，此次不知道是什么原因突然无法push/clone？<br>由于急着保存代码所以改用了http协议连接git.jd.com，后期再详细找原因。     </li><li>ios10以下 safari不支持muted/volume属性，也就是无法静音？<br>采用了一种暴力方法，当需要静音音频的时候直接移除audio元素后再重新添加。（可以用pause来代替muted）  </li></ul><ol start="2"><li>进度：90%，运营方希望修改一些设计，需要追加排期   </li></ol><h3 id="二、iscroll-js"><a href="#二、iscroll-js" class="headerlink" title="二、iscroll.js"></a>二、iscroll.js</h3><ol><li><strong>适用</strong>：基本的内容滚动控制，模拟原生IOS应用里的滚动列表操作，还可以实现缩放、拉动刷新、精确捕捉元素、自定义滚动条等功能。</li><li><strong>问题</strong>：使用的本意是为了避免自己写的兼容性问题，版本不够稳定，部分版本会有闪屏或滑动不流畅的情况，更换版本以后问题解决。</li><li><strong>反思</strong>：这次找这类型的插件有很多，但是没有找到特别官方稳定的插件，在项目中使用还是比较有风险，以后应当尽量避免，万不得已的时候，选择应该更加偏向于轻量级的插件，有问题看源码也不至于毫无头绪。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报03（20180923）</title>
      <link href="/2018/09/23/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A503%EF%BC%8820180923%EF%BC%89/"/>
      <url>/2018/09/23/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A503%EF%BC%8820180923%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、本周项目：岁月神偷H5（9-20-10-3）"><a href="#一、本周项目：岁月神偷H5（9-20-10-3）" class="headerlink" title="一、本周项目：岁月神偷H5（9.20 - 10.3）"></a>一、本周项目：岁月神偷H5（9.20 - 10.3）</h3><ol><li><strong>进度</strong>：20%   </li><li><strong>风险</strong>：H5比较长，涉及的动画比较多，容易有兼容性问题<br> <strong>预防</strong>：尽量在10月2号左右完成项目，多预留测试时间</li></ol><h3 id="二、近期学习"><a href="#二、近期学习" class="headerlink" title="二、近期学习"></a>二、近期学习</h3><ol><li>three.js：WebGL第三方库</li></ol><ul><li><strong>描述</strong>：目前使用比较广泛的3D动画库</li><li><strong>进度</strong>：50%</li><li><strong>输出</strong>：目前正在整理学习文章，已经完成前半部分基础篇，详细文章如下，一些复杂的交互等大促过后再继续学习~   <ul><li><a href="https://winniecjy.github.io/2018/09/24/threejs%E5%9F%BA%E7%A1%80%E4%B8%8A%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD/" target="_blank" rel="noopener">threejs基础上：初始化与资源加载</a>   </li><li><a href="https://winniecjy.github.io/2018/09/24/threejs%E5%9F%BA%E7%A1%80%E4%B8%8B%EF%BC%9A%E5%85%89%E7%85%A7%E4%B8%8E%E8%B4%B4%E5%9B%BE/" target="_blank" rel="noopener">threejs基础下：光照与贴图</a>   </li><li>DEMO：地球，点击坐标显示城市名称，并旋转地球，使坐标旋转到屏幕正中（demo目前定位计算方法还有问题）<br><img src="/images/weekly/03/earth.gif" alt="earth">     </li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报02（20180909）</title>
      <link href="/2018/09/09/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A502%EF%BC%8820180909%EF%BC%89/"/>
      <url>/2018/09/09/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A502%EF%BC%8820180909%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、项目汇报"><a href="#一、项目汇报" class="headerlink" title="一、项目汇报"></a>一、项目汇报</h3><h4 id="1-居家大赏主会场总结"><a href="#1-居家大赏主会场总结" class="headerlink" title="1. 居家大赏主会场总结"></a>1. 居家大赏主会场总结</h4><ul><li>对于点击跳转到其他页面的埋点，需要设置延时让埋点成功上报，避免埋点尚未上报成功页面就已经跳转。</li><li>IOS下滚动卡顿（手指移动开页面就马上停止滚动），通过添加属性：-webkit-overflow-scrolling: touch ，问题解决。</li><li>img不设置display:block时，设置宽高100%会有一点偏移</li><li>此次页面需要内嵌到京东APP的排行榜，由于之前沟通没有注意到投放途径，加上运营的疏忽，没有安排联调时间。在排期结束后才发现投放页面冲突，出现BUG。    <ul><li><strong>反思</strong>：下次在需求评审时要注意页面投放途径，如果需要内嵌到京东APP需要安排联调时间，避免再次出现这种情况。</li><li><strong>内嵌排行榜（RN WebView）的BUG总结</strong><ul><li>第二次拉取数据不成功：在onload事件完成之后，再次调用接口获取数据代码失效，修改逻辑为在onload事件之前取出所有数据。这种解决方法的缺点是首屏加载时间略长，用户体验不够好。</li><li>进入页面后自动弹出分享弹框：需要加入环境判定，该属性为异步注入，需要延时判定，如下：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">window</span>.inRankingListRN) &#123; </span><br><span class="line">            <span class="comment">// 排行榜环境下 </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123; ... &#125;</span><br><span class="line">    &#125;, <span class="number">200</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ul><h4 id="2-相机节头图（PC-amp-APP）"><a href="#2-相机节头图（PC-amp-APP）" class="headerlink" title="2. 相机节头图（PC&amp;APP）"></a>2. 相机节头图（PC&amp;APP）</h4><p>jshop的视频链接假如需要为可配置的，则必须为jshop生成的视频链接，目前jshop生成的视频链接有问题，无法自动播放，可能是jshop视频存储刚迁移了云服务器的原因。</p><h3 id="二、近期试玩"><a href="#二、近期试玩" class="headerlink" title="二、近期试玩"></a>二、近期试玩</h3><h4 id="1-snap-svg-——-一个操作svg的js库"><a href="#1-snap-svg-——-一个操作svg的js库" class="headerlink" title="1. snap.svg —— 一个操作svg的js库"></a>1. snap.svg —— 一个操作svg的js库</h4><ul><li>相关链接   <ul><li>官网：<a href="http://snapsvg.io/" target="_blank" rel="noopener">http://snapsvg.io/</a>   </li><li>中文API：<a href="https://www.zhangxinxu.com/GitHub/demo-Snap.svg/demo/basic/Element.add.php" target="_blank" rel="noopener">https://www.zhangxinxu.com/GitHub/demo-Snap.svg/demo/basic/Element.add.php</a>   </li></ul></li><li>优点<ul><li>兼容IE9+、Safari、Chrome、Firefox、Opera；   </li><li>使用起来与jquery很相似，上手快，官方API也比较齐全；   </li><li>大小为82KB</li></ul></li><li><p>应用：可用于实现一些简单的动画，尤其是一些过渡效果无法通过CSS很好的实现，svg可以替代帧动画和GIF，减少加载资源，快速开发，附上2个假假的demo如下，代码量都没有超过50行：<br>  <img src="/images/weekly/02/snapsvg0.gif" alt="01"><br>  <img src="/images/weekly/02/snapsvg1.gif" alt="02"><br>  目前在PC端使用比较良好，snap.svg移动端 iOS、安卓 X5 内核、安卓原生浏览器兼容性都不错，只有部分属性不兼容，以上两个栗子在组内的测试机上显示正常。   </p></li><li><p>兼容性数据来源：   </p><ul><li><a href="https://aotu.io/notes/2017/01/22/snapsvg/index.html" target="_blank" rel="noopener">https://aotu.io/notes/2017/01/22/snapsvg/index.html</a>  </li><li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/SVG/Element</a>   </li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>两周一报01（20180826）</title>
      <link href="/2018/08/26/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A501%EF%BC%8820180826%EF%BC%89/"/>
      <url>/2018/08/26/%E4%B8%A4%E5%91%A8%E4%B8%80%E6%8A%A501%EF%BC%8820180826%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h3 id="一、本周项目：居家大赏主会场"><a href="#一、本周项目：居家大赏主会场" class="headerlink" title="一、本周项目：居家大赏主会场"></a>一、本周项目：居家大赏主会场</h3><h4 id="问题与解决"><a href="#问题与解决" class="headerlink" title="问题与解决"></a>问题与解决</h4><ol><li>安装过程中，经常出现类似<code>permission denied, scandir &#39;路径名称&#39;</code>的错误信息？<br>通过<code>sudo chown -R username &quot;路径名&quot;</code>将指定文件的拥有者改为指定的用户或组，从而获得权限。   </li><li>dispatch的函数参数名称与定义的参数列表必须名称一致，否则会接受不到数据   </li><li><code>setState(...): Cannot update during an existing state transition (such as within render or another component&#39;s constructor) ...</code><br>在reducer中不能有改变状态的举动。</li><li><p>browser-sync在命令行运行，只能从index.html文件开始，如果配置到gulp中（webpack类似），可以通过如下配置实现从不同文件开始运行服务器：     </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gulp</span></span><br><span class="line">browserSync.init(&#123;</span><br><span class="line">    server:&#123;</span><br><span class="line">        baseDir:<span class="string">'./app'</span>,</span><br><span class="line">        index:<span class="string">'name.html'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>加入时间戳防止缓存     </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.write(<span class="string">"&amp;lt;script type='text/javascript' src='//site.com?t="</span> + <span class="built_in">Date</span>.now() + <span class="string">"'&amp;gt;&amp;lt;\/script&amp;gt;"</span>);</span><br></pre></td></tr></table></figure></li><li><p>查看埋点数据包（包括点击跳转）<br>Network面板选择<code>Perserve log</code>，搜索<code>m?</code>   </p></li><li>沉浸式标题设置: <code>@jmfe/jm-webview：enableTransparent</code>      </li><li>直接打出人民币单位无法确保所有字体下都是双横线，可以使用<code>&amp;yen;</code>       </li></ol><h4 id="React模板总结"><a href="#React模板总结" class="headerlink" title="React模板总结"></a>React模板总结</h4><ol><li>React: 用于构建界面的javascript库      </li><li>Redux：用于协助React状态管理的工具      </li><li>Redux-Saga：用于管理redux应用异步操作的中间件<br>对应到React会场模板中，需要修改的文件及对应功能如下：     <ul><li>components：一个文件夹为一个组件，主要涉及UI的展示和事件绑定   </li><li>reducers: 状态声明，通常返回的是一系列数据   </li><li>sagas：负责异步交互事件的响应函数（包括埋点，领券等等）的具体实现，其中index.js负责主线程的数据加载等事务   </li><li>services/fetch-data.js: 拉取数据   </li><li>constants/index.js: 一些固定参数，如pageId, UUID等等   </li></ul></li></ol><h3 id="二、有趣的实现"><a href="#二、有趣的实现" class="headerlink" title="二、有趣的实现"></a>二、有趣的实现</h3><ol><li>纯代码实现的动态图案<br><img src="/images/weekly/01/cssdoodle0.gif" alt="01"><br><img src="/images/weekly/01/cssdoodle1.gif" alt="02"><br><code>&lt;css-doodle /&gt;</code> : 一个比较新的项目，内设一些常用的图案/函数/属性。目前兼容性很差，只在最新版的chrome和safari下支持，尚未考虑fallback。    </li><li>两个火焰效果<br><img src="/images/weekly/01/fire0.gif" alt="01"><br><img src="/images/weekly/01/fire1.gif" alt="02">   </li></ol>]]></content>
      
      
      <categories>
          
          <category> 周报 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 周报 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React前置知识01：SASS和COMPASS</title>
      <link href="/2018/08/10/React%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%8601%EF%BC%9ASASS%E5%92%8CCOMPASS/"/>
      <url>/2018/08/10/React%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%8601%EF%BC%9ASASS%E5%92%8CCOMPASS/</url>
      
        <content type="html"><![CDATA[<h2 id="Sass与Compass"><a href="#Sass与Compass" class="headerlink" title="Sass与Compass"></a>Sass与Compass</h2><ol><li>Compass是Sass基础上二次开发的工具。</li><li><strong>优点</strong>：写出更优秀的CSS；解决CSS编写过程中的痛点问题（如精灵图合图等）；有效组织样式、图片、字体等项目元素。</li><li><strong>应用场景</strong>：重构时自动化CSS；项目周期内更好组织项目内容。</li></ol><h4 id="sass和-scss"><a href="#sass和-scss" class="headerlink" title=".sass和.scss"></a>.sass和.scss</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .sass：类ruby语法，空格敏感</span></span><br><span class="line">h1</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#000</span></span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fff</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// .scss：类css语法，花括号</span></span><br><span class="line"><span class="selector-tag">h1</span> &#123;<span class="attribute">color</span>: red;&#125;</span><br></pre></td></tr></table></figure><h2 id="Sass"><a href="#Sass" class="headerlink" title="Sass"></a>Sass</h2><h4 id="sass安装及使用"><a href="#sass安装及使用" class="headerlink" title="sass安装及使用"></a>sass安装及使用</h4><ol><li>安装ruby和rvm（可选，用于版本管理）</li><li>通过gem(ruby安装自带的一个包管理器)安装sass。  <figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gem sources -l <span class="string">//</span> 显示当前的源</span><br><span class="line">gem sources <span class="params">--remove</span> <span class="string">...</span> <span class="string">//</span> 删除源<span class="string">...</span></span><br><span class="line">gem sources -a <span class="string">...</span> <span class="string">//</span> 添加源<span class="string">..</span></span><br><span class="line">gem install sass <span class="string">//</span> 安装sass</span><br><span class="line">gem install sass <span class="params">--version=3</span>.5.6 <span class="string">//</span> 安装版本为3.5.6的sass</span><br><span class="line">gem uninstall sass <span class="string">//</span> 卸载sass</span><br></pre></td></tr></table></figure></li></ol><h4 id="sass语法介绍"><a href="#sass语法介绍" class="headerlink" title="sass语法介绍"></a>sass语法介绍</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sass main<span class="selector-class">.scss</span> main<span class="selector-class">.css</span> <span class="comment">// 编译成css文件</span></span><br><span class="line">sass-convert main<span class="selector-class">.scss</span> main<span class="selector-class">.sass</span> <span class="comment">// .sass和.scss</span></span><br></pre></td></tr></table></figure><ol><li><p>变量：存储一些后期可能会修改的通篇使用的量，如字体等等，一般放在文件头部；</p> <figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">$headline</span>-ff: Braggadocio, Arial, Verdana, Helvetica, sans-serif;</span></span><br></pre></td></tr></table></figure></li><li><p>文件引入<code>@import</code>：类似于全局变量通常会单独放在一个文件中（_variables.scss）需要时通过<code>import</code>引入。</p> <figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">import</span> <span class="string">"variables"</span>;</span><br><span class="line"><span class="comment">// 多个import可用,分割</span></span><br><span class="line">@<span class="keyword">import</span> <span class="string">"variables"</span>, <span class="string">"compass/reset"</span>;</span><br></pre></td></tr></table></figure><p> ==注意==：这里的<code>@import</code>并不是css原生的<code>@import</code>（缺点：CSS原生的<code>@import</code>必须要放在代码的最前边才能生效；当a.css引入了b.css，只有当浏览器将a下载下来，解析渲染时读到import时才回去下载b，此时浏览器处于阻塞过程，大大影响渲染时间，所以不建议使用）。sass在被编译时会将import的文件输出到相应的css文件，并且import指令可以放在任何地方。</p> <figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">以下情况使用的是css原生<span class="keyword">import</span></span><br><span class="line"><span class="number">1</span>. 文件名为.css结尾</span><br><span class="line">@<span class="keyword">import</span> <span class="string">"variables.css"</span>;</span><br><span class="line"><span class="number">2</span>. <span class="string">"http://"</span>开头的字符串</span><br><span class="line">@<span class="keyword">import</span> <span class="string">"http://variables.css"</span>;</span><br><span class="line"><span class="number">3</span>. url()函数</span><br><span class="line">@<span class="keyword">import</span> url(<span class="string">"variables.css"</span>);</span><br><span class="line"><span class="number">4</span>. 跟有media queries</span><br><span class="line">@<span class="keyword">import</span> <span class="string">"variables"</span> projection tv;</span><br></pre></td></tr></table></figure></li><li><p>嵌套语法和父类选择器</p> <figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类的嵌套</span></span><br><span class="line"><span class="selector-class">.head</span> &#123;</span><br><span class="line">    <span class="selector-class">.content</span> &#123; <span class="attribute">color</span>: red; &#125;</span><br><span class="line">    &amp;:hover &#123; <span class="attribute">background</span>: green; &#125; <span class="comment">// 父类选择器&amp;</span></span><br><span class="line">    <span class="attribute">font</span>: &#123; // 属性嵌套</span><br><span class="line">        family: Arial;</span><br><span class="line">        size: <span class="number">16px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>变量操作</p><ul><li>操作方式<ul><li>直接操作变量，即变量表达式；</li><li>通过函数操作，函数包含以下几种：<ul><li>functions：跟代码块无关的函数，多为内置函数</li><li>可重用的代码块（类似于C中的宏macro）<ul><li>使用时以复制拷贝的方式存在，称为mixin，通过@include调用</li><li>使用时以组合声明的形式存在，通过@extend调用</li></ul></li></ul></li></ul></li><li>支持的运算操作符包含：<code>&lt;,&gt;,&lt;=,&gt;=,!=, ==, ()</code>。sass中的数值计算可以带单位，所以单位并不能混用。</li><li>sass支持css3中添加的hsl功能，自动转换为16进制色值，解决了不兼容问题。</li><li><p>mixin代码块的声明：一般放在页面顶部<code>@import</code>之后，或者单独抽离出一个文件，引入方法如下：  </p>  <figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">mixin</span> col-6 &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">float</span>: left;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.webdemo</span> &#123;</span><br><span class="line">    @<span class="keyword">include</span> col-6();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 一种可以实现但是不建议的方法，</span></span><br><span class="line"><span class="comment">// 规范建议类名最好有语义化的作用，而非视觉化</span></span><br><span class="line">@<span class="keyword">mixin</span> col-6 &#123;</span><br><span class="line">    <span class="selector-class">.col-6</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">50%</span>;</span><br><span class="line">        <span class="attribute">float</span>: left;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">@<span class="keyword">include</span> col-6();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 带参数的mixin, 50%为默认参数</span></span><br><span class="line">@<span class="keyword">mixin</span> col (<span class="variable">$width</span>: 50%) &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="variable">$width</span>;</span><br><span class="line">    <span class="attribute">float</span>: left;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>组合声明：以一种继承的形式来避免CSS的冗余。==工作原理是把继承者的选择器，插入到被继承者选择器所在的位置==。</p>  <figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.error.<span class="class">instruction </span>&#123;</span><br><span class="line"><span class="symbol">    color:</span> <span class="meta">#0f0;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">.<span class="class">error </span>&#123;</span><br><span class="line"><span class="symbol">    color:</span> <span class="meta">#f00;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">.serious-<span class="class">error </span>&#123;</span><br><span class="line">    @extend .error;</span><br><span class="line"><span class="symbol">    border:</span> <span class="number">1</span>px <span class="meta">#f00;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="params">&lt;div class="serious-error instruction"&gt;</span>serious<span class="params">&lt;/div&gt;</span> <span class="comment">// #0f0</span></span><br></pre></td></tr></table></figure><p>  <strong>注意</strong>：extend不能继承选择器序列（即<code>@extend .A .B</code>不可行，会报错）；使用%可构建仅用于继承的选择器（<code>%name {...}</code>），不会出现在生成文件中。   </p></li></ul></li><li><p>sass中的媒体查询：sass中的media query可以内嵌在css规则中，在生成css的时候，media query才会被提到样式的最高层级。避免重复书写选择器，同时避免打乱样式表的流程。  </p></li><li><p>sass提供了非常好的嵌套能力，但是嵌套带来的副作用也是不可忽视的：</p><ul><li>浏览器解析css文件是按照从右往左的顺序。即对于<code>.main .headline</code>会先找到类名为headline的元素，然后再向上查找父级元素是否类名为main，否则继续向上直到查找到类名对应的元素或者html元素。这样导致渲染效率的低下；  </li><li>增加了样式修饰的权重；</li><li><p>制造了样式位置的依赖；  </p><p>最佳实践是在命名的时候对类名进行语义化的命名，比如<code>.main-headline</code>，同时为了保留嵌套清晰易维护的优点，可以通过<code>at-root</code>指令指明将嵌套的内容输出到样式表顶层。   </p></li></ul></li><li><p>mixin的参数校验示例</p> <figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">mixin</span> col-sm (<span class="variable">$width</span>: 50%) &#123;</span><br><span class="line">    <span class="comment">/*输入校验*/</span></span><br><span class="line">    @<span class="keyword">if</span> type-of(<span class="variable">$width</span>) != number &#123;</span><br><span class="line">        @error <span class="string">"$width必须是一个数值类型，目前输入的width是#&#123;$width&#125;."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @<span class="keyword">if</span> not unitless(<span class="variable">$width</span>) &#123; <span class="comment">/* 没有单位 */</span></span><br><span class="line">        @<span class="keyword">if</span> unit(<span class="variable">$width</span>) != <span class="string">"%"</span> &#123;</span><br><span class="line">            @<span class="keyword">warn</span> <span class="string">"$width必须是一个百分值，目前输入的width是#&#123;$width&#125;."</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; @<span class="keyword">else</span> &#123;</span><br><span class="line">        @<span class="keyword">warn</span> <span class="string">"$width必须是一个百分值，目前输入的width是#&#123;$width&#125;."</span>;</span><br><span class="line">        <span class="variable">$width</span>: (percentage(<span class="variable">$width</span>) / <span class="number">100</span>); <span class="comment">/*数值变成百分号表示形式时会增加100倍*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">media</span> (min-width: 768px) &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="variable">$width</span>;</span><br><span class="line">        <span class="attribute">float</span>: left;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>sass的四种输出格式<code>config.rb</code>中的<code>output_style</code>：</p><ul><li>expanded：默认，样式展开，与手动书写css习惯一致；</li><li>nested：反映css样式修饰的html的结构，根据嵌套对应缩进样式；</li><li>compact：将所有属性汇总到一行，关注选择器之间的关系，而非选择器内的属性；</li><li>compressed：样式表压缩以占用最少的空间。</li></ul></li><li><p>其他：<code>@each</code> <code>@for</code> <code>@while</code></p></li><li><p>常用网址</p><ul><li>Sass中的functions详情页：<a href="http://sass-lang.com/documentation/Sass/Script/Functions.html" target="_blank" rel="noopener">http://sass-lang.com/documentation/Sass/Script/Functions.html</a></li><li>Sass和Compass必备技能之Sass篇（视频教程）：<a href="https://www.imooc.com/video/7155" target="_blank" rel="noopener">https://www.imooc.com/video/7155</a></li></ul></li></ol><h2 id="Compass"><a href="#Compass" class="headerlink" title="Compass"></a>Compass</h2><h4 id="compass安装及使用"><a href="#compass安装及使用" class="headerlink" title="compass安装及使用"></a>compass安装及使用</h4><ol><li>通过<code>gem install compass</code>即可安装成功</li><li><p>Compass目录创建  </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compass <span class="keyword">create</span> <span class="keyword">file</span>-<span class="keyword">name</span> // 初始化工作目录，<span class="keyword">file</span>-<span class="keyword">name</span>为生成的文件名</span><br></pre></td></tr></table></figure></li><li><p>目录结构  </p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sass：</span><br><span class="line">    -<span class="ruby"> <span class="number">_</span>*.scss：用于被其他sass文件引入，不会被单独编译</span></span><br><span class="line"><span class="ruby">    - *.scss：会被单独编译</span></span><br><span class="line"><span class="ruby">    注意：同一目录下，局部文件和非局部文件不能重名</span></span><br><span class="line"><span class="ruby">stylesheets：sass文件编译生成的css文件</span></span><br><span class="line"><span class="ruby">config.rb：配置项目文件</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compass <span class="keyword">compile</span> [path<span class="regexp">/to/</span><span class="keyword">project</span>] <span class="comment">// 按需编译</span></span><br><span class="line">compass watch [path<span class="regexp">/to/</span><span class="keyword">project</span>] <span class="comment">// 监听目录编译</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="compass核心模块"><a href="#compass核心模块" class="headerlink" title="compass核心模块"></a>compass核心模块</h4><p>CSS3、Helpers、Typography、Utilities模块通过<code>@import &quot;compass&quot;</code>就可以直接引入；而Reset和Layout模块需要分别通过<code>@import &quot;compass/reset&quot;</code>和<code>@import &quot;compass/layout</code>明确指定引入。  </p><ul><li>CSS3：跨浏览器的CSS3兼容能力  </li><li>Helpers：内含多函数，比较少用到  </li><li>Typography：修饰文本样式  </li><li>Utilities：辅助工具模块，多为mixins  </li><li>Reset：浏览器样式重置模块  </li><li>Layout：提供对页面布局的控制 </li></ul><p>除了以上六大功能模块之外，还包含browser模块，用于配置compass默认支持的浏览器机器版本，该模块的配置会影响其他模块的输出。    </p><ol><li><p><strong>reset模块</strong><br> 所有包含的模块可见：<a href="http://compass-style.org/reference/compass/reset/utilities/" target="_blank" rel="noopener">http://compass-style.org/reference/compass/reset/utilities/</a><br> 可以通过调用mixins来调用不同的模块。   </p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如`nested-reset`用于重置页面下某个选择器的所有标签，方式如下：</span></span><br><span class="line"><span class="selector-class">.test</span> &#123;</span><br><span class="line">    <span class="variable">@include</span> nested-reset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以通过传参的方法，将某个选择器下的样式重置，方式如下：</span></span><br><span class="line"><span class="comment">// 第一个参数为选择器，第二个参数为是否强制覆盖（!important）</span></span><br><span class="line"><span class="variable">@include</span> reset-display(<span class="string">'.test'</span>, true);</span><br></pre></td></tr></table></figure><p> ==使用normalize替代==</p> <figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gem install compass-normalize <span class="comment"># 下载normalize</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">'compass-normalize'</span> <span class="comment"># 在config.rb引入</span></span><br><span class="line"></span><br><span class="line">@import <span class="string">"normalize"</span>; <span class="comment"># 在scss文件中替换reset</span></span><br></pre></td></tr></table></figure><p> normalize核心模块本身包含八个部分：</p><ul><li>base: body和html标签的字体文字大小边距等</li><li>html5: 统一html5中新增的元素样式，如article、section的展现形式</li><li>links: 统一a标签的展示形式，去掉hover和active时的下划线</li><li>typography: 统一b, strong, h1, sub, sup等段落文本的样式修饰</li><li>embeds: img, svg等</li><li>groups: figure, pre, code等</li><li>forms: form相关的button, input, textarea等</li><li>tables: table相关table, td, th等<br>这八个部分可以通过子路径单独引入，如<code>@import &quot;normalize/base&quot;;</code>，通过子类引入的方法需要在前置位置添加<code>@import &quot;normalize-version&quot;;</code>。</li></ul></li></ol><ol start="2"><li><strong>layout模块</strong>（使用率低）<br><a href="http://compass-style.org/reference/compass/layout/" target="_blank" rel="noopener">http://compass-style.org/reference/compass/layout/</a><br>内部分了三大模块grid-background，sticky-footer，stretching。都可以通过子目录的方式如<code>@import &quot;compass/layout/grid-background&quot;</code>的方式显示引入。   <ul><li>stretch：拉伸填充。通过<code>@include stretch(top, right, bottom, left)</code>调用，将元素拉伸填充屏幕，参数可缺省。  </li><li>sticky-footer: 使页脚始终处于最底部。需符合一定的html结构（详见官网）。</li><li>grid-background: 使用css3中的grid定宽定高自适应宽高   </li></ul></li></ol><ol start="3"><li><strong>CSS3模块&amp;Browser Support 模块</strong>     <ul><li><a href="http://compass-style.org/reference/compass/css3/" target="_blank" rel="noopener">CSS3模块</a>：封装了CSS3新属性，通过调用对应的新属性即可，如<code>@include box-shadow(1px 1px 2px 2px #aaa);</code>，可以自动添加浏览器前缀（除此之外，提供部分CSS3属性在IE下的兼容处理，如inline-block, opacity等）。</li><li>Browser Support模块：通过<code>@import &quot;compass/support&quot;</code>可直接引入，实际上CSS3已引入了该模块。<ul><li><code>browser()</code>：通过<code>@debug browser()</code>可显示出当前支持的浏览器；</li><li><code>browser-version(&#39;chrome&#39;)</code>：显示当前对应浏览器考虑的所有版本；</li><li><code>$supported-browsers: chrome firefox</code>：限制当前支持的浏览器；</li><li><code>$browser-minmum-versions: (&quot;ie&quot;: &quot;8&quot;)</code>：通过键值对的方法限制最低支持的版本；</li><li><code>$graceful-usage-threshold=0.1</code>：如果对于某个属性（若不支持仅仅影响美观度）在支持的浏览器中该属性的使用率达到了0.1%，则对其进行兼容。假如显式声明了兼容的浏览器版本，则不会根据该设置判断属性是否需要兼容。   </li><li><code>$critical-usage-threshold=0.01</code>：如果对于某个属性（若不支持会导致页面混乱无法阅读等等较大问题）在支持的浏览器中该属性的使用率达到了0.01%，则对其进行兼容。假如显式声明了兼容的浏览器版本，则不会根据该设置判断属性是否需要兼容。      </li></ul></li></ul></li></ol><ol start="4"><li><p><strong>Typography模块</strong>   </p><ul><li>Links<ul><li><code>@include hover-link();</code>：正常态下去掉下划线，在hover或者focus时才显示</li><li><code>@include  link-colors(normal, hover, active, visited, focus)</code>：设置不同状态下的颜色值，只有第一个参数是必须参数</li><li><code>@include unstyle-link()</code>：抹平超链接样式</li></ul></li><li><p>Lists</p><ul><li><code>@include no-bullets()</code>： 去掉列表前的list-style，包含ul和li下</li><li><code>@include no-bullet()</code>： 去掉单个li元素前的list-style</li><li><code>@include inline-list()</code>：使得list横向布局，通过设置为<code>inline</code>实现</li><li><code>@include horizontal-list(padding, float)</code>：使得list横向布局，通过float实现，第一个参数为padding值，第二个参数为float的方向。</li><li><code>@include inline-block-list(padding)</code>：目的同上，通过设置li的display值为inline-block实现。</li></ul></li><li><p>Text</p><ul><li><code>@include force-wrap()</code>：连续长文本强制换行（如url等）</li><li><code>@include nowrap()</code>：连续长文本强制不换行，其实等同于<code>white-space: nowrap;</code></li><li><code>@include ellipsis()</code>：文本超出容器宽度，在其后添加省略号，为了兼容firefox低版本，可通过安装<code>compass install ellipsis</code>，通过<code>$use-mozilla-ellipsis-binding: true;</code>开启对firefox低版本的支持。   </li><li><code>@include hide-text()</code>：隐藏文本，text-indent实现</li><li><code>@include squish-text()</code>：隐藏文本，通过font-size/opacity实现</li><li><code>@include replace-text(url, bg-pos-x, bg-pos-y)</code>：设置背景图片</li><li><code>@include replace-text-with-dimensions(本地图片地址)</code>：设置本地图片为背景，自动检测宽高使得容器大小与背景图片一致</li></ul></li><li><p>Vertical Rhythm<br>  行内容间的留白，让所有文本元素的高度是基准高的整数倍   </p></li></ul></li></ol><ol start="5"><li><strong>Helpers模块</strong><br>  Helpers中为函数，而不是mixins，不需要include，可以直接调用，其中的许多函数都于config.rb中的配置项对应。<ul><li>Data URI：可以在Web 页面中包含图片但无需任何额外的HTTP 请求的一类URI（通过base64编码实现）。然而比直接使用图片资源相比要多使用50%的CPU资源，多4倍的内存，且不支持IE6/7。<code>background-image: inline-image(&#39;image.png&#39;)</code> 图片参数是相对于在cofig文件中设定的image目录设置的目录的相对路径。</li><li><code>image-url(&#39;image.png&#39;)</code>：对于某些分布在CDN上的图片，后面常常跟着一个时间戳（cache buster）来标示这个图片更新的版本或者时间，对于CSS背景图片设置不友好，而且经常更改。image-url可以很好地解决这个问题，同时引用路径也只需要关注图片相对于配置的图片目录image_dir的相对路径。<code>stylesheet-url</code>和<code>font-url</code>用于管理指向CSS目录和font目录的资源文件路径，用法类似。   </li><li><code>compass-env()</code>：compass编译环境，只有两个返回值development和production。</li><li><code>image-width()</code>和<code>image-height()</code>：用于计算图片的宽和高   </li><li><code>append-selector($selector, $to-append)</code>：将第二个参数叠加组合到第一个参数中生成学则器。    </li></ul></li></ol><ol start="6"><li><p><strong>Utilities模块</strong><br>Utilities模块主要是一些无法分类到其他模块中的功能，其中又分为5个类别：<code>Color</code>、<code>Print</code>、<code>Tables</code>、<code>General</code>、<code>Sprites</code>。</p><ul><li>Color<ul><li><code>brightness($color)</code>：计算颜色的亮度</li><li>contrasted($background-color, [$dark], [$light], [$threshold])：根据输入的bgColor自动生成background-color属性，并在输入的dark和light两个色值之间选取一个和背景颜色对比度更大的设为color属性。   </li></ul></li><li>Print<br>  必须在两个文件中协同使用，<code>pirnt.scss</code>和<code>screen.scss</code>都需要引入print模块，主要是应用于适配打印设备。<ul><li><code>print-utilities</code>：在<code>screen.scss</code>中调用需要传参<code>@include print-utilities(screen)</code>不传默认为<code>print.scss</code>中。</li></ul></li><li>Tables<ul><li><code>outer|inner-tables-borders($width, $color)</code>：分别用于设置table内外边框</li><li><code>table-scaffolding()</code>：单元格文本对齐和padding初始化，<code>th</code>居中，<code>.numberic</code>右对齐。</li><li><code>alternating-rows-and-columns($evenColor, $oddColor, $相邻两列颜色差值，$thColor, $tfootColor)</code>：对奇偶行|相隔列进行不同的颜色修饰。</li></ul></li><li>General<br>  -<code>clearfix()</code>：通过在<code>.clearfix</code>中设置<code>overflow:hidden</code>清除浮动。<br>  -<code>legacy-pie-clearfix()</code>：通过伪类清除浮动。<br>  -<code>float($direction)</code>：根据配置设置是否启用对IE6的hack解决double float-margin bug。<br>  -<code>min-height|width($length)</code>：设置min-height/min-width，兼容IE。<br>  -<code>tag-cloud($baseFontSize)</code>：生成大小不同的字体，类名为xs,xxs, s, l, xl, xxl。</li><li><p>Sprites<br>  主要是通过<code>sprite helpers</code>实现。</p>  <figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="meta"><span class="meta-keyword">import</span> "compass/utilities/sprites;</span></span><br><span class="line">@<span class="meta"><span class="meta-keyword">import</span> "logo/*.png";</span>  <span class="comment">/* compass据此生成sass样式文件，默认不会存储在硬盘，可通过在控制台输入compass sprites "images/logo/*.png"生成文件查看，生成sprites */</span></span><br><span class="line">@<span class="meta"><span class="meta-keyword">include</span> all-logo-sprites();</span>   <span class="comment">/* 图片使用，中间的logo为目录名，只取路径的最后一个文件夹名 */</span></span><br></pre></td></tr></table></figure><p>  图片引用的方法有两种，一个是直接在对应元素中添加对应类名<code>logo-imageName</code>；另一个则是通过<code>@include logo-sprite(&quot;imageName&quot;)</code>的方法。   </p><ul><li>对于button类型的图标，希望在hover, active等状态下使用不同的图片，可以通过在对图片命名为<code>imageName_hover.png</code>等，compass就会自动生成对应样式。可通过设置<code>$disable-magic-sprite-selectors:true</code>关闭该特性。</li><li><code>$logo-layout: vertical|horizontal|diagonal|smart</code>：生成精灵图的布局方式设置。</li></ul></li></ul></li></ol><h4 id="compass其他知识"><a href="#compass其他知识" class="headerlink" title="compass其他知识"></a>compass其他知识</h4><ol><li>config.rb中<code>require &#39;compass/import-once/activate&#39;</code>：启用import-once，对于多次import同一文件只会引入一次，避免冗余。如果确实是需要多次引入，则可以通过 @import “compass/reset!”来引入后面的重复引用文件。  </li><li>当使用<code>compressed</code>作为sass的输出格式时，默认会去掉所有注释文字。而对于一些必要的注释内容（如copy rights），可以通过如<code>/*! hahaha */</code>来避免被去除。</li><li><code>@debug</code>可以在控制台显示出mixins函数等对应的输出，如<code>@debug browser()</code>显示出的当前compass支持的浏览器，类似于console.log()的功能；</li><li>通过在控制台输入<code>compass interactive</code>可以进入console，直接调用mixins。   </li><li>compass生成地址的时候，默认生成的都是绝对地址，认为<code>config.rb</code>所在的位置为根路径。假如有专门的服务器地址来存储相关的文件等，可以在config.rb中设置（http_path等），也可以通过relative_assets设置为true来生成相对路径。  </li><li><code>compile compass -e production --force</code>：强制compass在production环境下编译，也可以在config.rb中配置<code>environment = :development</code>。   </li><li>在选择器，字符串或SASS变量中如果需要引用函数，需要使用形如#{fn()}。</li></ol>]]></content>
      
      
      <categories>
          
          <category> notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sass </tag>
            
            <tag> compass </tag>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vuepress搭建</title>
      <link href="/2018/08/10/vuepress%E6%90%AD%E5%BB%BA/"/>
      <url>/2018/08/10/vuepress%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><ol><li><code>vuepress</code>支持html、md、vue。这些格式最终都会被转换成vue组件：<code>markdown -&gt; html -&gt; vue</code>。</li></ol><h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><ol><li>初始化：<code>npm init</code></li><li><p>安装vuepress<br><em>全局安装<code>-g</code>，在已有的项目中安装<code>-d</code>。</em>  </p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局安装</span></span><br><span class="line">npm install -g vuepress</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 创建一个专门的docs目录存放md文件</span></span><br><span class="line"><span class="comment"># mkdir docs</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 创建一个 markdown 文件</span></span><br><span class="line"><span class="comment"># echo '# Hello Vuepress' &gt; docs/README.md</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'# Hello Vuepress'</span> &gt; README.md</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 编写文档</span></span><br><span class="line"><span class="comment"># npx vuepress dev docs</span></span><br><span class="line">npx vuepress dev</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 构建</span></span><br><span class="line"><span class="comment"># npx vuepress build docs</span></span><br><span class="line">npx vuepress build</span><br></pre></td></tr></table></figure><p> 为了防止以后忘记命令，建议在<code>package.json</code>中添加<code>scripts</code>脚本。</p> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"scripts"</span>: &#123;</span><br><span class="line">        <span class="string">"dev"</span>: <span class="string">"vuepress dev docs"</span>,</span><br><span class="line">        <span class="string">"build"</span>: <span class="string">"vuepress build docs"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在上面两步之后就可以在本地查看部署效果了。现在还只是一个简单的markdown界面显示。做到像vuepress官网一样的界面还需要在<code>.vuepress</code>文件下添加配置文件<code>config.js</code>。以下代码简单的添加了标题、头部导航和侧边导航，具体可参照<a href="https://vuepress.docschina.org/config/" target="_blank" rel="noopener">官方文档</a>。  </p> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    base: <span class="string">'/gh-pages/'</span>, <span class="comment">// github仓库名</span></span><br><span class="line">    title: <span class="string">'Hello VuePress'</span>, <span class="comment">// 标题</span></span><br><span class="line">    description: <span class="string">'Justing do it!'</span>,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 顶部导航栏nav</span></span><br><span class="line">    themeConfig: &#123;</span><br><span class="line">        nav: [</span><br><span class="line">            &#123;<span class="attr">text</span>: <span class="string">'指南'</span>, <span class="attr">link</span>: <span class="string">'/guide/'</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">text</span>: <span class="string">'配置参考'</span>, <span class="attr">link</span>: <span class="string">'/config/'</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">text</span>: <span class="string">'默认主题配置'</span>, <span class="attr">link</span>: <span class="string">'/default-theme-config/'</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">text</span>: <span class="string">'Github'</span>, <span class="attr">link</span>: <span class="string">'https://github.com/docschina/vuepress/'</span>&#125;,</span><br><span class="line">        ],</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 左侧sidebar</span></span><br><span class="line">        sidebar: [</span><br><span class="line">            <span class="string">'/'</span>,</span><br><span class="line">            <span class="string">'pageA.html'</span>,</span><br><span class="line">            <span class="string">'pageB.html'</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>为了让这个系统能够在外部访问，可以借助github。</p><ul><li>建立好一个github仓库，如：<a href="https://github.com/winniecjy/technical-docs，在`config.js`文件中添加`base" target="_blank" rel="noopener">https://github.com/winniecjy/technical-docs，在`config.js`文件中添加`base</a>: [仓库名]`  </li><li><p>同步远程仓库到本地输出目录下<code>.vuepress/dist</code>  </p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> .vuepress/dist</span><br><span class="line">git init</span><br><span class="line">git pull -f</span><br></pre></td></tr></table></figure></li><li><p>将<code>dist</code>目录下的文件上传到github的gh-pages分支下<code>.vuepress/</code>  </p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add -A</span><br><span class="line">git commit -m <span class="string">'deploy'</span></span><br><span class="line">git push -f git@github.com:winniecjy/technical-docs.git master:gh-pages</span><br></pre></td></tr></table></figure></li><li><p>在远程仓库<code>Settings -&gt; Github Pages -&gt; Source</code>设置为<code>gh-pages branch</code>，点击save。</p></li><li>这样就大功告成啦，效果：<a href="https://winniecjy.github.io/technical-docs/" target="_blank" rel="noopener">DEMO</a>。<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2></li></ul></li><li>不使用<code>README.md</code>作为名字时，按照官方文档部署网站之后总是跳转到默认的404页面？<br>README.md 默认生成index.html为默认首页，不可更改。 </li><li>注意文件重新生成之后需要重新部署个git仓库，并上传才能更新文档，因为dist文件夹都是删除重新生成的。<code>vuepress</code>比较适合不需要经常修改的静态文档。</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> 小项目 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
