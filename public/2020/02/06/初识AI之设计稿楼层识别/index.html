<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="前端"><title>初识AI之设计稿楼层识别 | Winnie Cai's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">初识AI之设计稿楼层识别</h1><a id="logo" href="/.">Winnie Cai's Blog</a><p class="description">生气了，一顿饭哄不好的那种。恩，要两顿。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">初识AI之设计稿楼层识别</h1><div class="post-meta">Feb 6, 2020<span> | </span><span class="category"><a href="/categories/深入学习/">深入学习</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#业务背景"><span class="toc-number">1.</span> <span class="toc-text">业务背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#制作数据集"><span class="toc-number">2.</span> <span class="toc-text">制作数据集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据集处理"><span class="toc-number">3.</span> <span class="toc-text">数据集处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xml合并为csv"><span class="toc-number">3.1.</span> <span class="toc-text">xml合并为csv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#csv转换为TFRcords-Format"><span class="toc-number">3.2.</span> <span class="toc-text">csv转换为TFRcords Format</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型选取"><span class="toc-number">4.</span> <span class="toc-text">模型选取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型训练"><span class="toc-number">5.</span> <span class="toc-text">模型训练</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型效果展示"><span class="toc-number">6.</span> <span class="toc-text">模型效果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#python模型导出"><span class="toc-number">6.1.</span> <span class="toc-text">python模型导出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将导出模型转换为TensorFlow-js可运行模型"><span class="toc-number">6.2.</span> <span class="toc-text">将导出模型转换为TensorFlow.js可运行模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端运行模型"><span class="toc-number">6.3.</span> <span class="toc-text">前端运行模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发散思考与深入"><span class="toc-number">7.</span> <span class="toc-text">发散思考与深入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题记录"><span class="toc-number">8.</span> <span class="toc-text">问题记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">9.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>本文不包含底层数学基础，目标是利用已有算法和模型实现需求。</p>
</blockquote>
<h2 id="业务背景"><a href="#业务背景" class="headerlink" title="业务背景"></a>业务背景</h2><p>从长设计稿上识别多个楼层进行分割，得出分割区域坐标。<br>本文使用的深度学习工具为<code>TensorFlow</code>。主要通过改造官方例子，来训练自己的模型并测试效果，其中模型训练部分通过<strong>python</strong>实现，效果测试由前端页面展示。<br>项目地址：<a href="https://github.com/winniecjy/floorDetection" target="_blank" rel="noopener">https://github.com/winniecjy/floorDetection</a><br>demo地址：<a href="https://winniecjy.github.io/floorDetection/" target="_blank" rel="noopener">https://winniecjy.github.io/floorDetection/</a><br>最终效果如下：<br><img src="https://img11.360buyimg.com/imagetools/jfs/t1/109913/23/5556/116384/5e3b9264E1d3573b2/daa93409cdfe3a38.jpg" alt="效果图">   </p>
<h2 id="制作数据集"><a href="#制作数据集" class="headerlink" title="制作数据集"></a>制作数据集</h2><p>这里使用labelImg来标注检测目标，MacOS下的安装步骤如下，其他系统可参考<a href="https://github.com/tzutalin/labelImg：" target="_blank" rel="noopener">https://github.com/tzutalin/labelImg：</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pyqt5 lxml # Install qt and lxml by pip</span><br><span class="line"></span><br><span class="line">git clone https://github.com/tzutalin/labelImg.git</span><br><span class="line">cd labelImg</span><br><span class="line">make qt5py3</span><br><span class="line">python labelImg.py</span><br><span class="line">python labelImg.py [IMAGE_PATH] [PRE-DEFINED CLASS FILE]</span><br></pre></td></tr></table></figure></p>
<p><img src="https://img10.360buyimg.com/imagetools/jfs/t1/91139/3/11302/676536/5e31741eE18cc7f5f/9f034107bfe78735.jpg" alt="labelimg"><br>这里在花瓣网上找了100多张会场设计图来进行处理。将图片一分为二，一部分作为训练集，一部分作为测试集，训练集和测试集比例为2:1，分别放在两个文件夹train和test中。标记完成后，每个图片都得到一个对应的xml文件描述了对应的区域标注。            </p>
<h2 id="数据集处理"><a href="#数据集处理" class="headerlink" title="数据集处理"></a>数据集处理</h2><h3 id="xml合并为csv"><a href="#xml合并为csv" class="headerlink" title="xml合并为csv"></a>xml合并为csv</h3><p>把所有的xml合并到csv文件，把以下代码复制到一个python文件中，需要修改两处位置：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">需要修改两个位置</span></span><br><span class="line"><span class="string">fileDir: 为xml文件所在的目录</span></span><br><span class="line"><span class="string">outputName：为csv文件的输出名称</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line">fileDir = <span class="string">'output/train'</span> <span class="comment"># xml文件夹地址</span></span><br><span class="line">outputName = <span class="string">'train.csv'</span> <span class="comment"># 生成csv文件地址</span></span><br><span class="line">os.chdir(fileDir)</span><br><span class="line">path = fileDir</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xml_to_csv</span><span class="params">(path)</span>:</span></span><br><span class="line">    xml_list = []</span><br><span class="line">    <span class="keyword">for</span> xml_file <span class="keyword">in</span> glob.glob(<span class="string">'*.xml'</span>):</span><br><span class="line">        tree = ET.parse(xml_file)</span><br><span class="line">        root = tree.getroot()</span><br><span class="line">        <span class="keyword">for</span> member <span class="keyword">in</span> root.findall(<span class="string">'object'</span>):</span><br><span class="line">            value = (root.find(<span class="string">'filename'</span>).text,</span><br><span class="line">                     int(root.find(<span class="string">'size'</span>)[<span class="number">0</span>].text),</span><br><span class="line">                     int(root.find(<span class="string">'size'</span>)[<span class="number">1</span>].text),</span><br><span class="line">                     member[<span class="number">0</span>].text,</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">0</span>].text),</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">1</span>].text),</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">2</span>].text),</span><br><span class="line">                     int(member[<span class="number">4</span>][<span class="number">3</span>].text)</span><br><span class="line">                     )</span><br><span class="line">            print(<span class="string">'value: '</span>, value)</span><br><span class="line">            xml_list.append(value)</span><br><span class="line">    column_name = [<span class="string">'filename'</span>, <span class="string">'width'</span>, <span class="string">'height'</span>, <span class="string">'class'</span>, <span class="string">'xmin'</span>, <span class="string">'ymin'</span>, <span class="string">'xmax'</span>, <span class="string">'ymax'</span>]</span><br><span class="line">    xml_df = pd.DataFrame(xml_list, columns=column_name)</span><br><span class="line">    <span class="keyword">return</span> xml_df</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    image_path = path</span><br><span class="line">    xml_df = xml_to_csv(image_path)</span><br><span class="line">    xml_df.to_csv(outputName, index=<span class="keyword">None</span>)</span><br><span class="line">    print(<span class="string">'Successfully converted xml to csv.'</span>)</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p>
<p><img src="https://img12.360buyimg.com/imagetools/jfs/t1/85204/40/11269/350026/5e31741aE11cb3d2a/c20da86272de1a2c.jpg" alt="csv">    </p>
<h3 id="csv转换为TFRcords-Format"><a href="#csv转换为TFRcords-Format" class="headerlink" title="csv转换为TFRcords Format"></a>csv转换为TFRcords Format</h3><p>由于使用到的<code>TensorFlow Object Detection API</code>数据输入格式为<code>TFRcords Format</code>，所以还需要进行一次csv格式转换。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">  使用:</span></span><br><span class="line"><span class="string">  # csv_input为输入的csv文件目录，output_path为输出的文件目录</span></span><br><span class="line"><span class="string">  python csv2record.py --csv_input=data/train.csv --output_path=data/train.record</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  需要修改两个位置（标记为修改处）：</span></span><br><span class="line"><span class="string">  #1. 'images/train'为图片所在目录</span></span><br><span class="line"><span class="string">  path = os.path.join(os.getcwd(), 'images/train')</span></span><br><span class="line"><span class="string">  #2. 对应的标签返回一个整数，后面需要使用</span></span><br><span class="line"><span class="string">  def class_text_to_int(row_label):</span></span><br><span class="line"><span class="string">    if row_label == 'floors':</span></span><br><span class="line"><span class="string">        return 1</span></span><br><span class="line"><span class="string">    elif row_label == 'toutu':</span></span><br><span class="line"><span class="string">        return 2</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        None</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> dataset_util</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple, OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到脚本所在目录</span></span><br><span class="line"><span class="comment"># py_dir = '/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(os.getcwd())</span></span><br><span class="line"><span class="comment"># os.chdir(py_dir)</span></span><br><span class="line"><span class="comment"># print(os.getcwd())</span></span><br><span class="line"></span><br><span class="line">flags = tf.app.flags</span><br><span class="line">flags.DEFINE_string(<span class="string">'csv_input'</span>, <span class="string">''</span>, <span class="string">'Path to the CSV input'</span>)</span><br><span class="line">flags.DEFINE_string(<span class="string">'output_path'</span>, <span class="string">''</span>, <span class="string">'Path to output TFRecord'</span>)</span><br><span class="line">FLAGS = flags.FLAGS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改处：标签数字对应</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">class_text_to_int</span><span class="params">(row_label)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> row_label == <span class="string">'floors'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> row_label == <span class="string">'toutu'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">csv按照图片名分组；</span></span><br><span class="line"><span class="string">将同一图片名中多个标记区域分为一组；</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split</span><span class="params">(df, group)</span>:</span></span><br><span class="line">    data = namedtuple(<span class="string">'data'</span>, [<span class="string">'filename'</span>, <span class="string">'object'</span>]) <span class="comment"># data有两个属性，filename和object</span></span><br><span class="line">    gb = df.groupby(group) <span class="comment"># 按照'filename'对data中的数据进行分组</span></span><br><span class="line">    <span class="comment"># data(filename, gb.get_group(x))存放每个图片名、该图片的相关信息</span></span><br><span class="line">    <span class="keyword">return</span> [data(filename, gb.get_group(x)) <span class="keyword">for</span> filename, x <span class="keyword">in</span> zip(gb.groups.keys(), gb.groups)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_tf_example</span><span class="params">(group, path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> tf.gfile.GFile(os.path.join(path, <span class="string">'&#123;&#125;'</span>.format(group.filename)), <span class="string">'rb'</span>) <span class="keyword">as</span> fid: <span class="comment"># rb指定二进制形式读取图片</span></span><br><span class="line">        encoded_jpg = fid.read()</span><br><span class="line">    encoded_jpg_io = io.BytesIO(encoded_jpg)</span><br><span class="line">    image = Image.open(encoded_jpg_io)</span><br><span class="line">    width, height = image.size</span><br><span class="line"></span><br><span class="line">    filename = group.filename.encode(<span class="string">'utf8'</span>)</span><br><span class="line">    image_format = <span class="string">b'jpg'</span></span><br><span class="line">    xmins = []</span><br><span class="line">    xmaxs = []</span><br><span class="line">    ymins = []</span><br><span class="line">    ymaxs = []</span><br><span class="line">    classes_text = []</span><br><span class="line">    classes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index, row <span class="keyword">in</span> group.object.iterrows():</span><br><span class="line">        xmins.append(row[<span class="string">'xmin'</span>] / width)</span><br><span class="line">        xmaxs.append(row[<span class="string">'xmax'</span>] / width)</span><br><span class="line">        ymins.append(row[<span class="string">'ymin'</span>] / height)</span><br><span class="line">        ymaxs.append(row[<span class="string">'ymax'</span>] / height)</span><br><span class="line">        classes_text.append(row[<span class="string">'class'</span>].encode(<span class="string">'utf8'</span>))</span><br><span class="line">        classes.append(class_text_to_int(row[<span class="string">'class'</span>]))</span><br><span class="line"></span><br><span class="line">    tf_example = tf.train.Example(features=tf.train.Features(feature=&#123;</span><br><span class="line">        <span class="string">'image/height'</span>: dataset_util.int64_feature(height),</span><br><span class="line">        <span class="string">'image/width'</span>: dataset_util.int64_feature(width),</span><br><span class="line">        <span class="string">'image/filename'</span>: dataset_util.bytes_feature(filename),</span><br><span class="line">        <span class="string">'image/source_id'</span>: dataset_util.bytes_feature(filename),</span><br><span class="line">        <span class="string">'image/encoded'</span>: dataset_util.bytes_feature(encoded_jpg),</span><br><span class="line">        <span class="string">'image/format'</span>: dataset_util.bytes_feature(image_format),</span><br><span class="line">        <span class="string">'image/object/bbox/xmin'</span>: dataset_util.float_list_feature(xmins),</span><br><span class="line">        <span class="string">'image/object/bbox/xmax'</span>: dataset_util.float_list_feature(xmaxs),</span><br><span class="line">        <span class="string">'image/object/bbox/ymin'</span>: dataset_util.float_list_feature(ymins),</span><br><span class="line">        <span class="string">'image/object/bbox/ymax'</span>: dataset_util.float_list_feature(ymaxs),</span><br><span class="line">        <span class="string">'image/object/class/text'</span>: dataset_util.bytes_list_feature(classes_text),</span><br><span class="line">        <span class="string">'image/object/class/label'</span>: dataset_util.int64_list_feature(classes),</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">return</span> tf_example</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></span><br><span class="line">    writer = tf.io.TFRecordWriter(FLAGS.output_path)</span><br><span class="line">    path = os.path.join(os.getcwd(), <span class="string">'images-test'</span>) <span class="comment"># 修改处</span></span><br><span class="line">    examples = pd.read_csv(FLAGS.csv_input)</span><br><span class="line">    grouped = split(examples, <span class="string">'filename'</span>)</span><br><span class="line">    <span class="keyword">for</span> group <span class="keyword">in</span> grouped:</span><br><span class="line">        tf_example = create_tf_example(group, path)</span><br><span class="line">        writer.write(tf_example.SerializeToString())</span><br><span class="line"></span><br><span class="line">    writer.close()</span><br><span class="line">    output_path = os.path.join(os.getcwd(), FLAGS.output_path)</span><br><span class="line">    print(<span class="string">'Successfully created the TFRecords: &#123;&#125;'</span>.format(output_path))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tf.compat.v1.app.run()</span><br></pre></td></tr></table></figure></p>
<h2 id="模型选取"><a href="#模型选取" class="headerlink" title="模型选取"></a>模型选取</h2><p>tensorflow/models仓库提供了丰富的TensorFlow模型，目标检测API位于目录tensorflow/models/research/object_detection/models，本文选取的是<code>ssd_mobilenet_v1_coco</code>模型，更多的模型描述可以参照<a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/detection_model_zoo.md" target="_blank" rel="noopener">model zoo</a>，需要对其中的<code>*.config</code>文件进行修改：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSD with Mobilenet v1 configuration for MSCOCO Dataset.</span></span><br><span class="line"><span class="comment"># Users should configure the fine_tune_checkpoint field in the train config as</span></span><br><span class="line"><span class="comment"># well as the label_map_path and input_path fields in the train_input_reader and</span></span><br><span class="line"><span class="comment"># eval_input_reader. Search for "PATH_TO_BE_CONFIGURED" to find the fields that</span></span><br><span class="line"><span class="comment"># should be configured.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">修改位置已标记为：修改处</span></span><br><span class="line"><span class="string">1. ssd &#123;</span></span><br><span class="line"><span class="string">  num_classes: 2</span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">num_classes为标签类别数，此次训练有头图和楼层两个类型，所以为2</span></span><br><span class="line"><span class="string">2. train_config: &#123;</span></span><br><span class="line"><span class="string">  batch_size: 1</span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">batch_size是每次迭代的数据数，这里设为1</span></span><br><span class="line"><span class="string">3. train_input_reader: &#123;</span></span><br><span class="line"><span class="string">  tf_record_input_reader &#123;</span></span><br><span class="line"><span class="string">    input_path: "output/train.record"</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  label_map_path: "output/floors.pbtxt"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">input_path是训练数据的路径，label_map_path是label路径都需要改为对应的路径</span></span><br><span class="line"><span class="string">4. eval_input_reader: &#123;</span></span><br><span class="line"><span class="string">  tf_record_input_reader &#123;</span></span><br><span class="line"><span class="string">    input_path: "output/test.record"</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  label_map_path: "output/floors.pbtxt"</span></span><br><span class="line"><span class="string">  shuffle: false</span></span><br><span class="line"><span class="string">  num_readers: 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">input_path是测试数据的路径，label_map_path是label路径都需要改为对应的路径</span></span><br><span class="line"><span class="string">5.fine_tune_checkpoint: "training/model.ckpt"</span></span><br><span class="line"><span class="string">  from_detection_checkpoint: true</span></span><br><span class="line"><span class="string">由于是从头开始训练，不使用预训练的模型数据，所以这两行注释，如果是对预训练模型参数来进行微调，则该参数为模型位置</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">model &#123;</span><br><span class="line">  ssd &#123;</span><br><span class="line">    num_classes: <span class="number">2</span> <span class="comment"># 修改处：标签类别数</span></span><br><span class="line">    box_coder &#123;</span><br><span class="line">      faster_rcnn_box_coder &#123;</span><br><span class="line">        y_scale: <span class="number">10.0</span></span><br><span class="line">        x_scale: <span class="number">10.0</span></span><br><span class="line">        height_scale: <span class="number">5.0</span></span><br><span class="line">        width_scale: <span class="number">5.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    matcher &#123;</span><br><span class="line">      argmax_matcher &#123;</span><br><span class="line">        matched_threshold: <span class="number">0.5</span></span><br><span class="line">        unmatched_threshold: <span class="number">0.5</span></span><br><span class="line">        ignore_thresholds: false</span><br><span class="line">        negatives_lower_than_unmatched: true</span><br><span class="line">        force_match_for_each_row: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    similarity_calculator &#123;</span><br><span class="line">      iou_similarity &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    anchor_generator &#123;</span><br><span class="line">      ssd_anchor_generator &#123;</span><br><span class="line">        num_layers: <span class="number">6</span></span><br><span class="line">        min_scale: <span class="number">0.2</span></span><br><span class="line">        max_scale: <span class="number">0.95</span></span><br><span class="line">        aspect_ratios: <span class="number">1.0</span></span><br><span class="line">        aspect_ratios: <span class="number">2.0</span></span><br><span class="line">        aspect_ratios: <span class="number">0.5</span></span><br><span class="line">        aspect_ratios: <span class="number">3.0</span></span><br><span class="line">        aspect_ratios: <span class="number">0.3333</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    image_resizer &#123;</span><br><span class="line">      fixed_shape_resizer &#123;</span><br><span class="line">        height: <span class="number">300</span></span><br><span class="line">        width: <span class="number">300</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    box_predictor &#123;</span><br><span class="line">      convolutional_box_predictor &#123;</span><br><span class="line">        min_depth: <span class="number">0</span></span><br><span class="line">        max_depth: <span class="number">0</span></span><br><span class="line">        num_layers_before_predictor: <span class="number">0</span></span><br><span class="line">        use_dropout: false</span><br><span class="line">        dropout_keep_probability: <span class="number">0.8</span></span><br><span class="line">        kernel_size: <span class="number">1</span></span><br><span class="line">        box_code_size: <span class="number">4</span></span><br><span class="line">        apply_sigmoid_to_scores: false</span><br><span class="line">        conv_hyperparams &#123;</span><br><span class="line">          activation: RELU_6,</span><br><span class="line">          regularizer &#123;</span><br><span class="line">            l2_regularizer &#123;</span><br><span class="line">              weight: <span class="number">0.00004</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          initializer &#123;</span><br><span class="line">            truncated_normal_initializer &#123;</span><br><span class="line">              stddev: <span class="number">0.03</span></span><br><span class="line">              mean: <span class="number">0.0</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          batch_norm &#123;</span><br><span class="line">            train: true,</span><br><span class="line">            scale: true,</span><br><span class="line">            center: true,</span><br><span class="line">            decay: <span class="number">0.9997</span>,</span><br><span class="line">            epsilon: <span class="number">0.001</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    feature_extractor &#123;</span><br><span class="line">      type: <span class="string">'ssd_mobilenet_v1'</span></span><br><span class="line">      min_depth: <span class="number">16</span></span><br><span class="line">      depth_multiplier: <span class="number">1.0</span></span><br><span class="line">      conv_hyperparams &#123;</span><br><span class="line">        activation: RELU_6,</span><br><span class="line">        regularizer &#123;</span><br><span class="line">          l2_regularizer &#123;</span><br><span class="line">            weight: <span class="number">0.00004</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        initializer &#123;</span><br><span class="line">          truncated_normal_initializer &#123;</span><br><span class="line">            stddev: <span class="number">0.03</span></span><br><span class="line">            mean: <span class="number">0.0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        batch_norm &#123;</span><br><span class="line">          train: true,</span><br><span class="line">          scale: true,</span><br><span class="line">          center: true,</span><br><span class="line">          decay: <span class="number">0.9997</span>,</span><br><span class="line">          epsilon: <span class="number">0.001</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    loss &#123;</span><br><span class="line">      classification_loss &#123;</span><br><span class="line">        weighted_sigmoid &#123;</span><br><span class="line">          anchorwise_output: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      localization_loss &#123;</span><br><span class="line">        weighted_smooth_l1 &#123;</span><br><span class="line">          anchorwise_output: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      hard_example_miner &#123;</span><br><span class="line">        num_hard_examples: <span class="number">3000</span></span><br><span class="line">        iou_threshold: <span class="number">0.99</span></span><br><span class="line">        loss_type: CLASSIFICATION</span><br><span class="line">        max_negatives_per_positive: <span class="number">3</span></span><br><span class="line">        min_negatives_per_image: <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">      classification_weight: <span class="number">1.0</span></span><br><span class="line">      localization_weight: <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line">    normalize_loss_by_num_matches: true</span><br><span class="line">    post_processing &#123;</span><br><span class="line">      batch_non_max_suppression &#123;</span><br><span class="line">        score_threshold: <span class="number">1e-8</span></span><br><span class="line">        iou_threshold: <span class="number">0.6</span></span><br><span class="line">        max_detections_per_class: <span class="number">100</span></span><br><span class="line">        max_total_detections: <span class="number">100</span></span><br><span class="line">      &#125;</span><br><span class="line">      score_converter: SIGMOID</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">train_config: &#123;</span><br><span class="line">  batch_size: <span class="number">1</span> <span class="comment"># 修改处：每次迭代数据量</span></span><br><span class="line">  optimizer &#123;</span><br><span class="line">    rms_prop_optimizer: &#123;</span><br><span class="line">      learning_rate: &#123;</span><br><span class="line">        exponential_decay_learning_rate &#123;</span><br><span class="line">          initial_learning_rate: <span class="number">0.004</span></span><br><span class="line">          decay_steps: <span class="number">800720</span></span><br><span class="line">          decay_factor: <span class="number">0.95</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      momentum_optimizer_value: <span class="number">0.9</span></span><br><span class="line">      decay: <span class="number">0.9</span></span><br><span class="line">      epsilon: <span class="number">1.0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># fine_tune_checkpoint: "training/model.ckpt" # 修改处</span></span><br><span class="line">  <span class="comment"># from_detection_checkpoint: true # 修改处</span></span><br><span class="line">  <span class="comment"># <span class="doctag">Note:</span> The below line limits the training process to 200K steps, which we</span></span><br><span class="line">  <span class="comment"># empirically found to be sufficient enough to train the pets dataset. This</span></span><br><span class="line">  <span class="comment"># effectively bypasses the learning rate schedule (the learning rate will</span></span><br><span class="line">  <span class="comment"># never decay). Remove the below line to train indefinitely.</span></span><br><span class="line">  num_steps: <span class="number">200000</span></span><br><span class="line">  data_augmentation_options &#123;</span><br><span class="line">    random_horizontal_flip &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  data_augmentation_options &#123;</span><br><span class="line">    ssd_random_crop &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">train_input_reader: &#123;</span><br><span class="line">  tf_record_input_reader &#123;</span><br><span class="line">    input_path: <span class="string">"output/train.record"</span> <span class="comment"># 修改处：训练数据路径</span></span><br><span class="line">  &#125;</span><br><span class="line">  label_map_path: <span class="string">"output/floors.pbtxt"</span> <span class="comment"># 修改处：label路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">eval_config: &#123;</span><br><span class="line">  num_examples: <span class="number">8000</span></span><br><span class="line">  <span class="comment"># <span class="doctag">Note:</span> The below line limits the evaluation process to 10 evaluations.</span></span><br><span class="line">  <span class="comment"># Remove the below line to evaluate indefinitely.</span></span><br><span class="line">  max_evals: <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">eval_input_reader: &#123;</span><br><span class="line">  tf_record_input_reader &#123;</span><br><span class="line">    input_path: <span class="string">"output/test.record"</span> <span class="comment"># 修改处：测试数据路径</span></span><br><span class="line">  &#125;</span><br><span class="line">  label_map_path: <span class="string">"output/floors.pbtxt"</span> <span class="comment"># 修改处：label路径</span></span><br><span class="line">  shuffle: false</span><br><span class="line">  num_readers: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述<code>*.config</code>文件中涉及到的label映射文件<code>floors.pbtxt</code>，可以在<code>TensorFlow/models/research/object_detection</code>中找一个文件复制出来修改即可：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">item</span> &#123;</span><br><span class="line">  <span class="attribute">name</span>: <span class="string">"floors"</span></span><br><span class="line">  id: <span class="number">1</span></span><br><span class="line">  display_name: <span class="string">"floor"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">item</span> &#123;</span><br><span class="line">  <span class="attribute">name</span>: <span class="string">"toutu"</span></span><br><span class="line">  id: <span class="number">2</span></span><br><span class="line">  display_name: <span class="string">"toutu"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h2><p>将<a href="https://github.com/tensorflow/models仓库克隆到本地，以其为模型训练的环境。以下步骤为一些环境配置，如清楚可直接跳过，参照https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/installation.md。" target="_blank" rel="noopener">https://github.com/tensorflow/models仓库克隆到本地，以其为模型训练的环境。以下步骤为一些环境配置，如清楚可直接跳过，参照https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/installation.md。</a>              </p>
<ol>
<li>将<code>models/research/object_detection/legacy/train.py</code>复制到工作目录下。     </li>
<li>安装<code>slim</code>模块，借用models的环境，在<code>models/research/slim</code>目录下运行<code>python setup.py install</code>。      </li>
<li>将slim库暴露到运行环境中<code>export PYTHONPATH=$PYTHONPATH:pwd:pwd/slim</code>。     </li>
<li>Protobuf编译，在<code>models/research</code>目录下执行<code>protoc object_detection/protos/*.proto --python_out=.</code>。    </li>
</ol>
<p>执行命令行如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python train.py --logtostderr <span class="attribute">--train_dir</span>=training/ <span class="attribute">--pipeline_config_path</span>=training/ssd_mobilenet_v1_coco.config</span><br></pre></td></tr></table></figure></p>
<p><img src="https://img11.360buyimg.com/imagetools/jfs/t1/89793/3/11342/343407/5e33bcc7Ecbebbd38/a67ee67634ca3ed2.jpg" alt="训练ing"><br>如果没有报错，可以看到以上输出，慢慢等待模型训练结果即可。<br>可以通过以下命令看到优化的情况：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tensorboard --logdir=training</span><br></pre></td></tr></table></figure></p>
<h2 id="模型效果展示"><a href="#模型效果展示" class="headerlink" title="模型效果展示"></a>模型效果展示</h2><h3 id="python模型导出"><a href="#python模型导出" class="headerlink" title="python模型导出"></a>python模型导出</h3><p>通过python测试模型效果不错，将模型导出为tensorflowjs可运行模式，将训练完成的模型导出，TensorFlow Object Detection API提供了一个export_inference_ graph.py脚本用于导出训练好的模型（位于models/research/object_detection目录下）。执行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python export_inference_graph.py --input_type image_tensor --pipeline_config_path training/ssd_mobilenet_v1_coco.config --trained_checkpoint_prefix training/model.ckpt-200000 --output_directory floors_inference_graph</span><br></pre></td></tr></table></figure></p>
<p><img src="https://img13.360buyimg.com/imagetools/s241x170_jfs/t1/89499/2/11712/41421/5e3ab6e8E9c448f04/f7cf26d08ea4e292.png" alt></p>
<h3 id="将导出模型转换为TensorFlow-js可运行模型"><a href="#将导出模型转换为TensorFlow-js可运行模型" class="headerlink" title="将导出模型转换为TensorFlow.js可运行模型"></a>将导出模型转换为TensorFlow.js可运行模型</h3><p>将模型转换为TensorFlow.js可用的web格式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型转换器安装</span></span><br><span class="line">pip install tensorflowjs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行转换器提供的转换脚本，以下命令任选一</span></span><br><span class="line"><span class="comment"># 参考：https://github.com/tensorflow/tfjs-converter/tree/master/tfjs-converter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># covert from saved_model</span></span><br><span class="line">tensorflowjs_converter --input_format=tf_saved_model --output_format=tfjs_graph_model --signature_name=serving_default --saved_model_tags=serve ./saved_model ./web_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># convert from frozen_model</span></span><br><span class="line">tensorflowjs_converter --input_format=tf_frozen_model --output_node_names=<span class="string">'num_detections,detection_boxes,detection_scores,detection_classes'</span> ./frozen_inference_graph.pb  ./web_model</span><br></pre></td></tr></table></figure></p>
<p>得到如下的TensorFlow.js可运行模型数据。<br><img src="https://img13.360buyimg.com/imagetools/s210x170_jfs/t1/95639/32/11688/89905/5e3ab5e5E31a1f5ec/b8a8a16eeaf76b8e.jpg" alt="web model">   </p>
<h3 id="前端运行模型"><a href="#前端运行模型" class="headerlink" title="前端运行模型"></a>前端运行模型</h3><p>此处只给出关键代码，需要注意的点是，输出数据维度名称与<code>export_inference_graph.py</code>中相对应。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入本地模型</span></span><br><span class="line">model = <span class="keyword">await</span> tf.loadGraphModel(<span class="string">'./web_model/model.json'</span>);</span><br><span class="line"><span class="comment">// 模型输入处理</span></span><br><span class="line"><span class="keyword">let</span> image = tf.browser.fromPixels(canvas);</span><br><span class="line"><span class="keyword">const</span> t4d = image.expandDims(<span class="number">0</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  获取所需的输出维度</span></span><br><span class="line"><span class="comment">   * num_detections: 检测总数</span></span><br><span class="line"><span class="comment">   * detection_boxes: 检测框张量，[ymin , xmin , ymax , xmax]为归一化数据，对应图片检测框位置只需乘以对应宽高</span></span><br><span class="line"><span class="comment">   * detection_scores: 检测框分数，即概率</span></span><br><span class="line"><span class="comment">   * detection_classes: 类别ID，与label_map中相对应</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="keyword">let</span> tensor = <span class="keyword">await</span> model.executeAsync(&#123;<span class="string">'image_tensor'</span>: t4d&#125;, <span class="string">`<span class="subst">$&#123;dim&#125;</span>:0`</span>);</span><br><span class="line">modelOut[dim] = <span class="keyword">await</span> tensor.data();</span><br></pre></td></tr></table></figure></p>
<h2 id="发散思考与深入"><a href="#发散思考与深入" class="headerlink" title="发散思考与深入"></a>发散思考与深入</h2><ul>
<li>训练结果有一定<strong>随机性</strong>，增加少量数据不一定会越来越精准，所以模型的训练需要一定时间的数据集积累，才能得到较好结果；由于数据集限制，对于规整的设计稿识别效果显然更好。    </li>
<li>需要测试图片颜色对识别效果的影响，后续可能需要加入<strong>交互稿的识别</strong>；对于<strong>多种类型的设计稿</strong>进行匹配，目前仅仅测试了会场类型；对于某些特殊、有显著特征的楼层类型可以进行<strong>更细致分类的识别</strong>，比如头图、优惠券等。   </li>
<li>使用python训练的模型不一定能转换为tensorflowjs可运行模型，建议<strong>在哪个环境使用，就在哪个环境训练模型</strong>。不同的TensorFlow版本训练出的模型效果可能有很大差别，不能盲目使用新版本，容易出现未知bug无法解决。            </li>
<li>楼层分割这个需求应用比较局限且比较困难。<br>楼层是一个复合结构，一个楼层可能有多个组件结合嵌套组成，情况较为复杂。组件维度的分割是更加有价值且合理的分割行为，且组件分割的应用也会更加广泛，例如在设计稿中识别某个组件及其类型，并与沉淀代码库进行匹配。近几年的一些设计图直接生成代码也采用类似的思路，比如微软的sketch2code，淘宝的imgcook。      </li>
</ul>
<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><ol>
<li><code>ModuleNotFoundError: No module named &#39;nets&#39;</code><br>需要安装slim模块，如果借用<code>tensorflow/models</code>环境，则在<code>models/research/slim</code>目录下运行<code>python setup.py install</code>。另外需要将该模块暴露到环境中<code>export PYTHONPATH=$PYTHONPATH:pwd:pwd/slim</code>。其中pwd表示的是当前克隆目录，即research文件所在。            </li>
<li><code>ImportError: cannot import name &#39;preprocessor_pb2&#39; from &#39;object_detection.protos&#39;</code><br>需要<code>protoc object_detection/protos/*.proto --python_out=.</code>，参考<a href="https://github.com/tensorflow/models/issues/2930" target="_blank" rel="noopener">issue2930</a></li>
<li><code>ValueError: Unsupported Ops in the model before optimization LogSoftmax NonMaxSuppressionV5</code><br>python训练得到的模型不能百分百转换到tensorflowjs下运行，参考<a href="https://github.com/tensorflow/tfjs/issues/684" target="_blank" rel="noopener">issue684</a>建议加入参数<code>--skip_op_check</code>，可以转化成功但是生成的模型有问题。<br>tensorflowjs有许多操作不支持，幸好刚刚更新的版本加入了NonMaxSuppressionV5支持，升级到1.5.2版本搞定。    </li>
<li>python安装tensorflowjs最新版本失败<br>python版本过高的问题，官方建议版本为3.6.8。    </li>
<li>导出saved model的variables为空<br>参考<a href="https://github.com/tensorflow/models/issues/1988" target="_blank" rel="noopener">issue1988</a>，修改<code>export.py</code>中<code>write_saved_model</code>函数。   </li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/training.html" target="_blank" rel="noopener">[1] Training Custom Object Detector</a><br><a href="https://zhuanlan.zhihu.com/p/35854575" target="_blank" rel="noopener">[2] 目标检测Tensorflow object detection API之构建自己的模型</a><br><a href="https://tensorflow.google.cn/guide" target="_blank" rel="noopener">[3] Tensorflow Guide</a>   </p>
</div><div class="tags"><a href="/tags/AI/">AI</a><a href="/tags/tensorflow/">tensorflow</a></div><div class="post-nav"><a class="pre" href="/2020/02/26/函数劫持/">函数劫持</a><a class="next" href="/2019/12/23/Vue组件库之Popup弹窗组件/">vue组件库之popup弹窗组件</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/notes/">notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue组件/">vue组件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/周报/">周报</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/复盘/">复盘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/深入学习/">深入学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/threejs/" style="font-size: 15px;">threejs</a> <a href="/tags/小项目/" style="font-size: 15px;">小项目</a> <a href="/tags/数据分析工具项目/" style="font-size: 15px;">数据分析工具项目</a> <a href="/tags/项目复盘/" style="font-size: 15px;">项目复盘</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/记录/" style="font-size: 15px;">记录</a> <a href="/tags/概念/" style="font-size: 15px;">概念</a> <a href="/tags/周报/" style="font-size: 15px;">周报</a> <a href="/tags/组件沉淀/" style="font-size: 15px;">组件沉淀</a> <a href="/tags/phaser/" style="font-size: 15px;">phaser</a> <a href="/tags/sass/" style="font-size: 15px;">sass</a> <a href="/tags/compass/" style="font-size: 15px;">compass</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/性能优化/" style="font-size: 15px;">性能优化</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/02/26/函数劫持/">函数劫持</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/06/初识AI之设计稿楼层识别/">初识AI之设计稿楼层识别</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/23/Vue组件库之Popup弹窗组件/">vue组件库之popup弹窗组件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/19/算法应用之自定义公式计算/">算法应用之自定义公式计算</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/05/记录之MAC环境下一次重新安装nvm和nrm/">记录之MAC环境下一次重新安装nvm和nrm</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/05/记录第一次typescript重构后端/">记录第一次typescript重构后端</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/27/赶鸭子上架的全栈开发踩坑思考/">赶鸭子上架的全栈开发踩坑思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/25/phaser2->3：来个打地鼠试水/">phaser2->3：来个打地鼠试水</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/优化动画卡顿：卡顿原因分析及优化方案/">优化动画卡顿：卡顿原因分析及优化方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/08/两周一报14（20190308）/">两周一报14（20190308）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Winnie Cai's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>